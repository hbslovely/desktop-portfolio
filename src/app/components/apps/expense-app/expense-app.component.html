<div class="expense-app">
  <!-- Authentication Screen -->
  <div class="auth-screen" *ngIf="!isAuthenticated()">
    <div class="auth-container">
      <div class="auth-header">
        <div class="auth-icon-wrapper">
          <div class="auth-icon">
            <i class="fas fa-wallet"></i>
          </div>
        </div>
        <h2>Quản lý Chi tiêu</h2>
        <p class="auth-hint">Đăng nhập để truy cập ứng dụng</p>
      </div>

      <div class="auth-form">
        <div class="input-group">
          <div class="input-wrapper">
            <div class="input-icon">
              <i class="fas fa-user"></i>
            </div>
            <input
              type="text"
              class="auth-input"
              [class.error]="passwordError()"
              [value]="username()"
              (input)="username.set($any($event.target).value)"
              (keydown)="onInputKeyDown($event)"
              placeholder="Tên đăng nhập"
              autofocus
              autocomplete="username">
          </div>
        </div>

        <div class="input-group">
          <div class="input-wrapper">
            <div class="input-icon">
              <i class="fas fa-lock"></i>
            </div>
            <input
              type="password"
              class="auth-input"
              [class.error]="passwordError()"
              [value]="password()"
              (input)="password.set($any($event.target).value)"
              (keydown)="onInputKeyDown($event)"
              (blur)="onPasswordBlur($event)"
              placeholder="Mật khẩu"
              autocomplete="current-password">
          </div>
        </div>

        <button class="login-btn" (click)="authenticate()">
          <i class="fas fa-sign-in-alt"></i>
          <span>Đăng nhập</span>
        </button>

        <div class="password-error" *ngIf="passwordError()">
          <i class="fas fa-exclamation-circle"></i>
          <span>{{ passwordError() }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App Screen -->
  <div class="main-screen" *ngIf="isAuthenticated()">
    <!-- Header -->
    <div class="app-header">
      <div class="header-left">
        <i class="fas fa-wallet"></i>
        <h1>Quản lý Chi tiêu</h1>
      </div>
      <div class="header-right">
        <button (click)="showAddExpenseForm()" class="add-expense-header-btn">
          <i class="fas fa-plus"></i>
          <span>Thêm chi tiêu mới</span>
        </button>
        <button (click)="showAddGroupForm()" class="add-group-header-btn">
          <i class="fas fa-layer-group"></i>
          <span>Thêm nhóm</span>
        </button>
        <button
          class="screen-toggle-header-btn"
          (click)="switchScreen(currentScreen() === 'transactions' ? 'insights' : 'transactions')"
          [title]="currentScreen() === 'transactions' ? 'Xem phân tích' : 'Xem giao dịch'">
          <i class="fas" [ngClass]="currentScreen() === 'transactions' ? 'fa-chart-pie' : 'fa-list'"></i>
          <span>{{ currentScreen() === 'transactions' ? 'Xem phân tích' : 'Xem giao dịch' }}</span>
        </button>
        <button (click)="showMetricDialog.set(true)" class="metric-header-btn" title="Xem số liệu"
                *ngIf="currentLayout() === 'v2'">
          <i class="fas fa-chart-line"></i>
          <span>Xem số liệu</span>
        </button>
        <button (click)="showFilterDialog.set(true)" class="filter-header-btn" title="Bộ lọc"
                *ngIf="currentLayout() === 'v2'">
          <i class="fas fa-filter"></i>
          <span class="filter-badge" *ngIf="getActiveFilterCount() > 0">{{ getActiveFilterCount() }}</span>
        </button>
        <button (click)="loadExpenses()" class="refresh-header-btn" [class.loading]="isLoading()" title="Làm mới dữ liệu">
          <i class="fas fa-sync-alt" [class.fa-spin]="isLoading()"></i>
          <span>Làm mới</span>
        </button>
      </div>
    </div>


    <!-- Month Picker Filter - Only for Insights Screen -->
    <div class="insights-month-picker" *ngIf="currentScreen() === 'insights'">
      <div class="month-picker-container">
        <button class="month-nav-btn" (click)="navigateReportPeriod('prev')">
          <i class="pi pi-chevron-left"></i>
        </button>
        <div class="month-display">
          <span class="month-label">{{ getReportPeriodLabel() }}</span>
        </div>
        <button class="month-nav-btn" (click)="navigateReportPeriod('next')">
          <i class="pi pi-chevron-right"></i>
        </button>
        <div class="month-quick-actions">
          <button class="quick-month-btn" [class.active]="isThisMonthReport()" (click)="setReportPeriod('thisMonth')">
            <span>Tháng này</span>
          </button>
          <button class="quick-month-btn" [class.active]="isLastMonthReport()" (click)="setReportPeriod('lastMonth')">
            <span>Tháng trước</span>
          </button>
          <button class="quick-month-btn" (click)="toggleReportMode()">
            <i class="pi" [class.pi-calendar]="reportMonth() !== null"
               [class.pi-calendar-times]="reportMonth() === null"></i>
            <span>{{ reportMonth() === null ? 'Xem theo tháng' : 'Xem cả năm' }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ========== TRANSACTIONS SCREEN ========== -->
    <!-- Main Content Layout with Sidebar -->
    <div class="main-layout-v3" *ngIf="currentScreen() === 'transactions'">
      <!-- Left Sidebar - WebStorm Style Multi-Panel -->
      <div class="sidebar-container-webstorm" [class.collapsed]="sidebarPanelsCollapsed()">
        <!-- Icon Bar (Left) -->
        <div class="sidebar-icon-bar">
          <button class="sidebar-icon-btn"
                  [class.active]="activeSidebarPanel() === 'filters' && !sidebarPanelsCollapsed()"
                  (click)="toggleSidebarPanel('filters')"
                  title="Bộ lọc">
            <i class="fas fa-filter"></i>
          </button>
          <button class="sidebar-icon-btn"
                  [class.active]="activeSidebarPanel() === 'dates' && !sidebarPanelsCollapsed()"
                  (click)="toggleSidebarPanel('dates')"
                  title="Chọn ngày">
            <i class="fas fa-calendar-alt"></i>
          </button>
          <button class="sidebar-icon-btn"
                  [class.active]="activeSidebarPanel() === 'categories' && !sidebarPanelsCollapsed()"
                  (click)="toggleSidebarPanel('categories')"
                  title="Danh mục">
            <i class="fas fa-tags"></i>
          </button>
          <button class="sidebar-icon-btn"
                  [class.active]="activeSidebarPanel() === 'statistics' && !sidebarPanelsCollapsed()"
                  (click)="toggleSidebarPanel('statistics')"
                  title="Thống kê">
            <i class="fas fa-chart-bar"></i>
          </button>
          <div class="sidebar-divider"></div>
          <button class="sidebar-icon-btn collapse-all-btn"
                  (click)="sidebarPanelsCollapsed.set(!sidebarPanelsCollapsed())"
                  [title]="sidebarPanelsCollapsed() ? 'Mở sidebar' : 'Thu gọn sidebar'">
            <i class="fas" [ngClass]="sidebarPanelsCollapsed() ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
          </button>
        </div>

        <!-- Panel Content (Right) -->
        <div class="sidebar-panel-content" *ngIf="!sidebarPanelsCollapsed()">
          <!-- Filters Panel -->
          <div class="sidebar-panel" *ngIf="activeSidebarPanel() === 'filters'">
            <div class="panel-header-webstorm">
              <div class="panel-title">
                <i class="fas fa-filter"></i>
                <span>Bộ lọc</span>
              </div>
              <button class="panel-close-btn" (click)="sidebarPanelsCollapsed.set(true)" title="Đóng">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="panel-body-webstorm">
              <button class="clear-all-btn-webstorm" (click)="clearFilters()"
                      *ngIf="filterCategory().length > 0 || searchText() || filterAmountMin() !== null || filterAmountMax() !== null || filterDateFrom() || filterDateTo() || showHighAmountOnly() || showRecentOnly() || showWithNoteOnly()">
                <i class="fas fa-times"></i>
                <span>Xóa tất cả bộ lọc</span>
              </button>

              <!-- Advanced Search -->
          <div class="filter-block-flat">
            <div class="filter-block-header">
              <i class="fas fa-search"></i>
              <span>Tìm kiếm nâng cao</span>
            </div>
            <div class="search-input-wrapper-flat">
              <input type="text"
                     [ngModel]="searchText()"
                     (ngModelChange)="onSearchTextChange($event)"
                     (focus)="onSearchFocus()"
                     (blur)="onSearchBlur()"
                     placeholder="Tìm kiếm (dùng dấu phẩy để tìm nhiều từ)..."
                     class="search-input-flat">
              <button *ngIf="searchText()" (click)="searchText.set(''); searchKeywords.set([])" class="clear-input-btn-flat">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <!-- Search Suggestions -->
            <div class="search-suggestions-flat" *ngIf="showSearchSuggestions() && searchText().length >= 2">
              <div class="suggestions-header">
                <i class="fas fa-lightbulb"></i>
                <span>Gợi ý</span>
              </div>
              <div class="suggestions-list">
                <button *ngFor="let suggestion of getSearchSuggestions(searchText())"
                        class="suggestion-item"
                        (click)="searchText.set(suggestion); addToRecentSearches(suggestion); showSearchSuggestions.set(false)">
                  <i class="fas fa-search"></i>
                  <span>{{ suggestion }}</span>
                </button>
              </div>
            </div>

            <!-- Recent Searches -->
            <div class="recent-searches-flat" *ngIf="recentSearches().length > 0 && !searchText()">
              <div class="recent-header">
                <i class="fas fa-history"></i>
                <span>Tìm kiếm gần đây</span>
                <button (click)="recentSearches.set([])" class="clear-recent-btn">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              <div class="recent-list">
                <button *ngFor="let recent of recentSearches()"
                        class="recent-item"
                        (click)="searchText.set(recent); addToRecentSearches(recent)">
                  <i class="fas fa-clock"></i>
                  <span>{{ recent }}</span>
                </button>
              </div>
            </div>

            <!-- Search Options -->
            <div class="search-options-flat" *ngIf="searchText()">
              <div class="search-mode-selector">
                <label class="search-mode-label">Chế độ:</label>
                <select [ngModel]="searchMode()" (ngModelChange)="searchMode.set($event)" class="search-mode-select">
                  <option value="contains">Chứa</option>
                  <option value="starts">Bắt đầu</option>
                  <option value="ends">Kết thúc</option>
                  <option value="exact">Chính xác</option>
                  <option value="regex">Biểu thức chính quy</option>
                </select>
              </div>
              <label class="search-option-checkbox">
                <input type="checkbox" [ngModel]="searchInNote()" (ngModelChange)="searchInNote.set($event)">
                <span>Tìm trong ghi chú</span>
              </label>
              <div class="search-hint" *ngIf="searchKeywords().length > 1">
                <i class="fas fa-info-circle"></i>
                <span>Tìm {{ searchKeywords().length }} từ khóa (tất cả phải khớp)</span>
              </div>
            </div>
          </div>

          <!-- Quick Filters -->
          <div class="filter-block-flat">
            <div class="filter-block-header">
              <i class="fas fa-bolt"></i>
              <span>Lọc nhanh</span>
            </div>
            <div class="quick-filters-flat">
              <button class="quick-filter-btn" [class.active]="showAboveAverageOnly()"
                      (click)="showAboveAverageOnly.set(!showAboveAverageOnly()); showBelowAverageOnly.set(false)">
                <i class="fas fa-arrow-up"></i>
                <span>Trên trung bình</span>
              </button>
              <button class="quick-filter-btn" [class.active]="showBelowAverageOnly()"
                      (click)="showBelowAverageOnly.set(!showBelowAverageOnly()); showAboveAverageOnly.set(false)">
                <i class="fas fa-arrow-down"></i>
                <span>Dưới trung bình</span>
              </button>
              <button class="quick-filter-btn" [class.active]="showRecentOnly()"
                      (click)="showRecentOnly.set(!showRecentOnly())">
                <i class="fas fa-clock"></i>
                <span>7 ngày gần đây</span>
              </button>
              <button class="quick-filter-btn" [class.active]="showWithNoteOnly()"
                      (click)="showWithNoteOnly.set(!showWithNoteOnly()); showWithoutNoteOnly.set(false)">
                <i class="fas fa-sticky-note"></i>
                <span>Có ghi chú</span>
              </button>
              <button class="quick-filter-btn" [class.active]="showWithoutNoteOnly()"
                      (click)="showWithoutNoteOnly.set(!showWithoutNoteOnly()); showWithNoteOnly.set(false)">
                <i class="fas fa-file-alt"></i>
                <span>Không có ghi chú</span>
              </button>
            </div>
          </div>

          <!-- Quick Date Filters -->
          <div class="filter-block-flat">
            <div class="filter-block-header">
              <i class="fas fa-calendar"></i>
              <span>Thời gian</span>
            </div>
            <div class="date-chips-flat">
              <button class="date-chip-flat" [class.active]="isTodayActive()" (click)="filterToday()">
                Hôm nay
              </button>
              <button class="date-chip-flat" [class.active]="isYesterdayActive()" (click)="filterYesterday()">
                Hôm qua
              </button>
              <button class="date-chip-flat" [class.active]="isLast7DaysActive()" (click)="filterLast7Days()">
                7 ngày
              </button>
              <button class="date-chip-flat" [class.active]="isLast30DaysActive()" (click)="filterLast30Days()">
                30 ngày
              </button>
              <button class="date-chip-flat" [class.active]="isCurrentMonthActive()" (click)="filterCurrentMonth()">
                Tháng này
              </button>
              <button class="date-chip-flat custom" (click)="showCustomDateRangeDialog()">
                <i class="fas fa-sliders-h"></i> Tùy chỉnh
              </button>
            </div>
            <div class="date-range-info-flat" *ngIf="filterDateFrom() || filterDateTo()">
              <i class="fas fa-calendar-check"></i>
              <span *ngIf="filterDateFrom() && filterDateTo()">{{ formatDate(filterDateFrom()) }} - {{ formatDate(filterDateTo()) }}</span>
              <span *ngIf="filterDateFrom() && !filterDateTo()">Từ {{ formatDate(filterDateFrom()) }}</span>
              <span *ngIf="!filterDateFrom() && filterDateTo()">Đến {{ formatDate(filterDateTo()) }}</span>
              <button (click)="filterDateFrom.set(''); filterDateTo.set('')" class="clear-date-inline-flat">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>

          <!-- Categories -->
          <div class="filter-block-flat">
            <div class="filter-block-header">
              <i class="fas fa-tag"></i>
              <span>Danh mục</span>
            </div>
            <div class="category-search-wrapper">
              <input type="text"
                     [ngModel]="categorySearchText()"
                     (ngModelChange)="categorySearchText.set($event)"
                     placeholder="Tìm danh mục..."
                     class="category-search-input">
            </div>
            <div class="category-filter-checkboxes-flat">
              <label class="category-checkbox-item-flat all-categories-flat">
                <input type="checkbox"
                       [checked]="filterCategory().length === 0"
                       (change)="filterCategory.set([])">
                <span class="checkbox-label-flat">Tất cả</span>
              </label>
              <div class="category-checkbox-list-flat">
                <label *ngFor="let cat of filteredCategories()"
                       class="category-checkbox-item-flat"
                       [style.--cat-color]="getCategoryColor(cat)"
                       [style.--cat-bg]="getCategoryBgColor(cat)">
                  <input type="checkbox"
                         [checked]="isCategorySelected(cat)"
                         (change)="toggleCategory(cat)">
                  <i class="fas" [ngClass]="getCategoryIcon(cat)"></i>
                  <span class="checkbox-label-flat">{{ cat }}</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Amount Range -->
          <div class="filter-block-flat">
            <div class="filter-block-header">
              <i class="fas fa-wallet"></i>
              <span>Số tiền</span>
            </div>
            <div class="amount-range-flat">
              <input type="number" [ngModel]="filterAmountMin()"
                     (ngModelChange)="filterAmountMin.set($event ? Number($event) : null)"
                     placeholder="Từ" class="amount-input-flat">
              <span class="range-separator-flat">—</span>
              <input type="number" [ngModel]="filterAmountMax()"
                     (ngModelChange)="filterAmountMax.set($event ? Number($event) : null)"
                     placeholder="Đến" class="amount-input-flat">
            </div>
            <div class="amount-presets-flat">
              <button class="amount-preset-btn" (click)="filterAmountMin.set(null); filterAmountMax.set(100000)">< 100K</button>
              <button class="amount-preset-btn" (click)="filterAmountMin.set(100000); filterAmountMax.set(500000)">100K-500K</button>
              <button class="amount-preset-btn" (click)="filterAmountMin.set(500000); filterAmountMax.set(null)">> 500K</button>
            </div>
          </div>

            </div>
          </div>

          <!-- Dates Panel -->
          <div class="sidebar-panel" *ngIf="activeSidebarPanel() === 'dates'">
            <div class="panel-header-webstorm">
              <div class="panel-title">
                <i class="fas fa-calendar-alt"></i>
                <span>Chọn ngày</span>
              </div>
              <button class="panel-close-btn" (click)="sidebarPanelsCollapsed.set(true)" title="Đóng">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="panel-body-webstorm">
              <!-- Date List -->
              <div class="date-list-panel">
                <div class="date-list-header">
                  <input type="text"
                         [ngModel]="dateSearchText()"
                         (ngModelChange)="dateSearchText.set($event)"
                         placeholder="Tìm ngày..."
                         class="date-search-input">
                </div>
                <div class="date-list-content">
                  <button *ngFor="let dateGroup of filteredUniqueDates()"
                          class="date-list-item"
                          [class.active]="isDateSelected(dateGroup.date)"
                          (click)="selectDate(dateGroup.date)">
                    <div class="date-item-main">
                      <i class="fas fa-calendar-day"></i>
                      <div class="date-item-info">
                        <span class="date-item-label">{{ formatDate(dateGroup.date) }}</span>
                        <span class="date-item-count">{{ dateGroup.count }} giao dịch</span>
                      </div>
                    </div>
                    <div class="date-item-amount">{{ formatAmount(dateGroup.total) }}</div>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Categories Panel -->
          <div class="sidebar-panel" *ngIf="activeSidebarPanel() === 'categories'">
            <div class="panel-header-webstorm">
              <div class="panel-title">
                <i class="fas fa-tags"></i>
                <span>Danh mục</span>
              </div>
              <button class="panel-close-btn" (click)="sidebarPanelsCollapsed.set(true)" title="Đóng">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="panel-body-webstorm">
              <!-- Categories content sẽ được copy từ phần categories hiện tại -->
              <div class="category-search-wrapper">
                <input type="text"
                       [ngModel]="categorySearchText()"
                       (ngModelChange)="categorySearchText.set($event)"
                       placeholder="Tìm danh mục..."
                       class="category-search-input">
              </div>
              <div class="category-filter-checkboxes-flat">
                <label class="category-checkbox-item-flat all-categories-flat">
                  <input type="checkbox"
                         [checked]="filterCategory().length === 0"
                         (change)="filterCategory.set([])">
                  <span class="checkbox-label-flat">Tất cả</span>
                </label>
                <div class="category-checkbox-list-flat">
                  <label *ngFor="let cat of filteredCategories()"
                         class="category-checkbox-item-flat"
                         [style.--cat-color]="getCategoryColor(cat)"
                         [style.--cat-bg]="getCategoryBgColor(cat)">
                    <input type="checkbox"
                           [checked]="isCategorySelected(cat)"
                           (change)="toggleCategory(cat)">
                    <i class="fas" [ngClass]="getCategoryIcon(cat)"></i>
                    <span class="checkbox-label-flat">{{ cat }}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Statistics Panel -->
          <div class="sidebar-panel" *ngIf="activeSidebarPanel() === 'statistics'">
            <div class="panel-header-webstorm">
              <div class="panel-title">
                <i class="fas fa-chart-bar"></i>
                <span>Thống kê</span>
              </div>
              <button class="panel-close-btn" (click)="sidebarPanelsCollapsed.set(true)" title="Đóng">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="panel-body-webstorm">
              <div class="stats-panel-content">
                <div class="stat-card-webstorm">
                  <div class="stat-icon-wrapper">
                    <i class="fas fa-wallet"></i>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">Tổng chi tiêu</span>
                    <span class="stat-value-large">{{ formatAmount(totalAmount()) }}</span>
                  </div>
                </div>
                <div class="stat-card-webstorm">
                  <div class="stat-icon-wrapper">
                    <i class="fas fa-list"></i>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">Số giao dịch</span>
                    <span class="stat-value-large">{{ filteredExpenses().length }}</span>
                  </div>
                </div>
                <div class="stat-card-webstorm">
                  <div class="stat-icon-wrapper">
                    <i class="fas fa-calculator"></i>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">Trung bình/giao dịch</span>
                    <span class="stat-value-large">{{ formatAmount(averageExpense()) }}</span>
                  </div>
                </div>
                <div class="stat-card-webstorm">
                  <div class="stat-icon-wrapper">
                    <i class="fas fa-arrow-up"></i>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">Chi tiêu cao nhất</span>
                    <span class="stat-value-large">{{ formatAmount(getMaxExpense()) }}</span>
                  </div>
                </div>
                <div class="stat-card-webstorm">
                  <div class="stat-icon-wrapper">
                    <i class="fas fa-arrow-down"></i>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">Chi tiêu thấp nhất</span>
                    <span class="stat-value-large">{{ formatAmount(getMinExpense()) }}</span>
                  </div>
                </div>
              </div>

              <!-- Groups Statistics Section -->
              <div class="groups-stats-section" *ngIf="expenseGroups().length > 0">
                <div class="section-divider">
                  <i class="fas fa-layer-group"></i>
                  <span>Thống kê nhóm chi tiêu</span>
                </div>
                
                <div class="stat-card-webstorm">
                  <div class="stat-icon-wrapper">
                    <i class="fas fa-layer-group"></i>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">Tổng số nhóm</span>
                    <span class="stat-value-large">{{ getGroupsStatistics().totalGroups }}</span>
                  </div>
                </div>
                
                <div class="stat-card-webstorm">
                  <div class="stat-icon-wrapper">
                    <i class="fas fa-wallet"></i>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">Tổng tiền các nhóm</span>
                    <span class="stat-value-large">{{ formatAmount(getGroupsStatistics().totalAmount) }}</span>
                  </div>
                </div>
                
                <div class="stat-card-webstorm">
                  <div class="stat-icon-wrapper">
                    <i class="fas fa-list"></i>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">Tổng chi tiêu trong nhóm</span>
                    <span class="stat-value-large">{{ getGroupsStatistics().totalExpenses }}</span>
                  </div>
                </div>
                
                <div class="stat-card-webstorm">
                  <div class="stat-icon-wrapper">
                    <i class="fas fa-calculator"></i>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">TB mỗi nhóm</span>
                    <span class="stat-value-large">{{ formatAmount(getGroupsStatistics().averagePerGroup) }}</span>
                  </div>
                </div>
                
                <div class="stat-card-webstorm">
                  <div class="stat-icon-wrapper">
                    <i class="fas fa-chart-line"></i>
                  </div>
                  <div class="stat-info">
                    <span class="stat-label">TB mỗi chi tiêu</span>
                    <span class="stat-value-large">{{ formatAmount(getGroupsStatistics().averagePerExpense) }}</span>
                  </div>
                </div>

                <!-- Top Groups -->
                <div class="top-groups-section" *ngIf="expenseGroups().length > 0">
                  <div class="section-subtitle">
                    <i class="fas fa-trophy"></i>
                    <span>Top nhóm chi tiêu</span>
                  </div>
                  <div class="top-groups-list">
                    <div class="top-group-item" 
                         *ngFor="let group of getTopGroups(5); let i = index">
                      <div class="group-rank">{{ i + 1 }}</div>
                      <div class="group-icon-small">
                        <i class="fas fa-layer-group"></i>
                      </div>
                      <div class="group-info-small">
                        <span class="group-name-small">{{ group.name }}</span>
                        <span class="group-meta-small">{{ getGroupExpensesCount(group) }} chi tiêu</span>
                      </div>
                      <div class="group-amount-small">{{ formatAmount(getGroupTotalAmount(group)) }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="main-content-v3">
        <!-- Tabs for Transactions Screen -->
        <div class="tabs-section-v3">
          <button
            (click)="switchTab('list')"
            class="tab-btn"
            [class.active]="activeTab() === 'list'">
            <i class="fas fa-list"></i>
            <span>Danh sách</span>
          </button>
          <button
            (click)="switchTab('summary')"
            class="tab-btn"
            [class.active]="activeTab() === 'summary'">
            <i class="fas fa-chart-bar"></i>
            <span>Thống kê</span>
          </button>
          <button
            (click)="switchTab('groups')"
            class="tab-btn"
            [class.active]="activeTab() === 'groups'">
            <i class="fas fa-layer-group"></i>
            <span>Nhóm chi tiêu</span>
          </button>
        </div>

        <!-- Tab Content: List -->
        <div class="tab-content-v3" *ngIf="activeTab() === 'list'">
          <!-- Error Message -->
          <div class="error-message" *ngIf="error()">
            <i class="fas fa-exclamation-triangle"></i>
            {{ error() }}
          </div>

          <!-- Sort & View Controls -->
          <div class="list-toolbar-v3" *ngIf="isDataReady() && filteredExpensesWithGroups().length > 0">
            <div class="toolbar-left">
              <span class="results-count">{{ filteredExpensesWithGroups().length }} kết quả</span>
            </div>
            <div class="toolbar-right">
              <div class="sort-dropdown-v3">
                <span class="sort-label">Sắp xếp:</span>
                <select class="sort-select"
                        [value]="sortOption()"
                        (change)="onSortOptionChange($any($event.target).value)">
                  @for (option of sortOptions; track option.value) {
                    <option [value]="option.value">{{ option.label }}</option>
                  }
                </select>
              </div>
            </div>
          </div>

          <!-- Expenses List -->
          <div class="expenses-list-v3" *ngIf="isDataReady() && filteredExpensesWithGroups().length > 0">
            <ng-container *ngFor="let item of filteredExpensesWithGroups(); let i = index">
              <!-- Group Row -->
              <div class="expense-group-row-flat"
                   *ngIf="isGroup(item)"
                   (click)="showGroupDetailDialog(item)">
                <div class="group-row-left">
                  <div class="group-icon-flat">
                    <i class="fas fa-layer-group"></i>
                  </div>
                  <div class="group-info-flat">
                    <div class="group-name-flat">{{ item.name }}</div>
                    <div class="group-meta-flat">
                      <span class="group-count-badge">{{ getGroupExpensesCount(item) }} chi tiêu</span>
                      <span class="group-date-flat" *ngIf="item.dateFrom && item.dateTo">
                        <i class="fas fa-calendar-alt"></i>
                        {{ formatDate(item.dateFrom) }} - {{ formatDate(item.dateTo) }}
                      </span>
                      <span class="group-date-flat" *ngIf="!item.dateFrom || !item.dateTo">
                        <i class="fas fa-calendar-alt"></i>
                        {{ formatDate(getGroupFirstExpenseDate(item)) }}
                      </span>
                    </div>
                    <div class="group-content-flat" *ngIf="item.content">{{ item.content }}</div>
                  </div>
                </div>
                <div class="group-row-right">
                  <div class="group-amount-flat">{{ formatAmount(getGroupTotalAmount(item)) }}</div>
                  <div class="group-actions-flat" (click)="$event.stopPropagation()">
                    <button class="action-btn-flat edit" (click)="showEditGroupForm(item)" title="Chỉnh sửa">
                      <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="action-btn-flat delete" (click)="deleteGroup(item)" title="Xóa">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Expense Row -->
              <div class="expense-row-v3"
                   *ngIf="!isGroup(item)"
                   [style.--row-bg]="getCategoryBgColor(item.category)"
                   [style.--row-border]="getCategoryColor(item.category)"
                   [class.highlight-above-average]="isAboveAverage(item.amount)">

                <div class="expense-icon-compact" [style.color]="getCategoryColor(item.category)">
                  <i class="fas" [ngClass]="getCategoryIcon(item.category)"></i>
                </div>

                <div class="expense-info-compact">
                  <span class="expense-content-compact">{{ item.content }}</span>
                  <span class="expense-category-compact" [style.color]="getCategoryColor(item.category)">
                    {{ item.category }}
                  </span>
                  <span class="expense-note-compact" *ngIf="item.note">
                    {{ item.note }}
                  </span>
                </div>

                <div class="expense-date-compact">
                  {{ formatDate(item.date) }}
                </div>

                <div class="expense-amount-compact" [class.high-amount]="isAboveAverage(item.amount)">
                  <i class="fas fa-exclamation-triangle warning-icon" *ngIf="isAboveAverage(item.amount)"></i>
                  {{ formatAmount(item.amount) }}
                </div>

                <div class="expense-actions-compact">
                  <button class="expense-action-btn" (click)="duplicateExpense(item)" title="Nhân đôi">
                    <i class="fas fa-copy"></i>
                  </button>
                  <button class="expense-action-btn" (click)="showEditExpenseForm(item, i)" title="Chỉnh sửa">
                    <i class="fas fa-pencil-alt"></i>
                  </button>
                </div>
              </div>
            </ng-container>
          </div>

          <!-- Empty State -->
          <div class="empty-state-v3" *ngIf="isDataReady() && filteredExpensesWithGroups().length === 0">
            <div class="empty-icon">
              <i class="fas fa-wallet"></i>
            </div>
            <h4>Chưa có chi tiêu nào</h4>
            <p>Nhấn nút "Thêm chi tiêu" để bắt đầu ghi chép</p>
            <button class="add-first-btn" (click)="showAddExpenseForm()">
              <i class="fas fa-plus"></i>
              Thêm chi tiêu đầu tiên
            </button>
          </div>

          <!-- Loading State -->
          <div class="loading-state-v3" *ngIf="isLoading() || isLoadingGroups()">
            <div class="loading-spinner">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <p>Đang tải dữ liệu...</p>
          </div>

          <!-- Right Panel Toggle Button -->
          <button class="right-panel-toggle" (click)="rightPanelOpen.set(!rightPanelOpen())"
                  [class.panel-open]="rightPanelOpen()">
            <i class="fas" [ngClass]="rightPanelOpen() ? 'fa-chevron-right' : 'fa-chart-bar'"></i>
          </button>
        </div>

        <!-- Right Info Panel -->
        <div class="right-info-panel" [class.open]="rightPanelOpen()">
          <div class="panel-header">
            <h4><i class="pi pi-chart-pie"></i> Thống kê nhanh</h4>
            <button class="close-panel-btn" (click)="rightPanelOpen.set(false)">
              <i class="pi pi-times"></i>
            </button>
          </div>

          <div class="panel-content">
            <!-- Period Stats -->
            <div class="panel-section">
              <div class="section-title">Tổng quan</div>
              <div class="stats-grid">
                <div class="stat-card primary">
                  <div class="stat-icon"><i class="pi pi-wallet"></i></div>
                  <div class="stat-info">
                    <span class="stat-value">{{ formatAmount(totalAmount()) }}</span>
                    <span class="stat-label">Tổng chi tiêu</span>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="pi pi-list"></i></div>
                  <div class="stat-info">
                    <span class="stat-value">{{ filteredExpenses().length }}</span>
                    <span class="stat-label">Giao dịch</span>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="pi pi-chart-line"></i></div>
                  <div class="stat-info">
                    <span class="stat-value">{{ formatAmount(averageExpense()) }}</span>
                    <span class="stat-label">TB/giao dịch</span>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="pi pi-calendar"></i></div>
                  <div class="stat-info">
                    <span class="stat-value">{{ formatAmount(averageDailyExpense()) }}</span>
                    <span class="stat-label">TB/ngày</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Categories -->
            <div class="panel-section">
              <div class="section-title">Top danh mục</div>
              <div class="top-categories">
                <div class="category-bar-item" *ngFor="let cat of totalByCategory().slice(0, 5); let i = index">
                  <div class="category-info">
                    <div class="category-rank">{{ i + 1 }}</div>
                    <div class="category-icon" [style.background]="getCategoryBgColor(cat.category)"
                         [style.color]="getCategoryColor(cat.category)">
                      <i class="pi" [ngClass]="getCategoryIcon(cat.category)"></i>
                    </div>
                    <div class="category-details">
                      <span class="category-name">{{ cat.category }}</span>
                      <span class="category-amount">{{ formatAmount(cat.total) }}</span>
                    </div>
                  </div>
                  <div class="category-bar">
                    <div class="bar-fill"
                         [style.width.%]="totalAmount() > 0 ? (cat.total / totalAmount()) * 100 : 0"
                         [style.background]="getCategoryColor(cat.category)"></div>
                  </div>
                  <span
                    class="category-percent">{{ totalAmount() > 0 ? ((cat.total / totalAmount()) * 100).toFixed(1) : 0 }}
                    %</span>
                </div>
              </div>
            </div>

            <!-- Spending by Day of Week -->
            <div class="panel-section">
              <div class="section-title">Chi tiêu theo thứ</div>
              <div class="weekday-chart">
                <div class="weekday-bar" *ngFor="let day of weekdaySpending()"
                     [class.highest]="day.isHighest">
                  <div class="bar-column">
                    <div class="bar-value" [style.height.%]="day.percentage"></div>
                  </div>
                  <span class="day-label">{{ day.shortName }}</span>
                  <span class="day-amount">{{ formatCompactAmount(day.average) }}</span>
                </div>
              </div>
            </div>

            <!-- Recent High Expenses -->
            <div class="panel-section">
              <div class="section-title">Chi tiêu cao nhất</div>
              <div class="high-expenses-list">
                <div class="high-expense-item" *ngFor="let expense of getTopExpenses(5)">
                  <div class="expense-dot" [style.background]="getCategoryColor(expense.category)"></div>
                  <div class="expense-content">{{ expense.content }}</div>
                  <div class="expense-amount">{{ formatAmount(expense.amount) }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Content: Groups -->
        <div class="tab-content-v3 groups-tab" *ngIf="activeTab() === 'groups'">
          <div class="groups-management-view">
            <!-- Header -->
            <div class="groups-header">
              <div class="header-left">
                <h3>
                  <i class="fas fa-layer-group"></i>
                  Quản lý nhóm chi tiêu
                </h3>
                <p class="header-subtitle">Tổ chức và quản lý các nhóm chi tiêu của bạn</p>
              </div>
              <button class="add-group-header-btn" (click)="showAddGroupForm()">
                <i class="fas fa-plus"></i>
                <span>Thêm nhóm mới</span>
              </button>
            </div>

            <!-- Loading State -->
            <div class="loading-state-v3" *ngIf="isLoadingGroups()">
              <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <p>Đang tải danh sách nhóm...</p>
            </div>

            <!-- Groups List -->
            <div class="groups-list-v3" *ngIf="!isLoadingGroups() && expenseGroups().length > 0">
              <div class="group-card-v3"
                   *ngFor="let group of expenseGroups()"
                   [class.expanded]="expandedGroupId() === group.id">
                <div class="group-card-header" (click)="toggleGroupExpanded(group.id)">
                  <div class="group-icon-wrapper">
                    <i class="fas fa-layer-group"></i>
                  </div>
                  <div class="group-info">
                    <h4 class="group-name">{{ group.name }}</h4>
                    <p class="group-content" *ngIf="group.content">{{ group.content }}</p>
                    <div class="group-meta">
                      <span class="group-id">ID: {{ group.id }}</span>
                      <span class="group-count">{{ getGroupExpensesCount(group) }} chi tiêu</span>
                    </div>
                  </div>
                  <div class="expand-icon">
                    <i class="fas" [ngClass]="expandedGroupId() === group.id ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                  </div>
                </div>
                <div class="group-card-body">
                  <!-- Main Stats Grid -->
                  <div class="group-stats-grid">
                    <div class="group-stat-card primary">
                      <div class="stat-icon">
                        <i class="fas fa-wallet"></i>
                      </div>
                      <div class="stat-content">
                        <div class="stat-label">Tổng tiền</div>
                        <div class="stat-value-large">{{ formatAmount(getGroupTotalAmount(group)) }}</div>
                      </div>
                    </div>
                    <div class="group-stat-card">
                      <div class="stat-icon">
                        <i class="fas fa-list"></i>
                      </div>
                      <div class="stat-content">
                        <div class="stat-label">Số chi tiêu</div>
                        <div class="stat-value">{{ getGroupExpensesCount(group) }}</div>
                      </div>
                    </div>
                    <div class="group-stat-card">
                      <div class="stat-icon">
                        <i class="fas fa-calculator"></i>
                      </div>
                      <div class="stat-content">
                        <div class="stat-label">Trung bình</div>
                        <div class="stat-value">{{ formatAmount(getGroupAverageExpense(group)) }}</div>
                      </div>
                    </div>
                  </div>

                  <!-- Date Range -->
                  <ng-container *ngIf="getGroupDateRange(group) as dateRange">
                    <div class="group-date-info" *ngIf="dateRange || (group.dateFrom && group.dateTo)">
                      <div class="date-range-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="date-label">Từ:</span>
                        <span class="date-value">{{ formatDate(group.dateFrom || dateRange?.from || '') }}</span>
                      </div>
                      <div class="date-range-item">
                        <i class="fas fa-calendar-check"></i>
                        <span class="date-label">Đến:</span>
                        <span class="date-value">{{ formatDate(group.dateTo || dateRange?.to || '') }}</span>
                      </div>
                      <div class="date-range-item" *ngIf="group.createdAt">
                        <i class="fas fa-clock"></i>
                        <span class="date-label">Tạo:</span>
                        <span class="date-value">{{ formatDate(group.createdAt) }}</span>
                      </div>
                    </div>
                  </ng-container>

                  <!-- Min/Max Expenses -->
                  <div class="group-extremes" *ngIf="getGroupMaxExpense(group) && getGroupMinExpense(group)">
                    <div class="extreme-item max">
                      <i class="fas fa-arrow-up"></i>
                      <div class="extreme-content">
                        <span class="extreme-label">Cao nhất</span>
                        <span class="extreme-value">{{ formatAmount(getGroupMaxExpense(group)!.amount) }}</span>
                        <span class="extreme-detail">{{ getGroupMaxExpense(group)!.content }}</span>
                      </div>
                    </div>
                    <div class="extreme-item min">
                      <i class="fas fa-arrow-down"></i>
                      <div class="extreme-content">
                        <span class="extreme-label">Thấp nhất</span>
                        <span class="extreme-value">{{ formatAmount(getGroupMinExpense(group)!.amount) }}</span>
                        <span class="extreme-detail">{{ getGroupMinExpense(group)!.content }}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Top Categories -->
                  <div class="group-top-categories" *ngIf="getGroupTopCategories(group, 3).length > 0">
                    <div class="top-categories-header">
                      <i class="fas fa-tags"></i>
                      <span>Top danh mục</span>
                    </div>
                    <div class="top-categories-list">
                      <div class="category-item" 
                           *ngFor="let cat of getGroupTopCategories(group, 3); let i = index"
                           [style.--cat-color]="getCategoryColor(cat.category)"
                           [style.--cat-bg]="getCategoryBgColor(cat.category)">
                        <div class="category-rank">{{ i + 1 }}</div>
                        <div class="category-icon">
                          <i class="fas" [ngClass]="getCategoryIcon(cat.category)"></i>
                        </div>
                        <div class="category-info">
                          <span class="category-name">{{ cat.category }}</span>
                          <span class="category-stats">{{ cat.count }} chi tiêu • {{ formatAmount(cat.total) }}</span>
                        </div>
                        <div class="category-percent">
                          {{ getGroupTotalAmount(group) > 0 ? ((cat.total / getGroupTotalAmount(group)) * 100).toFixed(0) : 0 }}%
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="group-card-actions" (click)="$event.stopPropagation()">
                  <button class="action-btn edit-btn" (click)="showEditGroupForm(group)" title="Chỉnh sửa">
                    <i class="fas fa-pencil-alt"></i>
                  </button>
                  <button class="action-btn delete-btn" (click)="deleteGroup(group)" title="Xóa">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                <!-- Expanded Expenses List -->
                <div class="group-expenses-list" *ngIf="expandedGroupId() === group.id">
                  <div class="expenses-list-header">
                    <h5>
                      <i class="fas fa-list"></i>
                      Danh sách chi tiêu ({{ getGroupExpensesCount(group) }})
                    </h5>
                  </div>
                  <div class="expenses-list-content">
                    <div class="expense-item-inline"
                         *ngFor="let expense of (expensesByGroup()[group.id] || []); let i = index"
                         [style.--cat-color]="getCategoryColor(expense.category)"
                         [style.--cat-bg]="getCategoryBgColor(expense.category)">
                      <div class="expense-icon-inline">
                        <i class="fas" [ngClass]="getCategoryIcon(expense.category)"></i>
                      </div>
                      <div class="expense-info-inline">
                        <div class="expense-content-inline">{{ expense.content }}</div>
                        <div class="expense-meta-inline">
                          <span class="expense-category-inline">{{ expense.category }}</span>
                          <span class="expense-date-inline">{{ formatDate(expense.date) }}</span>
                          <span class="expense-note-inline" *ngIf="expense.note">
                            <i class="fas fa-comment"></i> {{ expense.note }}
                          </span>
                        </div>
                      </div>
                      <div class="expense-amount-inline">{{ formatAmount(expense.amount) }}</div>
                    </div>
                    <div class="empty-expenses" *ngIf="getGroupExpensesCount(group) === 0">
                      <i class="fas fa-inbox"></i>
                      <span>Chưa có chi tiêu nào trong nhóm này</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state-v3" *ngIf="!isLoadingGroups() && expenseGroups().length === 0">
              <div class="empty-icon">
                <i class="fas fa-layer-group"></i>
              </div>
              <h4>Chưa có nhóm chi tiêu nào</h4>
              <p>Tạo nhóm chi tiêu để tổ chức các khoản chi tiêu liên quan với nhau</p>
              <button class="add-first-btn" (click)="showAddGroupForm()">
                <i class="fas fa-plus"></i>
                <span>Tạo nhóm đầu tiên</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Tab Content: Summary -->
        <div class="tab-content-v3 summary-tab" *ngIf="activeTab() === 'summary'">
          <div class="summary-view">
            <!-- Overall Summary - Compact -->
            <div class="summary-section compact">
              <div class="summary-card">
                <div class="summary-icon">
                  <i class="pi pi-money-bill"></i>
                </div>
                <div class="summary-content">
                  <div class="summary-label">Tổng chi tiêu</div>
                  <div class="summary-value">{{ formatAmount(totalAmount()) }}</div>
                  <div class="summary-change" *ngIf="periodComparison()">
                    <i class="pi" [class.pi-arrow-up]="periodComparison()!.change > 0"
                       [class.pi-arrow-down]="periodComparison()!.change < 0"
                       [class.pi-minus]="periodComparison()!.change === 0"></i>
                    <span [class.positive]="periodComparison()!.change > 0"
                          [class.negative]="periodComparison()!.change < 0">
                  {{ Math.abs(periodComparison()!.change) }}%
                </span>
                    <span class="change-label">vs {{ periodComparison()!.period }} trước</span>
                  </div>
                </div>
              </div>
              <div class="summary-card">
                <div class="summary-icon">
                  <i class="pi pi-list"></i>
                </div>
                <div class="summary-content">
                  <div class="summary-label">Số giao dịch</div>
                  <div class="summary-value">{{ filteredExpenses().length }}</div>
                </div>
              </div>
              <div class="summary-card">
                <div class="summary-icon">
                  <i class="pi pi-calendar"></i>
                </div>
                <div class="summary-content">
                  <div class="summary-label">TB/ngày</div>
                  <div class="summary-value">{{ formatAmount(averageDailyExpense()) }}</div>
                </div>
              </div>
              <div class="summary-card">
                <div class="summary-icon">
                  <i class="pi pi-chart-line"></i>
                </div>
                <div class="summary-content">
                  <div class="summary-label">TB/giao dịch</div>
                  <div class="summary-value">{{ formatAmount(averageExpense()) }}</div>
                </div>
              </div>
              <div class="summary-card" *ngIf="yesterdayComparison().hasData">
                <div class="summary-icon">
                  <i class="pi pi-calendar-minus"></i>
                </div>
                <div class="summary-content">
                  <div class="summary-label">So với hôm qua</div>
                  <div class="summary-value"
                       [class.positive]="yesterdayComparison().status === 'lower'"
                       [class.negative]="yesterdayComparison().status === 'higher'">
                    <i class="pi"
                       [class.pi-arrow-up]="yesterdayComparison().status === 'higher'"
                       [class.pi-arrow-down]="yesterdayComparison().status === 'lower'"
                       [class.pi-minus]="yesterdayComparison().status === 'equal'"></i>
                    {{ yesterdayComparison().changePercent }}%
                  </div>
                  <div class="summary-change">
                    <span
                      *ngIf="yesterdayComparison().status === 'higher'">Cao hơn {{ formatAmount(Math.abs(yesterdayComparison().change)) }}</span>
                    <span
                      *ngIf="yesterdayComparison().status === 'lower'">Thấp hơn {{ formatAmount(Math.abs(yesterdayComparison().change)) }}</span>
                    <span *ngIf="yesterdayComparison().status === 'equal'">Bằng nhau</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Today's Expense Evaluation -->
            <div class="today-evaluation-section" *ngIf="!isLoading() && todayExpenseEvaluation().hasData">
              <div class="evaluation-header">
                <div class="header-left">
                  <i class="pi pi-calendar-check"></i>
                  <h3>Đánh giá chi tiêu hôm nay</h3>
                </div>
                <div class="evaluation-status"
                     [class.status-high]="todayExpenseEvaluation().overallStatus === 'high'"
                     [class.status-low]="todayExpenseEvaluation().overallStatus === 'low'"
                     [class.status-normal]="todayExpenseEvaluation().overallStatus === 'normal'">
                  <i class="pi"
                     [class.pi-arrow-up]="todayExpenseEvaluation().overallStatus === 'high'"
                     [class.pi-arrow-down]="todayExpenseEvaluation().overallStatus === 'low'"
                     [class.pi-minus]="todayExpenseEvaluation().overallStatus === 'normal'"></i>
                  <span>{{ todayExpenseEvaluation().overallMessage }}</span>
                </div>
              </div>

              <div class="evaluation-summary">
                <div class="evaluation-card today-card">
                  <div class="card-header">
                    <i class="pi pi-calendar-check"></i>
                    <span>Hôm nay</span>
                  </div>
                  <div class="card-value">{{ formatAmount(todayExpenseEvaluation().todayTotal) }}</div>
                  <div class="card-detail">{{ todayExpenseEvaluation().todayCount }} giao dịch</div>
                </div>

                <div class="evaluation-card comparison-card">
                  <div class="comparison-item">
                    <div class="comparison-label">vs TB 30 ngày</div>
                    <div class="comparison-value"
                         [class.positive]="todayExpenseEvaluation().compare30Days < 0"
                         [class.negative]="todayExpenseEvaluation().compare30Days > 0">
                      <i class="pi"
                         [class.pi-arrow-up]="todayExpenseEvaluation().compare30Days > 0"
                         [class.pi-arrow-down]="todayExpenseEvaluation().compare30Days < 0"
                         [class.pi-minus]="todayExpenseEvaluation().compare30Days === 0"></i>
                      {{ Math.abs(todayExpenseEvaluation().compare30Days) }}%
                    </div>
                    <div class="comparison-amount">{{ formatAmount(todayExpenseEvaluation().last30DaysAvg) }}</div>
                  </div>

                  <div class="comparison-item">
                    <div class="comparison-label">vs TB 7 ngày</div>
                    <div class="comparison-value"
                         [class.positive]="todayExpenseEvaluation().compare7Days < 0"
                         [class.negative]="todayExpenseEvaluation().compare7Days > 0">
                      <i class="pi"
                         [class.pi-arrow-up]="todayExpenseEvaluation().compare7Days > 0"
                         [class.pi-arrow-down]="todayExpenseEvaluation().compare7Days < 0"
                         [class.pi-minus]="todayExpenseEvaluation().compare7Days === 0"></i>
                      {{ Math.abs(todayExpenseEvaluation().compare7Days) }}%
                    </div>
                    <div class="comparison-amount">{{ formatAmount(todayExpenseEvaluation().last7DaysAvg) }}</div>
                  </div>

                  <div class="comparison-item">
                    <div class="comparison-label">vs TB tuần này</div>
                    <div class="comparison-value"
                         [class.positive]="todayExpenseEvaluation().compareWeek < 0"
                         [class.negative]="todayExpenseEvaluation().compareWeek > 0">
                      <i class="pi"
                         [class.pi-arrow-up]="todayExpenseEvaluation().compareWeek > 0"
                         [class.pi-arrow-down]="todayExpenseEvaluation().compareWeek < 0"
                         [class.pi-minus]="todayExpenseEvaluation().compareWeek === 0"></i>
                      {{ Math.abs(todayExpenseEvaluation().compareWeek) }}%
                    </div>
                    <div class="comparison-amount">{{ formatAmount(todayExpenseEvaluation().currentWeekAvg) }}</div>
                  </div>

                  <div class="comparison-item">
                    <div class="comparison-label">vs TB tháng này</div>
                    <div class="comparison-value"
                         [class.positive]="todayExpenseEvaluation().compareMonth < 0"
                         [class.negative]="todayExpenseEvaluation().compareMonth > 0">
                      <i class="pi"
                         [class.pi-arrow-up]="todayExpenseEvaluation().compareMonth > 0"
                         [class.pi-arrow-down]="todayExpenseEvaluation().compareMonth < 0"
                         [class.pi-minus]="todayExpenseEvaluation().compareMonth === 0"></i>
                      {{ Math.abs(todayExpenseEvaluation().compareMonth) }}%
                    </div>
                    <div class="comparison-amount">{{ formatAmount(todayExpenseEvaluation().currentMonthAvg) }}</div>
                  </div>
                </div>
              </div>

              <!-- Comparison Charts -->
              <div class="evaluation-charts">
                <div class="chart-container comparison-chart">
                  <h4>So sánh với các mốc trung bình</h4>
                  <div class="chart-wrapper">
                    <canvas #todayComparisonChart></canvas>
                  </div>
                </div>

                <div class="chart-container trend-chart">
                  <h4>Xu hướng 30 ngày qua</h4>
                  <div class="chart-wrapper">
                    <canvas #todayTrendChart></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Statistical Analysis & Outlier Detection -->
            <div class="statistical-analysis-section" *ngIf="!isLoading() && filteredExpenses().length > 0">
              <div class="analysis-header">
                <div class="header-left">
                  <i class="pi pi-chart-bar"></i>
                  <h3>Phân tích thống kê & Chi tiêu đột biến</h3>
                </div>
              </div>

              <!-- Statistical Metrics -->
              <div class="statistical-metrics">
                <div class="metric-card">
                  <div class="metric-icon">
                    <i class="pi pi-calculator"></i>
                  </div>
                  <div class="metric-content">
                    <div class="metric-label">Trung bình (Mean)</div>
                    <div class="metric-value">{{ formatAmount(statisticalAnalysis().mean) }}</div>
                    <div class="metric-note">Giá trị trung bình</div>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon">
                    <i class="pi pi-sort"></i>
                  </div>
                  <div class="metric-content">
                    <div class="metric-label">Trung vị (Median)</div>
                    <div class="metric-value">{{ formatAmount(statisticalAnalysis().median) }}</div>
                    <div class="metric-note">Giá trị ở giữa</div>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon">
                    <i class="pi pi-chart-line"></i>
                  </div>
                  <div class="metric-content">
                    <div class="metric-label">Độ lệch chuẩn</div>
                    <div class="metric-value">{{ formatAmount(statisticalAnalysis().standardDeviation) }}</div>
                    <div class="metric-note">SD = {{ statisticalAnalysis().standardDeviation.toLocaleString() }}</div>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon">
                    <i class="pi pi-percentage"></i>
                  </div>
                  <div class="metric-content">
                    <div class="metric-label">Hệ số biến thiên</div>
                    <div class="metric-value">{{ statisticalAnalysis().coefficientOfVariation }}%</div>
                    <div class="metric-note">CV = (SD/Mean) × 100</div>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon">
                    <i class="pi pi-exclamation-triangle"></i>
                  </div>
                  <div class="metric-content">
                    <div class="metric-label">Chi tiêu đột biến</div>
                    <div class="metric-value">{{ statisticalAnalysis().outliers.length }}</div>
                    <div class="metric-note">Phát hiện bằng IQR method</div>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon">
                    <i class="pi pi-chart-bar"></i>
                  </div>
                  <div class="metric-content">
                    <div class="metric-label">Độ lệch (Skewness)</div>
                    <div class="metric-value">{{ statisticalAnalysis().skewness }}</div>
                    <div class="metric-note">
                      <span *ngIf="statisticalAnalysis().skewness > 0.5">Lệch phải</span>
                      <span *ngIf="statisticalAnalysis().skewness < -0.5">Lệch trái</span>
                      <span *ngIf="statisticalAnalysis().skewness >= -0.5 && statisticalAnalysis().skewness <= 0.5">Gần đối xứng</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Quartiles Info -->
              <div class="quartiles-section">
                <h4>Phân vị (Quartiles)</h4>
                <div class="quartiles-grid">
                  <div class="quartile-item">
                    <div class="quartile-label">Q1 (25%)</div>
                    <div class="quartile-value">{{ formatAmount(statisticalAnalysis().q1) }}</div>
                  </div>
                  <div class="quartile-item">
                    <div class="quartile-label">Q2 (50% - Median)</div>
                    <div class="quartile-value highlight">{{ formatAmount(statisticalAnalysis().q2) }}</div>
                  </div>
                  <div class="quartile-item">
                    <div class="quartile-label">Q3 (75%)</div>
                    <div class="quartile-value">{{ formatAmount(statisticalAnalysis().q3) }}</div>
                  </div>
                  <div class="quartile-item">
                    <div class="quartile-label">IQR</div>
                    <div class="quartile-value">{{ formatAmount(statisticalAnalysis().iqr) }}</div>
                    <div class="quartile-note">Q3 - Q1</div>
                  </div>
                </div>
                <div class="outlier-bounds">
                  <div class="bound-item">
                    <span class="bound-label">Ngưỡng dưới:</span>
                    <span class="bound-value">{{ formatAmount(statisticalAnalysis().lowerBound || 0) }}</span>
                    <span class="bound-formula">Q1 - 1.5 × IQR</span>
                  </div>
                  <div class="bound-item">
                    <span class="bound-label">Ngưỡng trên:</span>
                    <span class="bound-value">{{ formatAmount(statisticalAnalysis().upperBound || 0) }}</span>
                    <span class="bound-formula">Q3 + 1.5 × IQR</span>
                  </div>
                </div>
              </div>

              <!-- Outlier Charts -->
              <div class="outlier-charts-section">
                <div class="chart-container outlier-chart">
                  <h4>Phát hiện chi tiêu đột biến</h4>
                  <p class="chart-description">Biểu đồ scatter hiển thị tất cả giao dịch, các điểm đỏ/xanh là chi tiêu
                    đột biến</p>
                  <div class="chart-wrapper">
                    <canvas #outlierChart></canvas>
                  </div>
                </div>

                <div class="chart-container box-plot-chart">
                  <h4>Box Plot - Phân bố chi tiêu</h4>
                  <p class="chart-description">Hiển thị Min, Q1, Median, Q3, Max và Mean</p>
                  <div class="chart-wrapper">
                    <canvas #boxPlotChart></canvas>
                  </div>
                </div>

                <div class="chart-container zscore-chart">
                  <h4>Phân bố Z-score</h4>
                  <p class="chart-description">Z-score > 2 hoặc < -2 được coi là đột biến</p>
                  <div class="chart-wrapper">
                    <canvas #zScoreChart></canvas>
                  </div>
                </div>
              </div>

              <!-- Outliers List -->
              <div class="outliers-list-section" *ngIf="statisticalAnalysis().outliers.length > 0">
                <h4>
                  <i class="pi pi-exclamation-triangle"></i>
                  Danh sách chi tiêu đột biến ({{ statisticalAnalysis().outliers.length }})
                </h4>
                <div class="outliers-table">
                  <div class="outlier-item"
                       *ngFor="let outlier of statisticalAnalysis().outliers.slice(0, 10)"
                       [class.outlier-high]="outlier.outlierType === 'high'"
                       [class.outlier-low]="outlier.outlierType === 'low'">
                    <div class="outlier-date">{{ formatDate(outlier.date) }}</div>
                    <div class="outlier-content">{{ outlier.content }}</div>
                    <div class="outlier-category">{{ outlier.category }}</div>
                    <div class="outlier-amount">{{ formatAmount(outlier.amount) }}</div>
                    <div class="outlier-zscore"
                         [class.zscore-high]="Math.abs(outlier.zScore) >= 2"
                         [class.zscore-moderate]="Math.abs(outlier.zScore) >= 1 && Math.abs(outlier.zScore) < 2">
                      Z: {{ outlier.zScore.toFixed(2) }}
                    </div>
                  </div>
                </div>
                <div class="outliers-summary">
                  <div class="summary-item">
                    <span class="summary-label">Tổng chi tiêu đột biến:</span>
                    <span class="summary-value">{{ formatAmount(statisticalAnalysis().outliersTotal || 0) }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Tỷ lệ đột biến:</span>
                    <span
                      class="summary-value">{{ ((statisticalAnalysis().outliers.length / filteredExpenses().length) * 100).toFixed(1) }}
                      %</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Statistics for V2 -->
            <div class="enhanced-statistics-v2"
                 *ngIf="currentLayout() === 'v2' && !isLoading() && filteredExpenses().length > 0">
              <div class="stat-grid">
                <div class="stat-card-large">
                  <div class="stat-header">
                    <i class="pi pi-chart-bar"></i>
                    <h4>Thống kê chi tiêu</h4>
                  </div>
                  <div class="stat-body">
                    <div class="stat-row">
                      <span class="stat-label">Chi tiêu lớn nhất:</span>
                      <span class="stat-value" *ngIf="maxExpense()">{{ formatAmount(maxExpense()!.amount) }}</span>
                      <span class="stat-detail" *ngIf="maxExpense()">{{ maxExpense()!.content }}</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-label">Chi tiêu nhỏ nhất:</span>
                      <span class="stat-value" *ngIf="minExpense()">{{ formatAmount(minExpense()!.amount) }}</span>
                      <span class="stat-detail" *ngIf="minExpense()">{{ minExpense()!.content }}</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-label">Trung vị:</span>
                      <span class="stat-value">{{ formatAmount(medianExpense()) }}</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-label">Xu hướng (7 ngày):</span>
                      <span class="stat-value trend" [class.trend-up]="expenseTrend() === 'increasing'"
                            [class.trend-down]="expenseTrend() === 'decreasing'"
                            [class.trend-stable]="expenseTrend() === 'stable'">
                    <i class="pi" [class.pi-arrow-up]="expenseTrend() === 'increasing'"
                       [class.pi-arrow-down]="expenseTrend() === 'decreasing'"
                       [class.pi-minus]="expenseTrend() === 'stable'"></i>
                    <span *ngIf="expenseTrend() === 'increasing'">Tăng</span>
                    <span *ngIf="expenseTrend() === 'decreasing'">Giảm</span>
                    <span *ngIf="expenseTrend() === 'stable'">Ổn định</span>
                  </span>
                    </div>
                  </div>
                </div>

                <div class="stat-card-large">
                  <div class="stat-header">
                    <i class="pi pi-calendar-clock"></i>
                    <h4>Thống kê theo thứ</h4>
                  </div>
                  <div class="stat-body">
                    <div class="day-stat-item" *ngFor="let dayData of spendingByDayOfWeek()">
                      <div class="day-name">{{ dayData.day }}</div>
                      <div class="day-stats-row">
                        <span class="day-stat">Tổng: {{ formatAmount(dayData.total) }}</span>
                        <span class="day-stat">TB: {{ formatAmount(dayData.average) }}</span>
                        <span class="day-stat">Số GD: {{ dayData.count }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="stat-card-large">
                  <div class="stat-header">
                    <i class="pi pi-tag"></i>
                    <h4>Top phân loại</h4>
                  </div>
                  <div class="stat-body">
                    <div class="category-stat-item" *ngFor="let item of totalByCategory().slice(0, 5)">
                      <div class="category-name-row">
                        <span class="category-name">{{ item.category }}</span>
                        <span class="category-percentage">{{ ((item.total / totalAmount()) * 100).toFixed(1) }}%</span>
                      </div>
                      <div class="category-amount">{{ formatAmount(item.total) }}</div>
                      <div class="category-bar">
                        <div class="category-bar-fill" [style.width.%]="(item.total / totalAmount()) * 100"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Cash Flow Statistics Card -->
                <div class="stat-card-large">
                  <div class="stat-header">
                    <i class="pi pi-wallet"></i>
                    <h4>Dòng tiền</h4>
                  </div>
                  <div class="stat-body">
                    <div class="stat-row">
                      <span class="stat-label">TB/tuần:</span>
                      <span class="stat-value">{{ formatAmount(averageWeeklyExpense()) }}</span>
                      <span class="stat-detail">{{ weeklyExpenses().length }} tuần</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-label">TB/tháng:</span>
                      <span class="stat-value">{{ formatAmount(averageMonthlyExpense()) }}</span>
                      <span class="stat-detail">{{ monthlyExpenses().length }} tháng</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-label">Dự kiến/tháng:</span>
                      <span class="stat-value">{{ formatAmount(projectedMonthlySpending()) }}</span>
                      <span class="stat-detail">Dựa trên tốc độ hiện tại</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-label">Tần suất chi tiêu:</span>
                      <span class="stat-value">{{ spendingFrequency().frequency }}%</span>
                      <span class="stat-detail">{{ spendingFrequency().daysWithExpenses }}
                        /{{ spendingFrequency().totalDays }} ngày</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-label">GD/ngày:</span>
                      <span class="stat-value">{{ transactionsPerDay() }}</span>
                      <span class="stat-detail">Giao dịch trung bình</span>
                    </div>
                    <div class="stat-row" *ngIf="largestSpendingStreak().streak > 0">
                      <span class="stat-label">Chuỗi chi tiêu dài nhất:</span>
                      <span class="stat-value">{{ largestSpendingStreak().streak }} ngày</span>
                      <span class="stat-detail">{{ formatDateShort(largestSpendingStreak().startDate) }}
                        - {{ formatDateShort(largestSpendingStreak().endDate) }}</span>
                    </div>
                  </div>
                </div>

                <!-- Weekday vs Weekend Card -->
                <div class="stat-card-large">
                  <div class="stat-header">
                    <i class="pi pi-calendar-times"></i>
                    <h4>Ngày thường vs Cuối tuần</h4>
                  </div>
                  <div class="stat-body">
                    <div class="stat-row">
                      <span class="stat-label">Ngày thường:</span>
                      <span class="stat-value">{{ formatAmount(weekdayWeekendComparison().weekday.total) }}</span>
                      <span class="stat-detail">{{ weekdayWeekendComparison().weekday.count }}
                        GD, TB: {{ formatAmount(weekdayWeekendComparison().weekday.average) }}</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-label">Cuối tuần:</span>
                      <span class="stat-value">{{ formatAmount(weekdayWeekendComparison().weekend.total) }}</span>
                      <span class="stat-detail">{{ weekdayWeekendComparison().weekend.count }}
                        GD, TB: {{ formatAmount(weekdayWeekendComparison().weekend.average) }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Statistics Cards -->
            <div class="statistics-section"
                 *ngIf="currentLayout() !== 'v2' && !isLoading() && filteredExpenses().length > 0">
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="pi pi-arrow-up"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">Chi tiêu lớn nhất</div>
                  <div class="stat-value" *ngIf="maxExpense()">
                    {{ formatAmount(maxExpense()!.amount) }}
                  </div>
                  <div class="stat-detail" *ngIf="maxExpense()">
                    {{ maxExpense()!.content }}
                  </div>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon">
                  <i class="pi pi-arrow-down"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">Chi tiêu nhỏ nhất</div>
                  <div class="stat-value" *ngIf="minExpense()">
                    {{ formatAmount(minExpense()!.amount) }}
                  </div>
                  <div class="stat-detail" *ngIf="minExpense()">
                    {{ minExpense()!.content }}
                  </div>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon">
                  <i class="pi pi-chart-line"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">Trung vị</div>
                  <div class="stat-value">{{ formatAmount(medianExpense()) }}</div>
                  <div class="stat-detail">Giá trị ở giữa</div>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon" [class.trend-up]="expenseTrend() === 'increasing'"
                     [class.trend-down]="expenseTrend() === 'decreasing'"
                     [class.trend-stable]="expenseTrend() === 'stable'">
                  <i class="pi" [class.pi-arrow-up]="expenseTrend() === 'increasing'"
                     [class.pi-arrow-down]="expenseTrend() === 'decreasing'"
                     [class.pi-minus]="expenseTrend() === 'stable'"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">Xu hướng</div>
                  <div class="stat-value">
                    <span *ngIf="expenseTrend() === 'increasing'">Tăng</span>
                    <span *ngIf="expenseTrend() === 'decreasing'">Giảm</span>
                    <span *ngIf="expenseTrend() === 'stable'">Ổn định</span>
                  </div>
                  <div class="stat-detail">7 ngày gần nhất</div>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon">
                  <i class="pi pi-calendar-times"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">TB/tuần</div>
                  <div class="stat-value">{{ formatAmount(averageWeeklyExpense()) }}</div>
                  <div class="stat-detail">{{ weeklyExpenses().length }} tuần</div>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon">
                  <i class="pi pi-calendar-clock"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">TB/tháng</div>
                  <div class="stat-value">{{ formatAmount(averageMonthlyExpense()) }}</div>
                  <div class="stat-detail">{{ monthlyExpenses().length }} tháng</div>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon">
                  <i class="pi pi-chart-pie"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">Tần suất</div>
                  <div class="stat-value">{{ spendingFrequency().frequency }}%</div>
                  <div class="stat-detail">{{ spendingFrequency().daysWithExpenses }}
                    /{{ spendingFrequency().totalDays }} ngày
                  </div>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon">
                  <i class="pi pi-list"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">GD/ngày</div>
                  <div class="stat-value">{{ transactionsPerDay() }}</div>
                  <div class="stat-detail">Giao dịch TB</div>
                </div>
              </div>

              <div class="stat-card" *ngIf="largestSpendingStreak().streak > 0">
                <div class="stat-icon">
                  <i class="pi pi-arrow-right"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">Chuỗi dài nhất</div>
                  <div class="stat-value">{{ largestSpendingStreak().streak }} ngày</div>
                  <div class="stat-detail">{{ formatDateShort(largestSpendingStreak().startDate) }}
                    -{{ formatDateShort(largestSpendingStreak().endDate) }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Cash Flow Analysis Section -->
            <div class="cash-flow-section"
                 *ngIf="!isLoading() && filteredExpenses().length > 0 && !isSingleDayFilter()">
              <h3>Phân tích dòng tiền</h3>
              <div class="cash-flow-grid">
                <!-- Weekly Statistics -->
                <div class="cash-flow-card" *ngIf="weeklyExpenses().length > 0">
                  <div class="cash-flow-header">
                    <i class="pi pi-calendar-times"></i>
                    <h4>Thống kê theo tuần</h4>
                  </div>
                  <div class="cash-flow-body">
                    <div class="cash-flow-summary">
                      <div class="summary-item">
                        <span class="summary-label">Trung bình/tuần:</span>
                        <span class="summary-value">{{ formatAmount(averageWeeklyExpense()) }}</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Tổng số tuần:</span>
                        <span class="summary-value">{{ weeklyExpenses().length }}</span>
                      </div>
                    </div>
                    <div class="cash-flow-list">
                      <div class="cash-flow-item" *ngFor="let week of weeklyExpenses().slice(-5)">
                        <div class="item-label">{{ formatDateShort(week.weekStart) }}</div>
                        <div class="item-value">{{ formatAmount(week.total) }}</div>
                        <div class="item-detail">{{ week.count }} giao dịch</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Monthly Statistics -->
                <div class="cash-flow-card" *ngIf="monthlyExpenses().length > 0">
                  <div class="cash-flow-header">
                    <i class="pi pi-calendar-clock"></i>
                    <h4>Thống kê theo tháng</h4>
                  </div>
                  <div class="cash-flow-body">
                    <div class="cash-flow-summary">
                      <div class="summary-item">
                        <span class="summary-label">Trung bình/tháng:</span>
                        <span class="summary-value">{{ formatAmount(averageMonthlyExpense()) }}</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Tổng số tháng:</span>
                        <span class="summary-value">{{ monthlyExpenses().length }}</span>
                      </div>
                    </div>
                    <div class="cash-flow-list">
                      <div class="cash-flow-item" *ngFor="let month of monthlyExpenses().slice(-5)">
                        <div class="item-label">{{ month.monthKey }}</div>
                        <div class="item-value">{{ formatAmount(month.total) }}</div>
                        <div class="item-detail">{{ month.count }} GD, {{ month.daysWithExpenses }} ngày</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Projected Spending -->
                <div class="cash-flow-card">
                  <div class="cash-flow-header">
                    <i class="pi pi-chart-line"></i>
                    <h4>Dự kiến chi tiêu</h4>
                  </div>
                  <div class="cash-flow-body">
                    <div class="projected-spending">
                      <div class="projected-value">{{ formatAmount(projectedMonthlySpending()) }}</div>
                      <div class="projected-label">Dự kiến chi tiêu/tháng</div>
                      <div class="projected-note">Dựa trên tốc độ chi tiêu hiện tại</div>
                    </div>
                  </div>
                </div>

                <!-- Weekday vs Weekend -->
                <div class="cash-flow-card">
                  <div class="cash-flow-header">
                    <i class="pi pi-calendar"></i>
                    <h4>Ngày thường vs Cuối tuần</h4>
                  </div>
                  <div class="cash-flow-body">
                    <div class="comparison-grid">
                      <div class="comparison-item weekday">
                        <div class="comparison-label">Ngày thường</div>
                        <div class="comparison-value">{{ formatAmount(weekdayWeekendComparison().weekday.total) }}</div>
                        <div class="comparison-detail">
                          {{ weekdayWeekendComparison().weekday.count }} GD<br>
                          TB: {{ formatAmount(weekdayWeekendComparison().weekday.average) }}
                        </div>
                      </div>
                      <div class="comparison-item weekend">
                        <div class="comparison-label">Cuối tuần</div>
                        <div class="comparison-value">{{ formatAmount(weekdayWeekendComparison().weekend.total) }}</div>
                        <div class="comparison-detail">
                          {{ weekdayWeekendComparison().weekend.count }} GD<br>
                          TB: {{ formatAmount(weekdayWeekendComparison().weekend.average) }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Spending Section -->
            <div class="top-spending-section"
                 *ngIf="!isLoading() && !isSingleDayFilter() && (topSpendingDays().length > 0 || bottomSpendingDays().length > 0 || topExpenses().length > 0 || bottomExpenses().length > 0)">
              <h3>Top chi tiêu</h3>
              <div class="top-spending-grid">
                <!-- 5 ngày cao nhất -->
                <div class="top-column">
                  <h4>5 ngày cao nhất</h4>
                  <div class="top-list">
                    <div class="top-card" *ngFor="let day of topSpendingDays(); let i = index"
                         (click)="showDayDetailDialog(day.date)">
                      <div class="rank-badge">#{{ i + 1 }}</div>
                      <div class="card-content">
                        <div class="card-label">{{ formatDateWithDayOfWeek(day.date) }}</div>
                        <div class="card-value">{{ formatAmount(day.total) }}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 5 ngày thấp nhất -->
                <div class="top-column">
                  <h4>5 ngày thấp nhất</h4>
                  <div class="top-list">
                    <div class="top-card low-card" *ngFor="let day of bottomSpendingDays(); let i = index"
                         (click)="showDayDetailDialog(day.date)">
                      <div class="rank-badge">#{{ i + 1 }}</div>
                      <div class="card-content">
                        <div class="card-label">{{ formatDateWithDayOfWeek(day.date) }}</div>
                        <div class="card-value">{{ formatAmount(day.total) }}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 5 giao dịch cao nhất -->
                <div class="top-column">
                  <h4>5 giao dịch cao nhất</h4>
                  <div class="top-list">
                    <div class="top-card" *ngFor="let expense of topExpenses(); let i = index">
                      <div class="rank-badge">#{{ i + 1 }}</div>
                      <div class="card-content">
                        <div class="card-label">{{ expense.content }}</div>
                        <div class="card-sub-label">{{ expense.category }}</div>
                        <div class="card-date">{{ formatDateWithDayOfWeek(expense.date) }}</div>
                        <div class="card-value">{{ formatAmount(expense.amount) }}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 5 giao dịch thấp nhất -->
                <div class="top-column">
                  <h4>5 giao dịch thấp nhất</h4>
                  <div class="top-list">
                    <div class="top-card low-card" *ngFor="let expense of bottomExpenses(); let i = index">
                      <div class="rank-badge">#{{ i + 1 }}</div>
                      <div class="card-content">
                        <div class="card-label">{{ expense.content }}</div>
                        <div class="card-sub-label">{{ expense.category }}</div>
                        <div class="card-date">{{ formatDateWithDayOfWeek(expense.date) }}</div>
                        <div class="card-value">{{ formatAmount(expense.amount) }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Spending by Day of Week -->
            <div class="day-of-week-section"
                 *ngIf="!isLoading() && !isSingleDayFilter() && spendingByDayOfWeek().length > 0">
              <h3>Thống kê theo thứ</h3>
              <div class="day-of-week-grid">
                <div class="day-of-week-card" *ngFor="let dayData of spendingByDayOfWeek()"
                     (click)="showDayOfWeekDetailDialog(dayData.day)">
                  <div class="day-name">{{ dayData.day }}</div>
                  <div class="day-stats">
                    <div class="stat-item">
                      <div class="stat-label">Tổng</div>
                      <div class="stat-value">{{ formatAmount(dayData.total) }}</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Trung bình</div>
                      <div class="stat-value">{{ formatAmount(dayData.average) }}</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Số giao dịch</div>
                      <div class="stat-value">{{ dayData.count }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts -->
            <div class="charts-section" *ngIf="!isLoading() && filteredExpenses().length > 0">
              <!-- Category Pie Chart -->
              <div class="chart-container" *ngIf="totalByCategory().length > 0">
                <h3>Chi tiêu theo phân loại</h3>
                <div class="chart-wrapper">
                  <canvas #categoryChart></canvas>
                </div>
              </div>

              <!-- Category Bar Chart -->
              <div class="chart-container" *ngIf="totalByCategory().length > 0 && !isSingleDayFilter()">
                <h3>Chi tiêu theo phân loại (Cột)</h3>
                <div class="chart-wrapper">
                  <canvas #categoryBarChart></canvas>
                </div>
              </div>

              <!-- Daily Line Chart -->
              <div class="chart-container" *ngIf="dailyExpenses().length > 0 && !isSingleDayFilter()">
                <h3>Chi tiêu theo ngày</h3>
                <div class="chart-wrapper">
                  <canvas #dailyChart></canvas>
                </div>
              </div>
            </div>

            <!-- Category Breakdown -->
            <div class="category-breakdown" *ngIf="!isLoading() && totalByCategory().length > 0">
              <h3>Chi tiết theo phân loại</h3>
              <div class="category-list">
                <div class="category-item" *ngFor="let item of totalByCategory()"
                     (click)="showCategoryDetailDialog(item.category)">
                  <div class="category-info">
                    <div class="category-name">{{ item.category }}</div>
                    <div class="category-percentage">
                      {{ ((item.total / totalAmount()) * 100).toFixed(1) }}%
                    </div>
                  </div>
                  <div class="category-amount">{{ formatAmount(item.total) }}</div>
                  <div class="category-bar">
                    <div
                      class="category-bar-fill"
                      [style.width.%]="(item.total / totalAmount()) * 100">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Expense Suggestions -->
            <div class="suggestions-section" *ngIf="!isLoading()">
              <h3>Gợi ý chi tiêu</h3>
              <div class="suggestions-list">
                <div class="suggestion-item" *ngFor="let suggestion of expenseSuggestions()">
                  <i class="pi pi-info-circle"></i>
                  <span>{{ suggestion }}</span>
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" *ngIf="!isLoading() && filteredExpenses().length === 0">
              <i class="pi pi-chart-bar"></i>
              <p>Không có dữ liệu để tổng hợp</p>
            </div>

            <!-- Loading State -->
            <div class="loading-state" *ngIf="isLoading()">
              <i class="pi pi-spin pi-spinner"></i>
              <p>Đang tải...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END TRANSACTIONS SCREEN -->

    <!-- ========== INSIGHTS SCREEN ========== -->
    <div class="insights-screen-wrapper" *ngIf="currentScreen() === 'insights'">
      <!-- Tabs for Insights Screen -->
      <div class="tabs-section">
        <button
          (click)="switchTab('budget')"
          class="tab-btn"
          [class.active]="activeTab() === 'budget'">
          <i class="pi pi-wallet"></i>
          <span>Ngân sách</span>
        </button>
        <button
          (click)="switchTab('insights')"
          class="tab-btn"
          [class.active]="activeTab() === 'insights'">
          <i class="pi pi-lightbulb"></i>
          <span>Insights</span>
        </button>
      </div>

      <!-- Tab Content: Budget -->
      <div class="tab-content budget-tab" *ngIf="activeTab() === 'budget'">
        <div class="budget-view" *ngIf="!isLoading()">
          <!-- Budget Overview -->
          <div class="budget-overview">
            <div class="budget-header-section">
              <div class="budget-title">
                <i class="pi pi-wallet"></i>
                <h3>Ngân sách {{ getCurrentMonthName() }}</h3>
              </div>
              <button class="edit-budget-btn" (click)="openBudgetSettings()">
                <i class="pi pi-cog"></i>
                <span>Thiết lập</span>
              </button>
            </div>

            <!-- Overall Budget Progress -->
            <div class="overall-budget-card">
              <div class="budget-progress-header">
                <div class="budget-info">
                  <span class="budget-label">Tổng chi tiêu / Ngân sách</span>
                  <span class="budget-values">
                  <span class="spent">{{ formatAmount(monthlySpent()) }}</span>
                  <span class="separator">/</span>
                  <span class="budget">{{ formatAmount(monthlyBudget()) }}</span>
                </span>
                </div>
                <div class="budget-percentage" [class.over-budget]="budgetPercentage() > 100"
                     [class.warning]="budgetPercentage() > 80 && budgetPercentage() <= 100">
                  {{ budgetPercentage() }}%
                </div>
              </div>
              <div class="budget-progress-bar">
                <div class="progress-fill"
                     [style.width.%]="Math.min(budgetPercentage(), 100)"
                     [class.over-budget]="budgetPercentage() > 100"
                     [class.warning]="budgetPercentage() > 80 && budgetPercentage() <= 100">
                </div>
                <div class="progress-marker" *ngIf="budgetPercentage() > 100" [style.left.%]="100"></div>
              </div>
              <div class="budget-remaining" [class.over-budget]="remainingBudget() < 0">
                <i class="pi" [class.pi-check-circle]="remainingBudget() >= 0"
                   [class.pi-exclamation-triangle]="remainingBudget() < 0"></i>
                <span *ngIf="remainingBudget() >= 0">Còn lại: {{ formatAmount(remainingBudget()) }}</span>
                <span
                  *ngIf="remainingBudget() < 0">Vượt ngân sách: {{ formatAmount(Math.abs(remainingBudget())) }}</span>
              </div>
            </div>

            <!-- Daily Budget Suggestion - Only show for current month with remaining budget -->
            <div class="daily-budget-suggestion"
                 *ngIf="remainingBudget() > 0 && remainingDaysInMonth() > 0 && dailyBudgetSuggestion() > 0">
              <div class="suggestion-icon">
                <i class="pi pi-lightbulb"></i>
              </div>
              <div class="suggestion-content">
                <span class="suggestion-title">Gợi ý chi tiêu hàng ngày</span>
                <span class="suggestion-amount">{{ formatAmount(dailyBudgetSuggestion()) }}/ngày</span>
                <span class="suggestion-note">cho {{ remainingDaysInMonth() }} ngày còn lại</span>
              </div>
            </div>
          </div>

          <!-- Category Budgets -->
          <div class="category-budgets-section">
            <div class="section-header">
              <h4>
                <i class="pi pi-tag"></i>
                Ngân sách theo danh mục
              </h4>
              <span class="section-hint">Click để xem chi tiết</span>
            </div>
            <div class="category-budgets-grid">
              <div class="category-budget-card clickable" *ngFor="let catBudget of categoryBudgets()"
                   [class.over-budget]="catBudget.spent > catBudget.budget && catBudget.budget > 0"
                   [class.warning]="catBudget.percentage > 80 && catBudget.percentage <= 100"
                   [class.no-budget]="catBudget.budget === 0"
                   (click)="showBudgetCategoryDetail(catBudget.category)">
                <div class="cat-budget-header">
                  <span class="cat-name">{{ catBudget.category }}</span>
                  <span class="cat-percentage" *ngIf="catBudget.budget > 0"
                        [class.over-budget]="catBudget.spent > catBudget.budget">
                  {{ catBudget.percentage }}%
                </span>
                </div>
                <div class="cat-budget-values">
                  <span class="cat-spent">{{ formatAmount(catBudget.spent) }}</span>
                  <span class="cat-separator" *ngIf="catBudget.budget > 0">/</span>
                  <span class="cat-budget" *ngIf="catBudget.budget > 0">{{ formatAmount(catBudget.budget) }}</span>
                  <span class="cat-no-limit" *ngIf="catBudget.budget === 0">Chưa đặt hạn mức</span>
                </div>
                <div class="cat-progress-bar" *ngIf="catBudget.budget > 0">
                  <div class="cat-progress-fill"
                       [style.width.%]="Math.min(catBudget.percentage, 100)"
                       [class.over-budget]="catBudget.spent > catBudget.budget"
                       [class.warning]="catBudget.percentage > 80 && catBudget.percentage <= 100">
                  </div>
                </div>
                <div class="cat-remaining" *ngIf="catBudget.budget > 0">
                  <span *ngIf="catBudget.remaining >= 0">Còn {{ formatAmount(catBudget.remaining) }}</span>
                  <span *ngIf="catBudget.remaining < 0"
                        class="over-text">Vượt {{ formatAmount(Math.abs(catBudget.remaining)) }}</span>
                </div>
                <div class="cat-card-action">
                  <i class="pi pi-chevron-right"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Budget Trends Chart -->
          <div class="budget-trends-section">
            <div class="section-header">
              <h4>
                <i class="pi pi-chart-line"></i>
                Xu hướng chi tiêu so với ngân sách
              </h4>
            </div>
            <div class="budget-chart-container">
              <canvas #budgetTrendChart></canvas>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div class="loading-state" *ngIf="isLoading()">
          <i class="pi pi-spin pi-spinner"></i>
          <p>Đang tải...</p>
        </div>
      </div>

      <!-- Tab Content: Insights -->
      <div class="tab-content insights-tab" *ngIf="activeTab() === 'insights'">
        <div class="insights-view" *ngIf="!isLoading() && filteredExpenses().length > 0">

          <!-- Quick Stats Cards - Compact Row -->
          <div class="insights-stats-row">
            <div class="mini-stat-card">
              <i class="pi pi-fire stat-icon-mini"></i>
              <div class="mini-stat-info">
                <span class="mini-stat-value">{{ topSpendingCategory()?.category || 'N/A' }}</span>
                <span class="mini-stat-label">Top danh mục</span>
              </div>
              <span class="mini-stat-amount">{{ formatCompactAmount(topSpendingCategory()?.total || 0) }}</span>
            </div>

            <div class="mini-stat-card">
              <i class="pi pi-calendar stat-icon-mini"></i>
              <div class="mini-stat-info">
                <span class="mini-stat-value">{{ highestSpendingDay()?.dayName || 'N/A' }}</span>
                <span class="mini-stat-label">Ngày chi nhiều</span>
              </div>
              <span class="mini-stat-amount">{{ formatCompactAmount(highestSpendingDay()?.average || 0) }}</span>
            </div>

            <div class="mini-stat-card">
              <i class="pi pi-chart-line stat-icon-mini" [class.trending-up]="spendingTrend().percentage > 0"
                 [class.trending-down]="spendingTrend().percentage < 0"></i>
              <div class="mini-stat-info">
                <span class="mini-stat-value">{{ spendingTrend().trend }}</span>
                <span class="mini-stat-label">Xu hướng 30 ngày</span>
              </div>
              <span class="mini-stat-amount" [class.positive]="spendingTrend().percentage < 0"
                    [class.negative]="spendingTrend().percentage > 0">
              {{ spendingTrend().percentage >= 0 ? '+' : '' }}{{ spendingTrend().percentage }}%
            </span>
            </div>

            <div class="mini-stat-card">
              <i class="pi pi-wallet stat-icon-mini"></i>
              <div class="mini-stat-info">
                <span class="mini-stat-value">{{ averageTransactionsPerDay() | number:'1.1-1' }} GD</span>
                <span class="mini-stat-label">Trung bình/ngày</span>
              </div>
              <span class="mini-stat-amount">{{ formatCompactAmount(averageDailyExpense()) }}</span>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="insights-charts-grid">
            <!-- Category Pie Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h4><i class="pi pi-chart-pie"></i> Phân bổ theo danh mục</h4>
              </div>
              <div class="chart-body">
                <canvas #categoryPieChart></canvas>
              </div>
              <div class="chart-legend-custom">
                <div class="legend-item" *ngFor="let cat of totalByCategory().slice(0, 5); let i = index">
                  <span class="legend-color" [style.background]="getCategoryChartColor(i)"></span>
                  <span class="legend-label">{{ cat.category }}</span>
                  <span class="legend-value">{{ formatCompactAmount(cat.total) }}</span>
                </div>
              </div>
            </div>

            <!-- Daily Trend Line Chart -->
            <div class="chart-card wide">
              <div class="chart-header">
                <h4><i class="pi pi-chart-line"></i> Xu hướng chi tiêu 30 ngày</h4>
                <div class="chart-summary">
                <span class="summary-item">
                  <span class="summary-label">Tổng:</span>
                  <span class="summary-value">{{ formatCompactAmount(getLast30DaysTotal()) }}</span>
                </span>
                  <span class="summary-item">
                  <span class="summary-label">TB/ngày:</span>
                  <span class="summary-value">{{ formatCompactAmount(getLast30DaysAverage()) }}</span>
                </span>
                </div>
              </div>
              <div class="chart-body tall">
                <canvas #dailyTrendChart></canvas>
              </div>
            </div>

            <!-- Weekday Bar Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h4><i class="pi pi-calendar"></i> Chi tiêu theo thứ</h4>
              </div>
              <div class="chart-body">
                <canvas #weekdayChart></canvas>
              </div>
            </div>

            <!-- Monthly Comparison Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h4><i class="pi pi-history"></i> So sánh 6 tháng</h4>
              </div>
              <div class="chart-body">
                <canvas #monthlyCompareChart></canvas>
              </div>
            </div>

            <!-- Current vs Previous Month Daily Chart -->
            <div class="chart-card full-width">
              <div class="chart-header">
                <h4><i class="pi pi-calendar-plus"></i> So sánh chi tiêu theo ngày trong tháng</h4>
                <div class="chart-summary">
                <span class="summary-item current-month">
                  <span class="legend-dot current"></span>
                  <span class="summary-label">{{ getCurrentMonthLabel() }}:</span>
                  <span class="summary-value">{{ formatCompactAmount(currentMonthDailyData().total) }}</span>
                </span>
                  <span class="summary-item previous-month">
                  <span class="legend-dot previous"></span>
                  <span class="summary-label">{{ getPreviousMonthLabel() }}:</span>
                  <span class="summary-value">{{ formatCompactAmount(previousMonthDailyData().total) }}</span>
                </span>
                  <span class="summary-item difference"
                        [class.positive]="currentMonthDailyData().total < previousMonthDailyData().total"
                        [class.negative]="currentMonthDailyData().total > previousMonthDailyData().total">
                  <i class="pi" [class.pi-arrow-down]="currentMonthDailyData().total < previousMonthDailyData().total"
                     [class.pi-arrow-up]="currentMonthDailyData().total > previousMonthDailyData().total"></i>
                  <span class="summary-value">{{ getMonthComparisonPercentage() }}%</span>
                </span>
                </div>
              </div>
              <div class="chart-body tall">
                <canvas #monthDailyCompareChart></canvas>
              </div>
            </div>
          </div>

          <!-- Spending Tips Section - Compact -->
          <div class="tips-section-compact">
            <div class="section-header-inline">
              <h4><i class="pi pi-lightbulb"></i> Gợi ý tiết kiệm</h4>
            </div>
            <div class="tips-scroll">
              <div class="tip-chip" *ngFor="let tip of spendingTips()"
                   [class.warning]="tip.type === 'warning'"
                   [class.success]="tip.type === 'success'"
                   [class.info]="tip.type === 'info'">
                <i class="pi" [ngClass]="tip.icon"></i>
                <span class="tip-text">{{ tip.title }}</span>
              </div>
            </div>
          </div>

          <!-- Spending Patterns - Enhanced -->
          <div class="patterns-section-enhanced">
            <div class="pattern-card-enhanced">
              <h5><i class="pi pi-clock"></i> Tuần trong tháng</h5>
              <div class="horizontal-bars">
                <div class="h-bar-item" *ngFor="let week of weekOfMonthSpending()">
                  <span class="h-bar-label">{{ week.label }}</span>
                  <div class="h-bar-track">
                    <div class="h-bar-fill" [style.width.%]="week.percentage" [class.highest]="week.isHighest">
                      <span class="h-bar-value"
                            *ngIf="week.percentage > 30">{{ formatCompactAmount(week.average) }}</span>
                    </div>
                    <span class="h-bar-value outside"
                          *ngIf="week.percentage <= 30">{{ formatCompactAmount(week.average) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Achievements - Compact Grid -->
          <div class="achievements-section-compact">
            <div class="section-header-inline">
              <h4><i class="pi pi-star"></i> Thành tích</h4>
            </div>
            <div class="achievements-flex">
              <div class="achievement-badge" *ngFor="let achievement of recentAchievements()"
                   [class.achieved]="achievement.achieved"
                   [class.locked]="!achievement.achieved">
                <div class="badge-icon">
                  <i class="pi" [ngClass]="achievement.icon"></i>
                </div>
                <span class="badge-title">{{ achievement.title }}</span>
                <div class="badge-progress" *ngIf="!achievement.achieved && achievement.progress !== undefined">
                  <div class="progress-ring">
                    <svg viewBox="0 0 36 36">
                      <path class="ring-bg"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                      <path class="ring-fill" [attr.stroke-dasharray]="achievement.progress + ', 100'"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    </svg>
                    <span class="ring-text">{{ achievement.progress }}%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="!isLoading() && filteredExpenses().length === 0">
          <i class="pi pi-lightbulb"></i>
          <p>Chưa có đủ dữ liệu để phân tích</p>
          <span class="empty-hint">Thêm chi tiêu để xem insights</span>
        </div>

        <!-- Loading State -->
        <div class="loading-state" *ngIf="isLoading()">
          <i class="pi pi-spin pi-spinner"></i>
          <p>Đang tải...</p>
        </div>
      </div>
    </div>
    <!-- END INSIGHTS SCREEN -->

    <!-- Category Detail Dialog -->
    <div class="dialog-overlay" *ngIf="showCategoryDetail()" (click)="hideCategoryDetailDialog()">
      <div class="dialog-container category-detail-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header day-detail-header">
          <div class="header-content">
            <div class="header-icon">
              <i class="pi pi-tag"></i>
            </div>
            <div class="header-text">
              <h3>Chi tiết phân loại</h3>
              <p class="header-date">{{ selectedCategory() }}</p>
            </div>
          </div>
          <button (click)="hideCategoryDetailDialog()" class="close-btn">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="dialog-body day-detail-body">
          <!-- Summary -->
          <div class="day-detail-summary">
            <div class="detail-summary-card total-card">
              <div class="card-icon">
                <i class="pi pi-money-bill"></i>
              </div>
              <div class="card-content">
                <div class="detail-summary-label">Tổng chi tiêu</div>
                <div class="detail-summary-value">{{ formatAmount(categoryDetailTotal()) }}</div>
              </div>
            </div>
            <div class="detail-summary-card count-card">
              <div class="card-icon">
                <i class="pi pi-list"></i>
              </div>
              <div class="card-content">
                <div class="detail-summary-label">Số giao dịch</div>
                <div class="detail-summary-value">{{ categoryTotalTransactions() }}</div>
              </div>
            </div>
          </div>

          <!-- Statistics -->
          <div class="category-statistics" *ngIf="categoryDetailExpenses().length > 0">
            <h4>Thống kê chi tiêu</h4>
            <div class="statistics-grid">
              <div class="stat-item">
                <div class="stat-icon">
                  <i class="pi pi-shopping-cart"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">Trung bình 1 lần</div>
                  <div class="stat-value">{{ formatAmount(categoryAveragePerTransaction()) }}</div>
                  <div class="stat-note">{{ categoryTotalTransactions() }} giao dịch</div>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-icon">
                  <i class="pi pi-calendar"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">Trung bình/ngày</div>
                  <div class="stat-value">{{ formatAmount(categoryAveragePerDay()) }}</div>
                  <div class="stat-note">{{ categoryTotalDays() }} ngày có chi tiêu</div>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-icon">
                  <i class="pi pi-calendar-times"></i>
                </div>
                <div class="stat-content">
                  <div class="stat-label">Trung bình/tháng</div>
                  <div class="stat-value">{{ formatAmount(categoryAveragePerMonth()) }}</div>
                  <div class="stat-note">{{ categoryTotalMonths() }} tháng</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Chart -->
          <div class="category-detail-chart" *ngIf="categoryDetailByDate().length > 0">
            <h4>Phân bố chi tiêu theo ngày</h4>
            <div class="chart-wrapper">
              <canvas id="categoryDetailChart"></canvas>
            </div>
          </div>

          <!-- Expense List by Date -->
          <div class="day-detail-list" *ngIf="categoryDetailByDate().length > 0">
            <div class="list-header">
              <h4>
                <i class="pi pi-list-check"></i>
                Chi tiết theo ngày
              </h4>
              <span class="list-count">{{ categoryDetailByDate().length }} ngày</span>
            </div>
            <div class="expense-list-detail">
              <div class="date-group-item" *ngFor="let dateGroup of categoryDetailByDate()">
                <div class="date-group-header">
                  <span class="date-label">{{ formatDateWithDayOfWeek(dateGroup.date) }}</span>
                  <span class="date-total">{{ formatAmount(dateGroup.total) }}</span>
                </div>
                <div class="date-expenses-list">
                  <div class="expense-item-detail"
                       *ngFor="let expense of dateGroup.items; let i = index"
                       [style.--cat-color]="getCategoryColor(expense.category)"
                       [style.--cat-bg]="getCategoryBgColor(expense.category)">
                    <div class="expense-icon-wrapper">
                      <i class="fas" [ngClass]="getCategoryIcon(expense.category)"></i>
                    </div>
                    <div class="expense-number">{{ i + 1 }}</div>
                    <div class="expense-info">
                      <div class="expense-category-badge-detail">
                        <span class="category-badge-text">{{ expense.category }}</span>
                      </div>
                      <div class="expense-content-detail">{{ expense.content }}</div>
                      <div class="expense-note-detail" *ngIf="expense.note">
                        <i class="fas fa-comment"></i>
                        <span>{{ expense.note }}</span>
                      </div>
                    </div>
                    <div class="expense-amount-detail">
                      <span class="amount-value">{{ formatAmount(expense.amount) }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div class="empty-state" *ngIf="categoryDetailByDate().length === 0">
            <i class="pi pi-inbox"></i>
            <p>Không có dữ liệu</p>
          </div>
        </div>

        <div class="dialog-footer day-detail-footer">
          <button (click)="hideCategoryDetailDialog()" class="close-detail-btn">
            <i class="pi pi-check"></i>
            Đóng
          </button>
        </div>
      </div>
    </div>

    <!-- Budget Category Detail Dialog -->
    <div class="dialog-overlay" *ngIf="showBudgetCategoryDetailDialog()" (click)="hideBudgetCategoryDetail()">
      <div class="dialog-container budget-category-detail-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header budget-detail-header">
          <div class="header-content">
            <div class="header-icon-budget-category"
                 [style.--cat-color]="getCategoryColor(selectedBudgetCategory())"
                 [style.--cat-bg]="getCategoryBgColor(selectedBudgetCategory())"
                 [class.over-budget]="(selectedBudgetCategoryInfo()?.spent || 0) > (selectedBudgetCategoryInfo()?.budget || 0) && (selectedBudgetCategoryInfo()?.budget || 0) > 0">
              <i class="fas" [ngClass]="getCategoryIcon(selectedBudgetCategory())"></i>
            </div>
            <div class="header-text">
              <h3>{{ selectedBudgetCategory() }}</h3>
              <p class="header-subtitle">Ngân sách tháng {{ getCurrentMonthName() }}</p>
            </div>
          </div>
          <button (click)="hideBudgetCategoryDetail()" class="close-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="dialog-body budget-detail-body">
          <!-- Budget Overview Cards -->
          <div class="budget-detail-overview">
            <div class="overview-card spent-card"
                 [class.over-budget]="(selectedBudgetCategoryInfo()?.spent || 0) > (selectedBudgetCategoryInfo()?.budget || 0) && (selectedBudgetCategoryInfo()?.budget || 0) > 0">
              <div class="card-icon">
                <i class="pi pi-shopping-cart"></i>
              </div>
              <div class="card-content">
                <span class="card-label">Đã chi tiêu</span>
                <span class="card-value">{{ formatAmount(selectedBudgetCategoryInfo()?.spent || 0) }}</span>
              </div>
            </div>
            <div class="overview-card budget-card">
              <div class="card-icon">
                <i class="pi pi-wallet"></i>
              </div>
              <div class="card-content">
                <span class="card-label">Ngân sách</span>
                <span class="card-value">{{ formatAmount(selectedBudgetCategoryInfo()?.budget || 0) }}</span>
              </div>
            </div>
            <div class="overview-card remaining-card"
                 [class.positive]="(selectedBudgetCategoryInfo()?.remaining || 0) >= 0"
                 [class.negative]="(selectedBudgetCategoryInfo()?.remaining || 0) < 0">
              <div class="card-icon">
                <i class="pi" [class.pi-check-circle]="(selectedBudgetCategoryInfo()?.remaining || 0) >= 0"
                   [class.pi-exclamation-triangle]="(selectedBudgetCategoryInfo()?.remaining || 0) < 0"></i>
              </div>
              <div class="card-content">
                <span
                  class="card-label">{{ (selectedBudgetCategoryInfo()?.remaining || 0) >= 0 ? 'Còn lại' : 'Vượt ngân sách' }}</span>
                <span
                  class="card-value">{{ formatAmount(Math.abs(selectedBudgetCategoryInfo()?.remaining || 0)) }}</span>
              </div>
            </div>
            <div class="overview-card percentage-card">
              <div class="card-icon">
                <i class="pi pi-percentage"></i>
              </div>
              <div class="card-content">
                <span class="card-label">Tỷ lệ sử dụng</span>
                <span class="card-value" [class.over-budget]="(selectedBudgetCategoryInfo()?.percentage || 0) > 100">
                  {{ selectedBudgetCategoryInfo()?.percentage || 0 }}%
                </span>
              </div>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="budget-progress-section" *ngIf="(selectedBudgetCategoryInfo()?.budget || 0) > 0">
            <div class="progress-labels">
              <span>0%</span>
              <span class="warning-mark">80%</span>
              <span>100%</span>
            </div>
            <div class="budget-progress-track">
              <div class="progress-fill"
                   [style.width.%]="Math.min(selectedBudgetCategoryInfo()?.percentage || 0, 100)"
                   [class.warning]="(selectedBudgetCategoryInfo()?.percentage || 0) > 80 && (selectedBudgetCategoryInfo()?.percentage || 0) <= 100"
                   [class.over-budget]="(selectedBudgetCategoryInfo()?.percentage || 0) > 100">
              </div>
              <div class="warning-line" style="left: 80%"></div>
            </div>
          </div>

          <!-- Monthly Daily Chart -->
          <div class="budget-monthly-chart-section">
            <h4>
              <i class="pi pi-chart-bar"></i>
              Chi tiêu theo ngày trong tháng
            </h4>
            <div class="monthly-chart-container">
              <canvas #budgetCategoryMonthlyChart></canvas>
            </div>
          </div>

          <!-- Expense List -->
          <div class="budget-expense-list-section">
            <div class="list-header">
              <h4>
                <i class="pi pi-list"></i>
                Danh sách chi tiêu ({{ budgetCategoryExpenses().length }})
              </h4>
              <span class="list-total">Tổng: {{ formatAmount(selectedBudgetCategoryInfo()?.spent || 0) }}</span>
            </div>
            <div class="expense-list-scroll" *ngIf="budgetCategoryExpenses().length > 0">
              <div class="expense-row"
                   *ngFor="let expense of budgetCategoryExpenses(); let i = index"
                   [style.--cat-color]="getCategoryColor(expense.category)"
                   [style.--cat-bg]="getCategoryBgColor(expense.category)">
                <div class="expense-icon-budget">
                  <i class="fas" [ngClass]="getCategoryIcon(expense.category)"></i>
                </div>
                <div class="expense-date">{{ formatDateShort(expense.date) }}</div>
                <div class="expense-content">{{ expense.content }}</div>
                <div class="expense-amount">{{ formatAmount(expense.amount) }}</div>
              </div>
            </div>
            <div class="empty-list" *ngIf="budgetCategoryExpenses().length === 0">
              <i class="pi pi-inbox"></i>
              <span>Chưa có chi tiêu trong tháng này</span>
            </div>
          </div>
        </div>

        <div class="dialog-footer">
          <button (click)="hideBudgetCategoryDetail()" class="close-btn-primary">
            <i class="pi pi-check"></i>
            Đóng
          </button>
        </div>
      </div>
    </div>

    <!-- Add Expense Dialog -->
    <div class="dialog-overlay" *ngIf="showAddForm()" (click)="hideAddExpenseForm()">
      <div class="dialog-container add-expense-dialog-v2" (click)="$event.stopPropagation()">
        <div class="dialog-header-v2">
          <div class="header-left">
            <div class="header-icon-wrapper">
              <i class="fas fa-plus-circle"></i>
            </div>
            <div class="header-text">
              <h3>Thêm chi tiêu mới</h3>
              <p class="header-subtitle">Ghi lại khoản chi tiêu của bạn</p>
            </div>
          </div>
          <button (click)="hideAddExpenseForm()" class="close-btn-v2">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="dialog-body-v2">
          <!-- Success Message -->
          <div class="success-message-v2" *ngIf="showSuccessMessage()">
            <div class="success-icon">
              <i class="fas fa-check"></i>
            </div>
            <div class="success-text">
              <span *ngIf="inputMode() === 'single'">Thêm chi tiêu thành công!</span>
              <span *ngIf="inputMode() === 'multiple'">Đã lưu {{ savingProgress().total }} chi tiêu thành công!</span>
            </div>
          </div>

          <!-- Input Mode Toggle -->
          <div class="input-mode-toggle-v2">
            <button
              (click)="switchInputMode('single')"
              class="mode-btn-v2"
              [class.active]="inputMode() === 'single'">
              <i class="fas fa-pencil-alt"></i>
              <span>Nhập đơn</span>
            </button>
            <button
              (click)="switchInputMode('multiple')"
              class="mode-btn-v2"
              [class.active]="inputMode() === 'multiple'">
              <i class="fas fa-table"></i>
              <span>Nhập nhiều</span>
            </button>
          </div>

          <!-- Single Input Mode -->
          <div class="single-input-mode-v2" *ngIf="inputMode() === 'single'">
            <!-- Date & Amount Row -->
            <div class="form-row">
              <div class="form-group-v2 date-group">
                <label>
                  <i class="fas fa-calendar"></i>
                  Ngày chi tiêu
                </label>
                <input type="date" [(ngModel)]="newExpense.date" class="form-input-v2">
              </div>

              <div class="form-group-v2 amount-group">
                <label>
                  <i class="fas fa-wallet"></i>
                  Số tiền
                </label>
                <div class="amount-input-wrapper">
                  <input
                    type="text"
                    [value]="newExpense.amount || ''"
                    (input)="onNewAmountInput($event)"
                    (blur)="onNewAmountBlur($event)"
                    mask="separator"
                    thousandSeparator="."
                    [showMaskTyped]="false"
                    [dropSpecialCharacters]="false"
                    class="form-input-v2 amount-input"
                    placeholder="0">
                  <span class="amount-suffix">VNĐ</span>
                </div>
              </div>
            </div>

            <!-- Content -->
            <div class="form-group-v2">
              <label>
                <i class="fas fa-file-alt"></i>
                Nội dung chi tiêu
              </label>
              <input type="text" [(ngModel)]="newExpense.content" class="form-input-v2"
                     placeholder="Ví dụ: Ăn trưa, Mua đồ...">
            </div>

            <!-- Category Selection -->
            <div class="form-group-v2 category-group">
              <label>
                <i class="fas fa-th-large"></i>
                Phân loại
              </label>
              <div class="category-grid-v2">
                <button
                  *ngFor="let cat of categories()"
                  class="category-chip-v2"
                  [class.selected]="newExpense.category === cat"
                  [style.--cat-color]="getCategoryColor(cat)"
                  [style.--cat-bg]="getCategoryBgColor(cat)"
                  (click)="newExpense.category = cat">
                  <i class="fas" [ngClass]="getCategoryIcon(cat)"></i>
                  <span>{{ cat }}</span>
                </button>
              </div>
            </div>

            <!-- Note -->
            <div class="form-group-v2">
              <label>
                <i class="fas fa-comment"></i>
                Ghi chú <span class="optional-label">(tùy chọn)</span>
              </label>
              <textarea [(ngModel)]="newExpense.note" class="form-input-v2 textarea-input"
                        placeholder="Thêm ghi chú chi tiết..." rows="2"></textarea>
            </div>

            <!-- Group Selection -->
            <div class="form-group-v2">
              <label>
                <i class="fas fa-layer-group"></i>
                Nhóm chi tiêu <span class="optional-label">(tùy chọn)</span>
              </label>
              <select [(ngModel)]="newExpense.groupId" class="form-input-v2">
                <option value="">-- Không thuộc nhóm nào --</option>
                <option *ngFor="let group of expenseGroups()" [value]="group.id">
                  {{ group.name }} {{ group.content ? ' - ' + group.content : '' }}
                </option>
              </select>
            </div>

            <!-- Create Another Checkbox -->
            <div class="checkbox-group-v2">
              <label class="checkbox-label-v2">
                <input type="checkbox" [ngModel]="createAnother()" (ngModelChange)="createAnother.set($event)">
                <span class="checkbox-custom"></span>
                <span class="checkbox-text">Tiếp tục thêm chi tiêu khác</span>
              </label>
            </div>
          </div>

          <!-- Multiple Input Mode -->
          <div class="multiple-input-mode" *ngIf="inputMode() === 'multiple'">
            <!-- Progress Bar -->
            <div class="saving-progress" *ngIf="savingProgress().saving">
              <div class="progress-info">
                <span>Đang lưu: {{ savingProgress().current }}/{{ savingProgress().total }}</span>
                <span
                  class="progress-percent">{{ Math.round((savingProgress().current / savingProgress().total) * 100) }}
                  %</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill"
                     [style.width.%]="(savingProgress().current / savingProgress().total) * 100"></div>
              </div>
            </div>

            <!-- Total Summary -->
            <div class="multiple-total-summary">
              <div class="total-info">
                <span class="total-label">Tổng số hàng:</span>
                <span class="total-value">{{ multipleExpenses().length }}</span>
              </div>
              <div class="total-info">
                <span class="total-label">Tổng tiền:</span>
                <span class="total-value amount">{{ formatAmount(getMultipleExpensesTotal()) }}</span>
              </div>
            </div>

            <!-- Group Selection for All -->
            <div class="form-group-v2 multiple-group-selector">
              <label>
                <i class="fas fa-layer-group"></i>
                Áp dụng nhóm cho tất cả (tùy chọn)
              </label>
              <select [(ngModel)]="selectedGroupForAll" class="form-input-v2" (change)="applyGroupToAll()">
                <option value="">-- Không chọn --</option>
                <option *ngFor="let group of expenseGroups()" [value]="group.id">
                  {{ group.name }} {{ group.content ? ' - ' + group.content : '' }}
                </option>
              </select>
            </div>

            <!-- Expenses Table -->
            <div class="expenses-table-container">
              <table class="expenses-table">
                <thead>
                <tr>
                  <th style="width: 50px;">#</th>
                  <th>Ngày</th>
                  <th>Nội dung</th>
                  <th>Số tiền</th>
                  <th>Phân loại</th>
                  <th>Nhóm</th>
                  <th>Ghi chú</th>
                  <th style="width: 60px;">Thao tác</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let expense of multipleExpenses(); let i = index"
                    [class.invalid-row]="!expense.content.trim() || !expense.amount || !expense.category || !expense.date">
                  <td class="row-number">{{ i + 1 }}</td>
                  <td>
                    <input type="date" [(ngModel)]="expense.date" class="table-input">
                  </td>
                  <td>
                    <input type="text" [(ngModel)]="expense.content" class="table-input" placeholder="Nội dung">
                  </td>
                  <td>
                    <input
                      type="text"
                      [value]="formatNumberInput(expense.amount)"
                      (input)="onMultipleAmountInput($event, i)"
                      (blur)="onMultipleAmountBlur($event, i)"
                      mask="separator"
                      thousandSeparator="."
                      [showMaskTyped]="false"
                      [dropSpecialCharacters]="false"
                      class="table-input"
                      placeholder="0">
                  </td>
                  <td>
                    <select [(ngModel)]="expense.category" class="table-input">
                      <option value="">Chọn</option>
                      <option *ngFor="let cat of categories()" [value]="cat">{{ cat }}</option>
                    </select>
                  </td>
                  <td>
                    <select [(ngModel)]="expense.groupId" class="table-input">
                      <option value="">--</option>
                      <option *ngFor="let group of expenseGroups()" [value]="group.id">
                        {{ group.name }}
                      </option>
                    </select>
                  </td>
                  <td>
                    <input type="text" [(ngModel)]="expense.note" class="table-input" placeholder="Ghi chú">
                  </td>
                  <td class="action-cell">
                    <button (click)="copyFromPreviousRow(i)" class="copy-row-btn"
                            [disabled]="i === 0" title="Copy từ hàng trước">
                      <i class="fas fa-copy"></i>
                    </button>
                    <button (click)="removeExpenseRow(i)" class="remove-row-btn"
                            [disabled]="multipleExpenses().length === 1" title="Xóa hàng">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>

            <!-- Add Row Button -->
            <div class="add-row-section">
              <button (click)="addExpenseRow()" class="add-row-btn">
                <i class="fas fa-plus"></i>
                <span>Thêm hàng</span>
              </button>
              <small class="add-row-hint">Tip: Nhấn Enter hoặc Tab để chuyển sang hàng tiếp theo</small>
            </div>
          </div>
        </div>

        <div class="dialog-footer-v2">
          <button (click)="hideAddExpenseForm()" class="cancel-btn-v2" [disabled]="savingProgress().saving">
            <i class="fas fa-times"></i>
            Hủy
          </button>
          <button
            *ngIf="inputMode() === 'single'"
            (click)="addExpense()"
            class="save-btn-v2"
            [disabled]="isLoading() || savingProgress().saving || !newExpense.content || !newExpense.amount || !newExpense.category">
            <i class="fas fa-check"></i>
            Lưu chi tiêu
          </button>
          <button
            *ngIf="inputMode() === 'multiple'"
            (click)="addMultipleExpenses()"
            class="save-btn-v2"
            [disabled]="isLoading() || savingProgress().saving">
            <i class="fas fa-check-circle"></i>
            <span *ngIf="!savingProgress().saving">Lưu tất cả ({{ multipleExpenses().length }})</span>
            <span *ngIf="savingProgress().saving">Đang lưu...</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Expense Dialog -->
    <div class="dialog-overlay edit-expense-dialog-overlay" *ngIf="showEditForm()" (click)="hideEditExpenseForm()">
      <div class="dialog-container" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h3>Chỉnh sửa chi tiêu</h3>
          <button (click)="hideEditExpenseForm()" class="close-btn">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="dialog-body">
          <div class="form-group">
            <label>Ngày:</label>
            <input type="date" [(ngModel)]="editExpense.date" class="form-input">
          </div>

          <div class="form-group">
            <label>Nội dung:</label>
            <input type="text" [(ngModel)]="editExpense.content" class="form-input"
                   placeholder="Nhập nội dung chi tiêu">
          </div>

          <div class="form-group">
            <label>Số tiền:</label>
            <input
              type="text"
              [ngModel]="editExpenseAmountDisplay()"
              (ngModelChange)="onEditAmountInputChange($event)"
              (blur)="onEditAmountBlur($event)"
              mask="separator"
              thousandSeparator="."
              [showMaskTyped]="false"
              [dropSpecialCharacters]="false"
              class="form-input"
              placeholder="0">
          </div>

          <div class="form-group">
            <label>Phân loại:</label>
            <select [(ngModel)]="editExpense.category" class="form-input">
              <option value="">Chọn phân loại</option>
              <option *ngFor="let cat of categories()" [value]="cat">{{ cat }}</option>
            </select>
          </div>

          <div class="form-group">
            <label>Ghi chú:</label>
            <textarea [(ngModel)]="editExpense.note" class="form-input" placeholder="Nhập ghi chú (tùy chọn)"
                      rows="3"></textarea>
          </div>

          <div class="form-group">
            <label>Nhóm chi tiêu:</label>
            <select [(ngModel)]="editExpense.groupId" class="form-input">
              <option value="">-- Không thuộc nhóm nào --</option>
              <option *ngFor="let group of expenseGroups()" [value]="group.id">
                {{ group.name }} {{ group.content ? ' - ' + group.content : '' }}
              </option>
            </select>
          </div>
        </div>

        <div class="dialog-footer">
          <button (click)="hideEditExpenseForm()" class="cancel-btn">Hủy</button>
          <button (click)="updateExpense()" class="save-btn" [disabled]="isLoading()">
            <i class="pi pi-save"></i>
            Lưu
          </button>
        </div>
      </div>
    </div>

    <!-- Notification Dialog -->
    <div class="dialog-overlay notification-overlay" *ngIf="showNotification()" (click)="hideNotificationDialog()">
      <div class="notification-dialog" [class.success]="notificationType() === 'success'"
           [class.error]="notificationType() === 'error'" (click)="$event.stopPropagation()">
        <div class="notification-icon">
          <i class="pi"
             [ngClass]="notificationType() === 'success' ? 'pi-check-circle' : 'pi-exclamation-triangle'"></i>
        </div>
        <div class="notification-message">{{ notificationMessage() }}</div>
        <button (click)="hideNotificationDialog()" class="notification-close-btn">
          <i class="pi pi-times"></i>
        </button>
      </div>
    </div>

    <!-- Custom Date Range Dialog -->
    <div class="dialog-overlay" *ngIf="showCustomDateDialog()" (click)="hideCustomDateRangeDialog()">
      <div class="dialog-container custom-date-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h3>Tùy chỉnh khoảng thời gian</h3>
          <button (click)="hideCustomDateRangeDialog()" class="close-btn">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="dialog-body">
          <!-- Preset Options -->
          <div class="preset-section">
            <label class="preset-label">Chọn nhanh:</label>
            <div class="preset-grid">
              <button (click)="setDateRangeLast3Days()" class="preset-btn">
                <i class="pi pi-calendar"></i>
                <span>3 ngày qua</span>
              </button>
              <button (click)="setDateRangeLast10Days()" class="preset-btn">
                <i class="pi pi-calendar"></i>
                <span>10 ngày qua</span>
              </button>
              <button (click)="setDateRangeLast7Days()" class="preset-btn">
                <i class="pi pi-calendar"></i>
                <span>7 ngày qua</span>
              </button>
              <button (click)="setDateRangeLast30Days()" class="preset-btn">
                <i class="pi pi-calendar-times"></i>
                <span>30 ngày qua</span>
              </button>
              <button (click)="setDateRangeThisMonth()" class="preset-btn">
                <i class="pi pi-calendar-times"></i>
                <span>Tháng này</span>
              </button>
              <button (click)="setDateRangeLastMonth()" class="preset-btn">
                <i class="pi pi-calendar-minus"></i>
                <span>Tháng trước</span>
              </button>
              <button (click)="setDateRangeLast3Months()" class="preset-btn">
                <i class="pi pi-calendar-plus"></i>
                <span>3 tháng qua</span>
              </button>
              <button (click)="setDateRangeLast6Months()" class="preset-btn">
                <i class="pi pi-calendar-plus"></i>
                <span>6 tháng qua</span>
              </button>
              <button (click)="setDateRangeThisYear()" class="preset-btn">
                <i class="pi pi-calendar"></i>
                <span>Năm nay</span>
              </button>
              <button (click)="setDateRangeLastYear()" class="preset-btn">
                <i class="pi pi-calendar-minus"></i>
                <span>Năm trước</span>
              </button>
            </div>
          </div>

          <div class="divider"></div>

          <!-- Custom Date Inputs -->
          <div class="custom-date-section">
            <label class="custom-date-label">Hoặc chọn khoảng thời gian tùy chỉnh:</label>
            <div class="date-inputs-row">
              <div class="form-group date-input-group">
                <label>Từ ngày:</label>
                <input type="date" [ngModel]="filterDateFrom()" (ngModelChange)="filterDateFrom.set($event)"
                       class="form-input">
              </div>

              <div class="form-group date-input-group">
                <label>Đến ngày:</label>
                <input type="date" [ngModel]="filterDateTo()" (ngModelChange)="filterDateTo.set($event)"
                       class="form-input">
              </div>
            </div>
          </div>

          <!-- Current Selection Display -->
          <div class="current-selection" *ngIf="filterDateFrom() || filterDateTo()">
            <div class="selection-content">
              <div class="selection-label">Khoảng thời gian đã chọn:</div>
              <div class="selection-value">
                <span *ngIf="filterDateFrom() && filterDateTo()">
                  {{ formatDate(filterDateFrom()) }} - {{ formatDate(filterDateTo()) }}
                </span>
                <span *ngIf="filterDateFrom() && !filterDateTo()">
                  Từ {{ formatDate(filterDateFrom()) }}
                </span>
                <span *ngIf="!filterDateFrom() && filterDateTo()">
                  Đến {{ formatDate(filterDateTo()) }}
                </span>
              </div>
            </div>
            <button (click)="clearDateRange()" class="clear-selection-btn">
              <i class="pi pi-times"></i>
              <span>Xóa</span>
            </button>
          </div>
        </div>

        <div class="dialog-footer">
          <button (click)="clearDateRange()" class="clear-btn" *ngIf="filterDateFrom() || filterDateTo()">
            <i class="pi pi-trash"></i>
            Xóa bộ lọc
          </button>
          <button (click)="hideCustomDateRangeDialog()" class="cancel-btn">Hủy</button>
          <button (click)="applyCustomDateRange()" class="save-btn">Áp dụng</button>
        </div>
      </div>
    </div>

    <!-- Day Detail Dialog -->
    <div class="dialog-overlay" *ngIf="showDayDetail()" (click)="hideDayDetailDialog()">
      <div class="dialog-container day-detail-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header day-detail-header">
          <div class="header-content">
            <div class="header-icon">
              <i class="pi pi-calendar"></i>
            </div>
            <div class="header-text">
              <h3>Chi tiết ngày</h3>
              <p class="header-date">{{ formatDate(selectedDay()) }}</p>
            </div>
          </div>
          <button (click)="hideDayDetailDialog()" class="close-btn">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="dialog-body day-detail-body">
          <div class="day-detail-summary">
            <div class="detail-summary-card total-card">
              <div class="card-icon">
                <i class="pi pi-money-bill"></i>
              </div>
              <div class="card-content">
                <div class="detail-summary-label">Tổng chi tiêu</div>
                <div class="detail-summary-value">{{ formatAmount(selectedDayTotal()) }}</div>
              </div>
            </div>
            <div class="detail-summary-card count-card">
              <div class="card-icon">
                <i class="pi pi-list"></i>
              </div>
              <div class="card-content">
                <div class="detail-summary-label">Số giao dịch</div>
                <div class="detail-summary-value">{{ selectedDayExpenses().length }}</div>
              </div>
            </div>
          </div>

          <div class="day-detail-list" *ngIf="selectedDayExpenses().length > 0">
            <div class="list-header">
              <h4>
                <i class="pi pi-list-check"></i>
                Danh sách chi tiêu
              </h4>
              <span class="list-count">{{ selectedDayExpenses().length }} mục</span>
            </div>
            <div class="expense-list-detail">
              <div class="expense-item-detail"
                   *ngFor="let expense of selectedDayExpenses(); let i = index"
                   [style.--cat-color]="getCategoryColor(expense.category)"
                   [style.--cat-bg]="getCategoryBgColor(expense.category)">
                <div class="expense-icon-wrapper">
                  <i class="fas" [ngClass]="getCategoryIcon(expense.category)"></i>
                </div>
                <div class="expense-number">{{ i + 1 }}</div>
                <div class="expense-info">
                  <div class="expense-category-badge-detail">
                    <span class="category-badge-text">{{ expense.category }}</span>
                  </div>
                  <div class="expense-content-detail">{{ expense.content }}</div>
                  <div class="expense-note-detail" *ngIf="expense.note">
                    <i class="fas fa-comment"></i>
                    <span>{{ expense.note }}</span>
                  </div>
                </div>
                <div class="expense-amount-detail">
                  <span class="amount-value">{{ formatAmount(expense.amount) }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="empty-state" *ngIf="selectedDayExpenses().length === 0">
            <div class="empty-icon">
              <i class="pi pi-inbox"></i>
            </div>
            <p>Không có chi tiêu nào trong ngày này</p>
          </div>
        </div>

        <div class="dialog-footer day-detail-footer">
          <button (click)="hideDayDetailDialog()" class="close-detail-btn">
            <i class="pi pi-check"></i>
            Đóng
          </button>
        </div>
      </div>
    </div>

    <!-- Budget Settings Dialog -->
    <div class="dialog-overlay" *ngIf="showBudgetSettings()" (click)="cancelBudgetSettings()">
      <div class="dialog-container budget-settings-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <div class="header-content">
            <div class="header-icon">
              <i class="pi pi-wallet"></i>
            </div>
            <div class="header-text">
              <h3>Thiết lập ngân sách</h3>
              <p class="header-subtitle">Tháng {{ getCurrentMonthName() }}</p>
            </div>
          </div>
          <button (click)="cancelBudgetSettings()" class="close-btn">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="dialog-body budget-settings-body">
          <!-- Budget Mode Toggle -->
          <div class="budget-mode-toggle">
            <button class="mode-btn"
                    [class.active]="budgetMode() === 'topDown'"
                    (click)="switchBudgetMode('topDown')">
              <i class="pi pi-arrow-down"></i>
              <div class="mode-info">
                <span class="mode-title">Từ tổng xuống</span>
                <span class="mode-desc">Nhập tổng, phân bổ theo trọng số</span>
              </div>
            </button>
            <button class="mode-btn"
                    [class.active]="budgetMode() === 'bottomUp'"
                    (click)="switchBudgetMode('bottomUp')">
              <i class="pi pi-arrow-up"></i>
              <div class="mode-info">
                <span class="mode-title">Từ chi tiết lên</span>
                <span class="mode-desc">Nhập từng mục, tự tính tổng</span>
              </div>
            </button>
          </div>

          <!-- TOP-DOWN MODE -->
          <div class="budget-mode-content" *ngIf="budgetMode() === 'topDown'">
            <!-- Monthly Budget Total -->
            <div class="budget-setting-section highlight">
              <label class="budget-setting-label">
                <i class="pi pi-money-bill"></i>
                Tổng ngân sách hàng tháng
              </label>
              <div class="budget-input-wrapper large">
                <input type="text"
                       [value]="formatBudgetDisplay(editMonthlyBudget())"
                       (input)="onMonthlyBudgetInput($event)"
                       class="budget-input"
                       placeholder="Nhập ngân sách">
                <span class="budget-unit">VNĐ</span>
              </div>
              <div class="budget-presets">
                <button class="preset-chip" (click)="setMonthlyBudgetPreset(5000000)"
                        [class.active]="editMonthlyBudget() === 5000000">5M
                </button>
                <button class="preset-chip" (click)="setMonthlyBudgetPreset(10000000)"
                        [class.active]="editMonthlyBudget() === 10000000">10M
                </button>
                <button class="preset-chip" (click)="setMonthlyBudgetPreset(15000000)"
                        [class.active]="editMonthlyBudget() === 15000000">15M
                </button>
                <button class="preset-chip" (click)="setMonthlyBudgetPreset(20000000)"
                        [class.active]="editMonthlyBudget() === 20000000">20M
                </button>
                <button class="preset-chip" (click)="setMonthlyBudgetPreset(30000000)"
                        [class.active]="editMonthlyBudget() === 30000000">30M
                </button>
              </div>
            </div>

            <div class="budget-divider">
              <span>Phân bổ theo trọng số</span>
              <button class="normalize-btn" (click)="normalizeWeights()" title="Chuẩn hóa về 100%">
                <i class="pi pi-sync"></i>
                {{ getTotalWeight() }}%
              </button>
            </div>

            <!-- Quick Actions -->
            <div class="category-quick-actions">
              <button class="quick-action-btn distribute" (click)="distributeBudgetEvenly()">
                <i class="pi pi-percentage"></i>
                <span>Chia đều</span>
              </button>
            </div>

            <!-- Category Weights -->
            <div class="category-weights-grid">
              <div class="category-weight-item" *ngFor="let cat of categories()">
                <div class="weight-header">
                  <span class="cat-name">{{ cat }}</span>
                  <span class="cat-amount">{{ formatCompactAmount(getCategoryBudgetValue(cat)) }}</span>
                </div>
                <div class="weight-control">
                  <input type="range"
                         [value]="getCategoryWeight(cat)"
                         (input)="updateCategoryWeight(cat, +$any($event.target).value)"
                         min="0" max="50" step="1"
                         class="weight-slider">
                  <div class="weight-input-group">
                    <input type="number"
                           [value]="getCategoryWeight(cat)"
                           (input)="updateCategoryWeight(cat, +$any($event.target).value)"
                           min="0" max="100"
                           class="weight-input">
                    <span class="weight-percent">%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- BOTTOM-UP MODE -->
          <div class="budget-mode-content" *ngIf="budgetMode() === 'bottomUp'">
            <!-- Category Budgets First -->
            <div class="budget-divider first">
              <span>Ngân sách từng danh mục</span>
            </div>

            <!-- Quick Actions -->
            <div class="category-quick-actions">
              <button class="quick-action-btn set-all" (click)="showSetAllDialog.set(true)">
                <i class="pi pi-copy"></i>
                <span>Đặt cùng giá trị</span>
              </button>
              <button class="quick-action-btn clear-all" (click)="clearAllCategoryBudgets()">
                <i class="pi pi-trash"></i>
                <span>Xóa tất cả</span>
              </button>
            </div>

            <!-- Set All Dialog (inline) -->
            <div class="set-all-inline" *ngIf="showSetAllDialog()">
              <div class="set-all-header">
                <span>Đặt cùng giá trị cho tất cả:</span>
                <button class="close-inline-btn" (click)="showSetAllDialog.set(false)">
                  <i class="pi pi-times"></i>
                </button>
              </div>
              <div class="set-all-content">
                <div class="set-all-input-wrapper">
                  <input type="text"
                         [value]="formatBudgetDisplay(setAllValue())"
                         (input)="onSetAllValueInput($event)"
                         class="set-all-input"
                         placeholder="Nhập giá trị">
                  <span class="set-all-unit">VNĐ</span>
                </div>
                <div class="set-all-presets">
                  <button class="mini-preset" (click)="setAllValue.set(500000)">500K</button>
                  <button class="mini-preset" (click)="setAllValue.set(1000000)">1M</button>
                  <button class="mini-preset" (click)="setAllValue.set(2000000)">2M</button>
                </div>
                <button class="apply-set-all-btn" (click)="applySetAllValue()">
                  <i class="pi pi-check"></i>
                  Áp dụng
                </button>
              </div>
            </div>

            <!-- Category Budgets -->
            <div class="category-budgets-grid">
              <div class="category-budget-card" *ngFor="let cat of categories()">
                <div class="card-header">
                  <span class="cat-label">{{ cat }}</span>
                </div>
                <div class="card-input">
                  <input type="text"
                         [value]="formatBudgetDisplay(getCategoryBudgetValue(cat))"
                         (input)="onCategoryBudgetInput(cat, $event); editMonthlyBudget.set(getTotalCategoryBudgets())"
                         class="cat-budget-input"
                         placeholder="0">
                  <span class="input-unit">đ</span>
                </div>
                <div class="card-presets">
                  <button (click)="setCategoryBudgetPreset(cat, 500000)">500K</button>
                  <button (click)="setCategoryBudgetPreset(cat, 1000000)">1M</button>
                  <button (click)="setCategoryBudgetPreset(cat, 2000000)">2M</button>
                  <button (click)="setCategoryBudgetPreset(cat, 3000000)">3M</button>
                </div>
              </div>
            </div>

            <!-- Auto-calculated Total -->
            <div class="budget-total-display">
              <div class="total-icon">
                <i class="pi pi-calculator"></i>
              </div>
              <div class="total-info">
                <span class="total-label">Tổng ngân sách (tự động tính)</span>
                <span class="total-value">{{ formatAmount(getTotalCategoryBudgets()) }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="dialog-footer">
          <button (click)="cancelBudgetSettings()" class="cancel-btn">Hủy</button>
          <button (click)="saveBudgetSettings()" class="save-btn">
            <i class="pi pi-save"></i>
            Lưu ngân sách
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Dialog -->
    <app-expense-settings-dialog
      *ngIf="showSettings()"
      [isVisible]="showSettings()"
      (onClose)="hideSettingsDialog()"
      (onSave)="onSettingsSave($event)">
    </app-expense-settings-dialog>

    <!-- Filter Dialog (V2) -->
    <div class="dialog-overlay" *ngIf="showFilterDialog() && currentLayout() === 'v2'"
         (click)="showFilterDialog.set(false)">
      <div class="dialog-container filter-dialog-v2" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h3>
            <i class="pi pi-filter"></i>
            Bộ lọc
          </h3>
          <button (click)="showFilterDialog.set(false)" class="close-btn">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="dialog-body">
          <!-- Time-based Filter Section -->
          <div class="filter-section">
            <h4 class="filter-section-title">
              <i class="pi pi-calendar"></i>
              Lọc theo thời gian
            </h4>

            <!-- Quick Filter Buttons -->
            <div class="quick-filters">
              <button (click)="filterToday()" class="quick-filter-btn" [class.active]="isTodayActive()">
                <i class="pi pi-calendar-check"></i>
                <span>Hôm nay</span>
              </button>
              <button (click)="filterYesterday()" class="quick-filter-btn" [class.active]="isYesterdayActive()">
                <i class="pi pi-calendar-minus"></i>
                <span>Hôm qua</span>
              </button>
              <button (click)="filterLast7Days()" class="quick-filter-btn" [class.active]="isLast7DaysActive()">
                <i class="pi pi-calendar"></i>
                <span>7 ngày qua</span>
              </button>
              <button (click)="filterLast30Days()" class="quick-filter-btn" [class.active]="isLast30DaysActive()">
                <i class="pi pi-calendar-times"></i>
                <span>30 ngày qua</span>
              </button>
              <button (click)="filterCurrentMonth()" class="quick-filter-btn" [class.active]="isCurrentMonthActive()">
                <i class="pi pi-calendar-clock"></i>
                <span>Tháng này</span>
              </button>
              <button (click)="showCustomDateRangeDialog()" class="quick-filter-btn custom">
                <i class="pi pi-sliders-h"></i>
                <span>Tùy chỉnh</span>
              </button>
            </div>

            <!-- Date Range Display -->
            <div class="date-range-display" *ngIf="filterDateFrom() || filterDateTo()">
              <i class="pi pi-calendar"></i>
              <span *ngIf="filterDateFrom() && filterDateTo()">
                {{ formatDate(filterDateFrom()) }} - {{ formatDate(filterDateTo()) }}
              </span>
              <span *ngIf="filterDateFrom() && !filterDateTo()">
                Từ {{ formatDate(filterDateFrom()) }}
              </span>
              <span *ngIf="!filterDateFrom() && filterDateTo()">
                Đến {{ formatDate(filterDateTo()) }}
              </span>
              <button (click)="clearDateRange()" class="clear-date-btn">
                <i class="pi pi-times"></i>
              </button>
            </div>
          </div>

          <!-- Search and Category Filter Section -->
          <div class="filter-section">
            <h4 class="filter-section-title">
              <i class="pi pi-search"></i>
              Tìm kiếm và phân loại
            </h4>

            <!-- Search Bar -->
            <div class="search-bar">
              <i class="pi pi-search"></i>
              <input
                type="text"
                [ngModel]="searchText()"
                (ngModelChange)="searchText.set($event)"
                class="search-input"
                placeholder="Tìm kiếm theo nội dung hoặc phân loại...">
              <button *ngIf="searchText()" (click)="searchText.set('')" class="clear-search-btn">
                <i class="pi pi-times"></i>
              </button>
            </div>

            <div class="filter-row">
              <div class="filter-group category-multi-select">
                <label>Phân loại:</label>
                <div class="category-select-wrapper">
                  <button
                    class="category-select-btn"
                    [class.has-selection]="filterCategory().length > 0"
                    (click)="toggleDropdown($event)">
                    <span class="category-select-text">
                      <span *ngIf="filterCategory().length === 0">Tất cả</span>
                      <span *ngIf="filterCategory().length === 1">{{ filterCategory()[0] }}</span>
                      <span *ngIf="filterCategory().length > 1">{{ filterCategory().length }} phân loại đã chọn</span>
                    </span>
                    <i class="pi" [class.pi-chevron-down]="!showCategoryDropdown()"
                       [class.pi-chevron-up]="showCategoryDropdown()"></i>
                  </button>

                  <div class="category-dropdown" *ngIf="showCategoryDropdown()"
                       [ngStyle]="currentLayout() === 'v2' && categoryDropdownPosition() ? {
                         'position': 'fixed',
                         'top.px': categoryDropdownPosition()!.top,
                         'left.px': categoryDropdownPosition()!.left
                       } : {}">
                    <div class="category-dropdown-header">
                      <span>Chọn phân loại</span>
                      <button (click)="filterCategory.set([])" class="clear-all-categories-btn"
                              *ngIf="filterCategory().length > 0">
                        <i class="pi pi-times"></i>
                        Xóa tất cả
                      </button>
                    </div>
                    <div class="category-dropdown-search">
                      <i class="pi pi-search"></i>
                      <input
                        type="text"
                        [ngModel]="categorySearchText()"
                        (ngModelChange)="categorySearchText.set($event)"
                        (click)="$event.stopPropagation()"
                        class="category-search-input"
                        placeholder="Tìm kiếm phân loại...">
                      <button
                        *ngIf="categorySearchText()"
                        (click)="categorySearchText.set(''); $event.stopPropagation()"
                        class="clear-search-btn-small">
                        <i class="pi pi-times"></i>
                      </button>
                    </div>
                    <div class="category-select-all-section">
                      <div
                        class="category-checkbox-item select-all-item"
                        (click)="toggleSelectAllFilteredCategories()">
                        <input
                          type="checkbox"
                          [checked]="isAllFilteredCategoriesSelected()"
                          [indeterminate]="isSomeFilteredCategoriesSelected()"
                          (click)="$event.stopPropagation()"
                          (change)="toggleSelectAllFilteredCategories()">
                        <span class="checkbox-label select-all-label">
                          <strong>Chọn tất cả</strong>
                          <span class="select-all-count" *ngIf="filteredCategories().length > 0">
                            ({{ filteredCategories().length }})
                          </span>
                        </span>
                      </div>
                    </div>
                    <div class="category-dropdown-list">
                      <div
                        class="category-checkbox-item"
                        *ngFor="let cat of filteredCategories()"
                        (click)="toggleCategory(cat)">
                        <input
                          type="checkbox"
                          [checked]="isCategorySelected(cat)"
                          (click)="$event.stopPropagation()"
                          (change)="toggleCategory(cat)">
                        <span class="checkbox-label">{{ cat }}</span>
                      </div>
                      <div class="no-results" *ngIf="filteredCategories().length === 0">
                        <i class="pi pi-search"></i>
                        <span>Không tìm thấy phân loại nào</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="filter-group">
                <label>Số tiền:</label>
                <div class="amount-input-group">
                  <input
                    type="number"
                    [ngModel]="filterAmountMin()"
                    (ngModelChange)="filterAmountMin.set($event ? Number($event) : null)"
                    class="filter-input"
                    placeholder="Từ">
                  <span class="filter-separator">-</span>
                  <input
                    type="number"
                    [ngModel]="filterAmountMax()"
                    (ngModelChange)="filterAmountMax.set($event ? Number($event) : null)"
                    class="filter-input"
                    placeholder="Đến">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="dialog-footer">
          <button (click)="clearFilters()" class="clear-all-btn"
                  *ngIf="filterCategory() || searchText() || filterAmountMin() !== null || filterAmountMax() !== null">
            <i class="pi pi-trash"></i>
            Xóa tất cả
          </button>
          <button (click)="showFilterDialog.set(false)" class="apply-btn">
            <i class="pi pi-check"></i>
            Áp dụng
          </button>
        </div>
      </div>
    </div>

    <!-- Metric Dialog (V2) -->
    <div class="dialog-overlay" *ngIf="showMetricDialog() && currentLayout() === 'v2'"
         (click)="showMetricDialog.set(false)">
      <div class="dialog-container metric-dialog-v2" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h3>
            <i class="pi pi-chart-line"></i>
            Số liệu tổng hợp
          </h3>
          <button (click)="showMetricDialog.set(false)" class="close-btn">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="dialog-body">
          <div class="summary-section compact">
            <div class="summary-card">
              <div class="summary-icon">
                <i class="pi pi-money-bill"></i>
              </div>
              <div class="summary-content">
                <div class="summary-label">Tổng chi tiêu</div>
                <div class="summary-value">{{ formatAmount(totalAmount()) }}</div>
                <div class="summary-change" *ngIf="periodComparison()">
                  <i class="pi" [class.pi-arrow-up]="periodComparison()!.change > 0"
                     [class.pi-arrow-down]="periodComparison()!.change < 0"
                     [class.pi-minus]="periodComparison()!.change === 0"></i>
                  <span [class.positive]="periodComparison()!.change > 0"
                        [class.negative]="periodComparison()!.change < 0">
                    {{ Math.abs(periodComparison()!.change) }}%
                  </span>
                  <span class="change-label">vs {{ periodComparison()!.period }} trước</span>
                </div>
              </div>
            </div>
            <div class="summary-card">
              <div class="summary-icon">
                <i class="pi pi-list"></i>
              </div>
              <div class="summary-content">
                <div class="summary-label">Số giao dịch</div>
                <div class="summary-value">{{ filteredExpenses().length }}</div>
              </div>
            </div>
            <div class="summary-card">
              <div class="summary-icon">
                <i class="pi pi-chart-line"></i>
              </div>
              <div class="summary-content">
                <div class="summary-label">TB/giao dịch</div>
                <div class="summary-value">{{ formatAmount(averageExpense()) }}</div>
              </div>
            </div>
            <div class="summary-card">
              <div class="summary-icon">
                <i class="pi pi-calendar"></i>
              </div>
              <div class="summary-content">
                <div class="summary-label">TB/ngày</div>
                <div class="summary-value">{{ formatAmount(averageDailyExpense()) }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="dialog-footer">
          <button (click)="showMetricDialog.set(false)" class="close-btn-footer">
            <i class="pi pi-check"></i>
            Đóng
          </button>
        </div>
      </div>
    </div>

    <!-- Day of Week Detail Dialog -->
    <div class="dialog-overlay" *ngIf="showDayOfWeekDetail()" (click)="hideDayOfWeekDetailDialog()">
      <div class="dialog-container day-detail-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header day-detail-header">
          <div class="header-content">
            <div class="header-icon">
              <i class="pi pi-calendar-clock"></i>
            </div>
            <div class="header-text">
              <h3>Chi tiết thống kê</h3>
              <p class="header-date">{{ selectedDayOfWeek() }}</p>
            </div>
          </div>
          <button (click)="hideDayOfWeekDetailDialog()" class="close-btn">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="dialog-body day-detail-body">
          <div class="day-detail-summary">
            <div class="detail-summary-card total-card">
              <div class="card-icon">
                <i class="pi pi-money-bill"></i>
              </div>
              <div class="card-content">
                <div class="detail-summary-label">Tổng chi tiêu</div>
                <div class="detail-summary-value">{{ formatAmount(selectedDayOfWeekTotal()) }}</div>
              </div>
            </div>
            <div class="detail-summary-card count-card">
              <div class="card-icon">
                <i class="pi pi-list"></i>
              </div>
              <div class="card-content">
                <div class="detail-summary-label">Số giao dịch</div>
                <div class="detail-summary-value">{{ selectedDayOfWeekExpenses().length }}</div>
              </div>
            </div>
          </div>

          <div class="day-detail-list" *ngIf="selectedDayOfWeekExpenses().length > 0">
            <div class="list-header">
              <h4>
                <i class="pi pi-list-check"></i>
                Danh sách chi tiêu
              </h4>
              <span class="list-count">{{ selectedDayOfWeekExpenses().length }} mục</span>
            </div>
            <div class="expense-list-detail">
              <div class="expense-item-detail"
                   *ngFor="let expense of selectedDayOfWeekExpenses(); let i = index"
                   [style.--cat-color]="getCategoryColor(expense.category)"
                   [style.--cat-bg]="getCategoryBgColor(expense.category)">
                <div class="expense-icon-wrapper">
                  <i class="fas" [ngClass]="getCategoryIcon(expense.category)"></i>
                </div>
                <div class="expense-number">{{ i + 1 }}</div>
                <div class="expense-info">
                  <div class="expense-date-detail">
                    <i class="fas fa-calendar-day"></i>
                    <span>{{ formatDate(expense.date) }}</span>
                  </div>
                  <div class="expense-category-badge-detail">
                    <span class="category-badge-text">{{ expense.category }}</span>
                  </div>
                  <div class="expense-content-detail">{{ expense.content }}</div>
                  <div class="expense-note-detail" *ngIf="expense.note">
                    <i class="fas fa-comment"></i>
                    <span>{{ expense.note }}</span>
                  </div>
                </div>
                <div class="expense-amount-detail">
                  <span class="amount-value">{{ formatAmount(expense.amount) }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="empty-state" *ngIf="selectedDayOfWeekExpenses().length === 0">
            <div class="empty-icon">
              <i class="pi pi-inbox"></i>
            </div>
            <p>Không có chi tiêu nào trong {{ selectedDayOfWeek() }}</p>
          </div>
        </div>

        <div class="dialog-footer day-detail-footer">
          <button (click)="hideDayOfWeekDetailDialog()" class="close-detail-btn">
            <i class="pi pi-check"></i>
            Đóng
          </button>
        </div>
      </div>
    </div>

    <!-- Group Detail Dialog -->
    <div class="dialog-overlay" *ngIf="showGroupDetail()" (click)="hideGroupDetailDialog()">
      <div class="dialog-container group-detail-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header group-detail-header">
          <div class="header-content">
            <div class="header-icon">
              <i class="fas fa-layer-group"></i>
            </div>
            <div class="header-text">
              <h3>{{ selectedGroup()?.name }}</h3>
              <p class="header-subtitle" *ngIf="selectedGroup()?.content">{{ selectedGroup()?.content }}</p>
            </div>
          </div>
          <button (click)="hideGroupDetailDialog()" class="close-btn">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="dialog-body group-detail-body">
          <!-- Tabs -->
          <div class="group-detail-tabs">
            <button class="tab-btn" 
                    [class.active]="groupDetailTab() === 'list'"
                    (click)="groupDetailTab.set('list')">
              <i class="fas fa-list"></i>
              <span>Danh sách chi tiêu</span>
            </button>
            <button class="tab-btn" 
                    [class.active]="groupDetailTab() === 'stats'"
                    (click)="groupDetailTab.set('stats')">
              <i class="fas fa-chart-bar"></i>
              <span>Thống kê</span>
            </button>
          </div>

          <!-- Tab Content: List -->
          <div class="tab-content" *ngIf="groupDetailTab() === 'list'">
            <div class="group-detail-list" *ngIf="selectedGroupExpenses().length > 0">
              <div class="expenses-list-group-dialog">
                <div class="expense-row-group-dialog"
                     *ngFor="let expense of selectedGroupExpenses(); let i = index"
                     [style.--cat-color]="getCategoryColor(expense.category)"
                     [style.--cat-bg]="getCategoryBgColor(expense.category)">
                  <div class="expense-row-main">
                    <div class="expense-icon-group">
                      <i class="fas" [ngClass]="getCategoryIcon(expense.category)"></i>
                    </div>
                    <div class="expense-name-group">
                      {{ expense.content }}
                    </div>
                    <div class="expense-date-group">
                      {{ formatDate(expense.date) }}
                    </div>
                    <div class="expense-amount-group">
                      {{ formatAmount(expense.amount) }}
                    </div>
                    <div class="expense-actions-group">
                      <button class="action-btn-group" (click)="duplicateExpense(expense)" title="Nhân đôi">
                        <i class="fas fa-copy"></i>
                      </button>
                      <button class="action-btn-group" (click)="showEditExpenseForm(expense, i)" title="Chỉnh sửa">
                        <i class="fas fa-pencil-alt"></i>
                      </button>
                    </div>
                  </div>
                  <div class="expense-row-meta">
                    <span class="expense-category-group" [style.color]="getCategoryColor(expense.category)">
                      {{ expense.category }}
                    </span>
                    <span class="expense-note-group" *ngIf="expense.note">
                      {{ expense.note }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="empty-state" *ngIf="selectedGroupExpenses().length === 0">
              <div class="empty-icon">
                <i class="pi pi-inbox"></i>
              </div>
              <p>Không có chi tiêu nào trong nhóm này</p>
            </div>
          </div>

          <!-- Tab Content: Statistics -->
          <div class="tab-content" *ngIf="groupDetailTab() === 'stats'">
            <div class="group-detail-summary">
              <div class="detail-summary-card total-card">
                <div class="card-icon">
                  <i class="pi pi-money-bill"></i>
                </div>
                <div class="card-content">
                  <div class="detail-summary-label">Tổng chi tiêu</div>
                  <div class="detail-summary-value">{{ formatAmount(selectedGroupTotal()) }}</div>
                </div>
              </div>
              <div class="detail-summary-card count-card">
                <div class="card-icon">
                  <i class="pi pi-list"></i>
                </div>
                <div class="card-content">
                  <div class="detail-summary-label">Số chi tiêu</div>
                  <div class="detail-summary-value">{{ selectedGroupExpenses().length }}</div>
                </div>
              </div>
              <div class="detail-summary-card date-card" *ngIf="selectedGroup()?.dateFrom && selectedGroup()?.dateTo">
                <div class="card-icon">
                  <i class="pi pi-calendar"></i>
                </div>
                <div class="card-content">
                  <div class="detail-summary-label">Thời gian</div>
                  <div class="detail-summary-value">{{ formatDate(selectedGroup()!.dateFrom!) }} - {{ formatDate(selectedGroup()!.dateTo!) }}</div>
                </div>
              </div>
            </div>

            <!-- Additional Statistics -->
            <div class="group-stats-detail" *ngIf="selectedGroup()">
              <div class="stat-item">
                <span class="stat-label">Trung bình mỗi chi tiêu:</span>
                <span class="stat-value">{{ formatAmount(getGroupAverageExpense(selectedGroup()!)) }}</span>
              </div>
              <div class="stat-item" *ngIf="getGroupMaxExpense(selectedGroup()!)">
                <span class="stat-label">Chi tiêu cao nhất:</span>
                <span class="stat-value">{{ formatAmount(getGroupMaxExpense(selectedGroup()!)!.amount) }}</span>
                <span class="stat-detail">{{ getGroupMaxExpense(selectedGroup()!)!.content }}</span>
              </div>
              <div class="stat-item" *ngIf="getGroupMinExpense(selectedGroup()!)">
                <span class="stat-label">Chi tiêu thấp nhất:</span>
                <span class="stat-value">{{ formatAmount(getGroupMinExpense(selectedGroup()!)!.amount) }}</span>
                <span class="stat-detail">{{ getGroupMinExpense(selectedGroup()!)!.content }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="dialog-footer group-detail-footer">
          <button (click)="showEditGroupForm(selectedGroup()!)" class="edit-btn" *ngIf="selectedGroup()">
            <i class="pi pi-pencil"></i>
            Chỉnh sửa
          </button>
          <button (click)="hideGroupDetailDialog()" class="close-detail-btn">
            <i class="pi pi-check"></i>
            Đóng
          </button>
        </div>
      </div>
    </div>

    <!-- Group Form Dialog -->
    <div class="dialog-overlay" *ngIf="showGroupForm()" (click)="hideGroupForm()">
      <div class="dialog-container group-form-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h3>{{ editingGroup() ? 'Chỉnh sửa nhóm chi tiêu' : 'Thêm nhóm chi tiêu' }}</h3>
          <button (click)="hideGroupForm()" class="close-btn">
            <i class="pi pi-times"></i>
          </button>
        </div>

        <div class="dialog-body">
          <div class="form-group">
            <label>ID Nhóm *</label>
            <input type="text" [(ngModel)]="newGroup.id" class="form-input" placeholder="group_123" [readonly]="editingGroup() !== null">
            <small class="form-hint">ID duy nhất để nhận diện nhóm (không thể thay đổi sau khi tạo)</small>
          </div>

          <div class="form-group">
            <label>Tên nhóm *</label>
            <input type="text" [(ngModel)]="newGroup.name" class="form-input" placeholder="Ví dụ: Du lịch Vũng Tàu">
          </div>

          <div class="form-group">
            <label>Nội dung/Ghi chú</label>
            <textarea [(ngModel)]="newGroup.content" class="form-input" rows="3" placeholder="Mô tả về nhóm chi tiêu này..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Từ ngày</label>
              <input type="date" [(ngModel)]="newGroup.dateFrom" class="form-input">
            </div>
            <div class="form-group">
              <label>Đến ngày</label>
              <input type="date" [(ngModel)]="newGroup.dateTo" class="form-input">
            </div>
          </div>

          <div class="form-group">
            <label>Tổng tiền</label>
            <input type="number" [(ngModel)]="newGroup.totalAmount" class="form-input" placeholder="0" [readonly]="true">
            <small class="form-hint">Tổng tiền sẽ được tính tự động từ các chi tiêu trong nhóm</small>
          </div>
        </div>

        <div class="dialog-footer">
          <button (click)="hideGroupForm()" class="cancel-btn">Hủy</button>
          <button (click)="saveGroup()" class="save-btn">Lưu</button>
        </div>
      </div>
    </div>
  </div>
</div>

