<div class="stock-app">
  <!-- Detail View -->
  <div *ngIf="showDetailView() && selectedSymbol()" class="detail-view">
    <div class="detail-header">
      <div class="header-content">
        <button class="btn-back" (click)="closeDetailView()">
          <i class="pi pi-arrow-left"></i>
        </button>
        <!-- Company Header Info -->
        <div class="header-company-info" *ngIf="selectedSymbol()?.basicInfo?.fullData || selectedSymbol()?.basicInfo">
          <div class="company-logo-small" *ngIf="getCompanyField('image')">
            <img [src]="getCompanyField('image')" [alt]="getCompanyField('fullName') || selectedSymbol()?.symbol"
                 onerror="this.style.display='none'">
          </div>
          <div class="header-company-details">
            <h2>{{ getCompanyField('fullName') || selectedSymbol()?.basicInfo?.companyName || selectedSymbol()?.symbol }}</h2>
            <div class="company-name-en" *ngIf="getCompanyField('fullNameEn')">
              {{ getCompanyField('fullNameEn') }}
            </div>
            <div class="company-symbol-badge">
              <span class="badge">{{ selectedSymbol()?.symbol }}</span>
              <span class="badge" *ngFor="let exch of getExchangesArray(selectedSymbol()?.exchange)">
                {{ exchangeNames[exch] || exch }}
              </span>
              <span class="badge index-badge" *ngFor="let index of getTickerField('indexCodes')">
                {{ index }}
              </span>
            </div>
            <div class="price-info" *ngIf="selectedSymbol()?.basicInfo?.matchPrice">
              <span class="price-value">{{ (parseFloat(selectedSymbol()!.basicInfo!.matchPrice) * 1000) | number:'1.0-0' }} đ</span>
              <span [class]="parseFloat(selectedSymbol()!.basicInfo!.changedValue || '0') >= 0 ? 'positive' : 'negative'">
                {{ parseFloat(selectedSymbol()!.basicInfo!.changedValue || '0') >= 0 ? '+' : '' }}{{ (parseFloat(selectedSymbol()!.basicInfo!.changedValue || '0') * 1000) | number:'1.0-0' }} đ
                ({{ selectedSymbol()?.basicInfo?.changedRatio || '0' }}%)
              </span>
            </div>
          </div>
        </div>
        <div class="header-search-wrapper">
          <div class="header-search-box">
            <i class="pi" [ngClass]="isSearchingAPI() ? 'pi-spin pi-spinner' : 'pi-search'"></i>
            <input
              type="text"
              [value]="headerSearchQuery()"
              (input)="onHeaderSearchInput($any($event.target).value)"
              (keydown)="onHeaderSearchKeydown($event)"
              (focus)="showSearchSuggestions.set(headerSearchQuery().length > 0)"
              (blur)="onHeaderSearchBlur()"
              placeholder="Tìm mã cổ phiếu..."
              class="header-search-input">
            <button *ngIf="headerSearchQuery()" (click)="headerSearchQuery.set(''); showSearchSuggestions.set(false); apiSearchResults.set([])" class="clear-search-btn">
              <i class="pi pi-times"></i>
            </button>
          </div>
          <div class="search-suggestions" *ngIf="showSearchSuggestions() && (getHeaderSearchSuggestions().length > 0 || isSearchingAPI())">
            <!-- Loading state -->
            <div class="suggestion-loading" *ngIf="isSearchingAPI() && getHeaderSearchSuggestions().length === 0">
              <i class="pi pi-spin pi-spinner"></i>
              <span>Đang tìm kiếm...</span>
            </div>
            <!-- Results -->
            <div
              *ngFor="let suggestion of getHeaderSearchSuggestions()"
              class="suggestion-item"
              (mousedown)="selectSymbolFromSuggestion(suggestion)"
              [class.fetched]="suggestion.isFetched"
              [class.from-api]="$any(suggestion).source === 'api'">
              <div class="suggestion-symbol">
                {{ suggestion.symbol }}
                <span class="api-badge" *ngIf="$any(suggestion).source === 'api'">DB</span>
              </div>
              <div class="suggestion-name">{{ suggestion.name }}</div>
              <div class="suggestion-exchange">
                <span class="badge" *ngFor="let exch of suggestion.exchange">{{ $any(exchangeNames)[exch] || exch }}</span>
              </div>
            </div>
            <!-- Searching indicator at bottom -->
            <div class="suggestion-searching" *ngIf="isSearchingAPI() && getHeaderSearchSuggestions().length > 0">
              <i class="pi pi-spin pi-spinner"></i> Đang tìm thêm...
            </div>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn-icon" (click)="fetchSymbol(selectedSymbol()!)" title="Fetch lại">
            <i class="pi pi-refresh"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'overview'"
        (click)="activeTab.set('overview')">
        <i class="pi pi-info-circle"></i>
        <span>Tổng quan</span>
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'financial'"
        (click)="activeTab.set('financial')">
        <i class="pi pi-wallet"></i>
        <span>Tài chính</span>
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'trading'"
        (click)="activeTab.set('trading')">
        <i class="pi pi-shopping-cart"></i>
        <span>Trading</span>
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'chart'"
        (click)="activeTab.set('chart')">
        <i class="pi pi-chart-line"></i>
        <span>Biểu đồ</span>
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'advisor'"
        (click)="activeTab.set('advisor')">
        <i class="pi pi-compass"></i>
        <span>Tư vấn tự động</span>
      </button>
    </div>

    <div class="detail-content" *ngIf="selectedSymbol()">
      <!-- Loading -->
      <div class="loading" *ngIf="isLoadingDetail() || isLoadingPrice()">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Đang tải...</span>
      </div>

      <!-- Overview Tab -->
      <div *ngIf="activeTab() === 'overview' && !isLoadingDetail()">
        <!-- Basic Info from fullData -->
        <section class="section" *ngIf="selectedSymbol()?.basicInfo?.fullData || selectedSymbol()?.basicInfo">
          <h3>Thông tin cơ bản</h3>
          <div class="info-grid">
            <div class="info-item" *ngIf="selectedSymbol()?.symbol">
              <label>Mã cổ phiếu</label>
              <span>{{ selectedSymbol()?.symbol }}</span>
            </div>
            <div class="info-item" *ngIf="selectedSymbol()?.basicInfo?.companyName || getCompanyField('fullName')">
              <label>Tên công ty</label>
              <span>{{ getCompanyField('fullName') || selectedSymbol()?.basicInfo?.companyName }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('fullNameEn')">
              <label>Tên tiếng Anh</label>
              <span>{{ getCompanyField('fullNameEn') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('name')">
              <label>Tên ngắn</label>
              <span>{{ getCompanyField('name') }}</span>
            </div>
            <div class="info-item" *ngIf="selectedSymbol()?.exchange">
              <label>Sàn giao dịch</label>
              <span>
                <span class="badge" *ngFor="let exch of getExchangesArray(selectedSymbol()?.exchange)">
                  {{ exchangeNames[exch] || exch }}
                </span>
              </span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('taxCode')">
              <label>Mã số thuế</label>
              <span>{{ getCompanyField('taxCode') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('address') || getCompanyField('permanentAddress')">
              <label>Địa chỉ</label>
              <span>{{ getCompanyField('address') || getCompanyField('permanentAddress') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('permanentAddress') && getCompanyField('address')">
              <label>Địa chỉ trụ sở chính</label>
              <span>{{ getCompanyField('permanentAddress') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('phone')">
              <label>Điện thoại</label>
              <span>{{ getCompanyField('phone') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('email')">
              <label>Email</label>
              <span><a [href]="'mailto:' + getCompanyField('email')">{{ getCompanyField('email') }}</a></span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('url')">
              <label>Website</label>
              <span><a [href]="'https://' + getCompanyField('url')" target="_blank" rel="noopener">{{ getCompanyField('url') }}</a></span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('fax')">
              <label>Fax</label>
              <span>{{ getCompanyField('fax') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('foundDate')">
              <label>Ngày thành lập</label>
              <span>{{ getCompanyField('foundDate') | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('issueDate')">
              <label>Ngày niêm yết</label>
              <span>{{ getCompanyField('issueDate') | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('listedDate')">
              <label>Ngày giao dịch đầu tiên</label>
              <span>{{ getTickerField('listedDate') | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('firstTradingSessionPrice')">
              <label>Giá giao dịch đầu tiên</label>
              <span class="price">{{ (getCompanyField('firstTradingSessionPrice') * 1000) | number:'1.0-0' }} đ</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('capital')">
              <label>Vốn điều lệ</label>
              <span>{{ (getCompanyField('capital') / 1000000000) | number:'1.2-2' }} tỷ đồng</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('stockFaceValue')">
              <label>Mệnh giá</label>
              <span>{{ getCompanyField('stockFaceValue') | number:'1.0-0' }} đ</span>
            </div>
            <div class="info-item" *ngIf="selectedSymbol()?.basicInfo?.matchPrice">
              <label>Giá khớp</label>
              <span class="price">{{ (parseFloat(selectedSymbol()!.basicInfo!.matchPrice) * 1000) | number:'1.0-0' }} đ</span>
            </div>
            <div class="info-item" *ngIf="selectedSymbol()?.basicInfo?.changedValue">
              <label>Thay đổi</label>
              <span [class]="parseFloat(selectedSymbol()!.basicInfo!.changedValue) >= 0 ? 'positive' : 'negative'">
                {{ (parseFloat(selectedSymbol()!.basicInfo!.changedValue) * 1000) | number:'1.0-0' }} đ
                ({{ selectedSymbol()?.basicInfo?.changedRatio || '0' }}%)
              </span>
            </div>
            <div class="info-item" *ngIf="selectedSymbol()?.basicInfo?.totalVolume">
              <label>Khối lượng</label>
              <span>{{ selectedSymbol()?.basicInfo?.totalVolume | number:'1.0-0' }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('beta')">
              <label>Beta</label>
              <span>{{ getCompanyField('beta') | number:'1.2-2' }}</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('outstandingShares')">
              <label>Số cổ phiếu lưu hành</label>
              <span>{{ (getTickerField('outstandingShares') / 1000000) | number:'1.2-2' }} triệu CP</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('listedShares')">
              <label>Số cổ phiếu niêm yết</label>
              <span>{{ (getTickerField('listedShares') / 1000000) | number:'1.2-2' }} triệu CP</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('foreignOwnership') !== null && getTickerField('foreignOwnership') !== undefined">
              <label>Tỷ lệ sở hữu nước ngoài</label>
              <span>{{ getTickerField('foreignOwnership') | number:'1.2-2' }}%</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('dividend')">
              <label>Cổ tức</label>
              <span>{{ getTickerField('dividend') | number:'1.2-2' }}%</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('dividendYield')">
              <label>Tỷ suất cổ tức</label>
              <span>{{ getTickerField('dividendYield') | number:'1.2-2' }}%</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('high52w')">
              <label>Giá cao nhất 52 tuần</label>
              <span class="price">{{ (getTickerField('high52w') * 1000) | number:'1.0-0' }} đ</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('low52w')">
              <label>Giá thấp nhất 52 tuần</label>
              <span class="price">{{ (getTickerField('low52w') * 1000) | number:'1.0-0' }} đ</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('avgVolume20d')">
              <label>KL trung bình 20 ngày</label>
              <span>{{ (getTickerField('avgVolume20d') / 1000000) | number:'1.2-2' }} triệu</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('avgVolume30d')">
              <label>KL trung bình 30 ngày</label>
              <span>{{ (getTickerField('avgVolume30d') / 1000000) | number:'1.2-2' }} triệu</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('marketCap')">
              <label>Vốn hóa thị trường</label>
              <span>{{ (getTickerField('marketCap') / 1000000000) | number:'1.2-2' }} tỷ đồng</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('freeFloat')">
              <label>Free float</label>
              <span>{{ (getTickerField('freeFloat') / 1000000) | number:'1.2-2' }} triệu CP</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('freeFloatRatio') !== null && getTickerField('freeFloatRatio') !== undefined">
              <label>Tỷ lệ free float</label>
              <span>{{ getTickerField('freeFloatRatio') | number:'1.2-2' }}%</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('contactPerson')">
              <label>Người liên hệ</label>
              <span>{{ getCompanyField('contactPerson') }} - {{ getCompanyField('contactPersonPosition') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('infoSupplier')">
              <label>Người cung cấp thông tin</label>
              <span>{{ getCompanyField('infoSupplier') }} - {{ getCompanyField('infoSupplierPosition') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('phoneSupplier')">
              <label>Điện thoại liên hệ</label>
              <span>{{ getCompanyField('phoneSupplier') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('auditFirm')">
              <label>Công ty kiểm toán</label>
              <span>{{ getCompanyField('auditFirm') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('foundPermit')">
              <label>Giấy phép thành lập</label>
              <span>{{ getCompanyField('foundPermit') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('businessPermit')">
              <label>Giấy phép kinh doanh</label>
              <span>{{ getCompanyField('businessPermit') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('identityNumber')">
              <label>Số CMND/CCCD</label>
              <span>{{ getCompanyField('identityNumber') }}</span>
            </div>
            <div class="info-item full-width" *ngIf="getCompanyField('introduction')">
              <label>Giới thiệu</label>
              <span class="intro-text">{{ getCompanyField('introduction') }}</span>
            </div>
            <div class="info-item full-width" *ngIf="getCompanyField('notes')">
              <label>Lịch sử phát triển</label>
              <div class="notes-text" [innerHTML]="getCompanyField('notes')"></div>
            </div>
            <div class="info-item full-width" *ngIf="getCompanyField('otherInfo')">
              <label>Thông tin khác</label>
              <span class="intro-text">{{ getCompanyField('otherInfo') }}</span>
            </div>
            <div class="info-item full-width" *ngIf="getCompanyField('branch')">
              <label>Chi nhánh và phòng giao dịch</label>
              <span class="intro-text">{{ getCompanyField('branch') }}</span>
            </div>
          </div>
        </section>

        <!-- Industry & Sector Info -->
        <section class="section" *ngIf="getCompanyField('industryName') || getTickerField('industry')">
          <h3>Phân loại ngành nghề</h3>
          <div class="info-grid">
            <div class="info-item" *ngIf="getCompanyField('industryName') || getTickerField('industry')">
              <label>Ngành</label>
              <span>{{ getCompanyField('industryName') || getTickerField('industry') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('subIndustryName') || getTickerField('subIndustry')">
              <label>Ngành phụ</label>
              <span>{{ getCompanyField('subIndustryName') || getTickerField('subIndustry') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('sectorName') || getTickerField('sector')">
              <label>Lĩnh vực</label>
              <span>{{ getCompanyField('sectorName') || getTickerField('sector') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('sectorIndexName') || getTickerField('sectorIndex')">
              <label>Chỉ số ngành</label>
              <span>{{ getCompanyField('sectorIndexName') || getTickerField('sectorIndex') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('companyTypeName')">
              <label>Loại hình công ty</label>
              <span>{{ getCompanyField('companyTypeName') }}</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('indexCode')">
              <label>Chỉ số chính</label>
              <span class="badge index-badge">{{ getTickerField('indexCode') }}</span>
            </div>
            <div class="info-item" *ngIf="getTickerField('indexCodes') && getTickerField('indexCodes').length > 0">
              <label>Các chỉ số</label>
              <div class="badge-list">
                <span class="badge index-badge" *ngFor="let index of getTickerField('indexCodes')">
                  {{ index }}
                </span>
              </div>
            </div>
          </div>
        </section>

        <!-- GICS Classification -->
        <section class="section" *ngIf="getCompanyField('gicsSector') || getTickerField('gicsSector')">
          <h3>Phân loại GICS</h3>
          <div class="info-grid">
            <div class="info-item" *ngIf="getCompanyField('gicsSector') || getTickerField('gicsSector')">
              <label>GICS Sector</label>
              <span>{{ getCompanyField('gicsSector') || getTickerField('gicsSector') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('gicsIndustryGroup') || getTickerField('gicsIndustryGroup')">
              <label>GICS Industry Group</label>
              <span>{{ getCompanyField('gicsIndustryGroup') || getTickerField('gicsIndustryGroup') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('gicsIndustry') || getTickerField('gicsIndustry')">
              <label>GICS Industry</label>
              <span>{{ getCompanyField('gicsIndustry') || getTickerField('gicsIndustry') }}</span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('gicsSubIndustry') || getTickerField('gicsSubIndustry')">
              <label>GICS Sub-Industry</label>
              <span>{{ getCompanyField('gicsSubIndustry') || getTickerField('gicsSubIndustry') }}</span>
            </div>
          </div>
        </section>

        <!-- Trading Features -->
        <section class="section" *ngIf="getCompanyField('isMargin') !== null || getCompanyField('isVn30') !== null">
          <h3>Tính năng giao dịch</h3>
          <div class="info-grid">
            <div class="info-item" *ngIf="getCompanyField('isMargin') !== null">
              <label>Margin</label>
              <span [class]="getCompanyField('isMargin') ? 'positive' : 'negative'">
                {{ getCompanyField('isMargin') ? 'Có' : 'Không' }}
              </span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('isVn30') !== null">
              <label>VN30</label>
              <span [class]="getCompanyField('isVn30') ? 'positive' : 'negative'">
                {{ getCompanyField('isVn30') ? 'Có' : 'Không' }}
              </span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('isHnx30') !== null">
              <label>HNX30</label>
              <span [class]="getCompanyField('isHnx30') ? 'positive' : 'negative'">
                {{ getCompanyField('isHnx30') ? 'Có' : 'Không' }}
              </span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('isFtse') !== null">
              <label>FTSE</label>
              <span [class]="getCompanyField('isFtse') ? 'positive' : 'negative'">
                {{ getCompanyField('isFtse') ? 'Có' : 'Không' }}
              </span>
            </div>
            <div class="info-item" *ngIf="getCompanyField('isVnmetf') !== null">
              <label>VNMetf</label>
              <span [class]="getCompanyField('isVnmetf') ? 'positive' : 'negative'">
                {{ getCompanyField('isVnmetf') ? 'Có' : 'Không' }}
              </span>
            </div>
          </div>
        </section>

        <!-- Stock Metrics from basicInfo -->
        <section class="section" *ngIf="selectedSymbol()?.basicInfo">
          <h3>Thông số cổ phiếu</h3>
          <div class="metrics-grid">
            <div class="metric-item" *ngIf="selectedSymbol()?.basicInfo?.eps">
              <label>EPS</label>
              <span>{{ parseFloat(selectedSymbol()!.basicInfo!.eps) | number:'1.2-2' }}</span>
            </div>
            <div class="metric-item" *ngIf="selectedSymbol()?.basicInfo?.pe">
              <label>P/E</label>
              <span>{{ parseFloat(selectedSymbol()!.basicInfo!.pe) | number:'1.2-2' }}</span>
            </div>
            <div class="metric-item" *ngIf="selectedSymbol()?.basicInfo?.pb">
              <label>P/B</label>
              <span>{{ parseFloat(selectedSymbol()!.basicInfo!.pb) | number:'1.2-2' }}</span>
            </div>
            <div class="metric-item" *ngIf="selectedSymbol()?.basicInfo?.roe">
              <label>ROE</label>
              <span>{{ parseFloat(selectedSymbol()!.basicInfo!.roe) | number:'1.2-2' }}%</span>
            </div>
            <div class="metric-item" *ngIf="selectedSymbol()?.basicInfo?.roa">
              <label>ROA</label>
              <span>{{ parseFloat(selectedSymbol()!.basicInfo!.roa) | number:'1.2-2' }}%</span>
            </div>
            <div class="metric-item" *ngIf="selectedSymbol()?.basicInfo?.marketCap">
              <label>Vốn hóa</label>
              <span>{{ selectedSymbol()?.basicInfo?.marketCap | number:'1.0-0' }}</span>
            </div>
          </div>
        </section>

        <!-- Key Financial Indicators -->
        <section class="section" *ngIf="keyFinancialIndicators().length > 0">
          <h3>Chỉ số tài chính quan trọng</h3>
          <div class="key-indicators-grid">
            <div
              *ngFor="let indicator of keyFinancialIndicators()"
              class="key-indicator-card"
              [class.positive]="indicator.isPositive === true"
              [class.negative]="indicator.isPositive === false"
              [title]="indicator.tooltip">
              <div class="indicator-label">{{ indicator.label }}</div>
              <div class="indicator-value">{{ indicator.value }}</div>
              <i class="pi pi-info-circle tooltip-icon" *ngIf="indicator.tooltip"></i>
            </div>
          </div>
        </section>

        <!-- Same Sector Stocks -->
        <section class="section" *ngIf="formattedSameSectorStocks().length > 0">
          <h3>
            <i class="pi pi-sitemap"></i>
            Cổ phiếu cùng ngành ({{ formattedSameSectorStocks().length }})
            <span class="checking-indicator" *ngIf="isCheckingSameSectorStocks()">
              <i class="pi pi-spin pi-spinner"></i> Đang kiểm tra...
            </span>
          </h3>
          <div class="same-sector-stocks-grid">
            <div
              *ngFor="let stock of formattedSameSectorStocks()"
              class="sector-stock-card"
              [class.fetched]="stock.isFetched === true"
              [class.checking]="stock.isFetched === 'checking'"
              (click)="navigateToStock(stock.symbol)">
              <div class="stock-header">
                <span class="stock-symbol">{{ stock.symbol }}</span>
                <span class="stock-status">
                  <i class="pi pi-spin pi-spinner" *ngIf="stock.isFetched === 'checking'"></i>
                  <i class="pi pi-check-circle" *ngIf="stock.isFetched === true"></i>
                  <i class="pi pi-times-circle not-fetched" *ngIf="stock.isFetched === false"></i>
                </span>
              </div>
              <div class="stock-name" *ngIf="stock.name">{{ stock.shortName || stock.name }}</div>
              <div class="stock-action">
                <i class="pi pi-arrow-right"></i>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Financial Tab -->
      <div *ngIf="activeTab() === 'financial' && !isLoadingDetail()">
        <!-- Key Financial Indicators -->
        <section class="section" *ngIf="allFinancialIndicators().length > 0">
          <h3>
            <i class="pi pi-chart-bar"></i>
            Chỉ số tài chính
          </h3>
          <div class="financial-indicators-detailed">
            <div
              *ngFor="let indicator of allFinancialIndicators()"
              class="indicator-row"
              [title]="indicator.tooltip">
              <div class="indicator-label">
                {{ indicator.label }}
                <i class="pi pi-info-circle info-icon" *ngIf="indicator.tooltip"></i>
              </div>
              <div class="indicator-value">{{ indicator.value }}</div>
            </div>
          </div>
        </section>

        <!-- Financial Report Overall -->
        <section class="section" *ngIf="formattedFinancialReport().length > 0">
          <h3>
            <i class="pi pi-file-excel"></i>
            Báo cáo tài chính tổng hợp
          </h3>
          <div class="financial-report-table-wrapper">
            <table class="financial-report-table">
              <thead>
                <tr>
                  <th>Chỉ tiêu</th>
                  <th class="value-col">Quý này</th>
                  <th class="value-col">Năm trước</th>
                  <th class="change-col">Thay đổi</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of formattedFinancialReport()">
                  <td class="label-cell">{{ item.label }}</td>
                  <td class="value-cell">{{ formatLargeNumber(item.value) }}</td>
                  <td class="value-cell year-value">{{ formatLargeNumber(item.yearValue) }}</td>
                  <td class="change-cell" [class.positive]="item.change > 0" [class.negative]="item.change < 0">
                    <span class="change-value">{{ item.change >= 0 ? '+' : '' }}{{ formatLargeNumber(item.change) }}</span>
                    <span class="change-percent">({{ item.changePercent >= 0 ? '+' : '' }}{{ item.changePercent | number:'1.1-1' }}%)</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Same Sector Stocks (also in financial tab) -->
        <section class="section" *ngIf="formattedSameSectorStocks().length > 0">
          <h3>
            <i class="pi pi-sitemap"></i>
            Cổ phiếu cùng ngành ({{ formattedSameSectorStocks().length }})
            <span class="checking-indicator" *ngIf="isCheckingSameSectorStocks()">
              <i class="pi pi-spin pi-spinner"></i> Đang kiểm tra...
            </span>
          </h3>
          <div class="same-sector-stocks-list">
            <div
              *ngFor="let stock of formattedSameSectorStocks()"
              class="sector-stock-row"
              [class.fetched]="stock.isFetched === true"
              [class.checking]="stock.isFetched === 'checking'"
              (click)="navigateToStock(stock.symbol)">
              <div class="stock-info">
                <span class="stock-symbol">{{ stock.symbol }}</span>
                <span class="stock-name">{{ stock.name || stock.shortName }}</span>
              </div>
              <div class="stock-actions">
                <span class="fetch-status checking" *ngIf="stock.isFetched === 'checking'">
                  <i class="pi pi-spin pi-spinner"></i> Đang kiểm tra
                </span>
                <span class="fetch-status" *ngIf="stock.isFetched === true">
                  <i class="pi pi-check-circle"></i> Đã có dữ liệu
                </span>
                <span class="fetch-status pending" *ngIf="stock.isFetched === false">
                  <i class="pi pi-times-circle"></i> Chưa có dữ liệu
                </span>
                <button class="btn-view">
                  <i class="pi pi-eye"></i>
                  Xem
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Trading Tab -->
      <div *ngIf="activeTab() === 'trading' && !isLoadingDetail()">
        <!-- Trading Info -->
        <section class="section" *ngIf="selectedSymbol()?.basicInfo">
          <h3>Thông tin giao dịch</h3>
          <div class="trading-info-grid">
            <div class="trading-info-item" *ngIf="selectedSymbol()?.basicInfo?.matchPrice">
              <label>Giá khớp</label>
              <span class="price-value">{{ (parseFloat(selectedSymbol()!.basicInfo!.matchPrice) * 1000) | number:'1.0-0' }} đ</span>
            </div>
            <div class="trading-info-item" *ngIf="selectedSymbol()?.basicInfo?.changedValue">
              <label>Thay đổi</label>
              <span [class]="parseFloat(selectedSymbol()!.basicInfo!.changedValue) >= 0 ? 'positive' : 'negative'">
                {{ (parseFloat(selectedSymbol()!.basicInfo!.changedValue) * 1000) | number:'1.0-0' }} đ
                ({{ selectedSymbol()?.basicInfo?.changedRatio || '0' }}%)
              </span>
            </div>
            <div class="trading-info-item" *ngIf="selectedSymbol()?.basicInfo?.totalVolume">
              <label>Khối lượng</label>
              <span>{{ selectedSymbol()?.basicInfo?.totalVolume | number:'1.0-0' }}</span>
            </div>
            <div class="trading-info-item" *ngIf="getCompanyField('capital')">
              <label>Vốn điều lệ</label>
              <span>{{ (getCompanyField('capital') / 1000000) | number:'1.0-0' }} triệu đồng</span>
            </div>
          </div>
        </section>

        <!-- Trading Statistics -->
        <section class="section" *ngIf="selectedSymbolPriceData()">
          <h3>Thống kê giao dịch</h3>
          <div class="trading-stats-grid">
            <div class="stat-card">
              <label>Giá cao nhất</label>
              <span class="stat-value">{{ getHighestPrice() | number:'1.0-0' }} đ</span>
            </div>
            <div class="stat-card">
              <label>Giá thấp nhất</label>
              <span class="stat-value">{{ getLowestPrice() | number:'1.0-0' }} đ</span>
            </div>
            <div class="stat-card">
              <label>Giá trung bình</label>
              <span class="stat-value">{{ getAveragePrice() | number:'1.0-0' }} đ</span>
            </div>
            <div class="stat-card">
              <label>Tổng khối lượng</label>
              <span class="stat-value">{{ getTotalVolumeDisplay() | number:'1.0-0' }}</span>
            </div>
          </div>
        </section>

        <!-- Company Info from ticker -->
        <section class="section" *ngIf="getCompanyInfo()">
          <h3>Chi tiết công ty</h3>
          <div class="company-info" [innerHTML]="getCompanyInfoHTML()"></div>
        </section>

        <!-- Neural Network Section -->
        <section class="section">
          <h3>Neural Network Trading</h3>
          <div class="neural-network-section">
            <!-- Model Status from DB -->
            <div class="model-status-bar" *ngIf="modelStatus().exists">
              <div class="status-indicator success">
                <i class="pi pi-check-circle"></i>
                <span>Mô hình đã có trong DB</span>
              </div>
              <div class="status-details">
                <span *ngIf="modelStatus().hasWeights" class="status-tag">
                  <i class="pi pi-database"></i> Weights
                </span>
                <span *ngIf="modelStatus().hasSimulation" class="status-tag">
                  <i class="pi pi-chart-bar"></i> Simulation
                </span>
              </div>
            </div>

            <div class="nn-status">
              <div class="nn-status-item">
                <label>Trạng thái:</label>
                <span class="nn-status-badge" [ngClass]="getNNStatusBadgeClass()">
                  {{ getNNStatusText() }}
                </span>
              </div>

              <!-- Training Progress -->
              <div class="nn-training-progress" *ngIf="isNNTraining() && nnTrainingProgress()">
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="(nnTrainingProgress()!.epoch / trainingConfig().epochs) * 100"></div>
                </div>
                <div class="progress-info">
                  <span>Epoch: {{ nnTrainingProgress()!.epoch }}/{{ trainingConfig().epochs }}</span>
                  <span>Loss: {{ nnTrainingProgress()!.loss.toFixed(6) }}</span>
                  <span *ngIf="nnTrainingProgress()?.accuracy">Accuracy: {{ (nnTrainingProgress()!.accuracy! * 100).toFixed(1) }}%</span>
                </div>
              </div>

              <!-- Error Message -->
              <div class="nn-error" *ngIf="nnError()">
                <i class="pi pi-exclamation-triangle"></i>
                <span>{{ nnError() }}</span>
              </div>

              <!-- Training Config Summary & Toggle -->
              <div class="training-config-summary">
                <div class="config-quick-view">
                  <span class="config-tag"><i class="pi pi-sync"></i> {{ trainingConfig().epochs }} epochs</span>
                  <span class="config-tag"><i class="pi pi-calendar"></i> {{ trainingConfig().lookbackDays }} ngày</span>
                  <span class="config-tag"><i class="pi pi-percentage"></i> {{ (trainingConfig().validationSplit * 100).toFixed(0) }}% val</span>
                </div>
                <button
                  class="btn btn-config"
                  (click)="showTrainingConfig.set(true)">
                  <i class="pi pi-cog"></i>
                  Cấu hình
                </button>
              </div>

              <!-- Training Config Dialog -->
              <div class="fullscreen-dialog-overlay" *ngIf="showTrainingConfig()" (click)="showTrainingConfig.set(false)">
                <div class="fullscreen-dialog training-config-dialog" (click)="$event.stopPropagation()">
                  <div class="dialog-header">
                    <h3><i class="pi pi-sliders-h"></i> Cấu hình huấn luyện mô hình</h3>
                    <button class="btn-close" (click)="showTrainingConfig.set(false)">
                      <i class="pi pi-times"></i>
                    </button>
                  </div>
                  <div class="dialog-body">
                    <p class="config-description">Điều chỉnh các thông số để tối ưu mô hình Neural Network.</p>

                    <!-- Presets -->
                    <div class="config-presets-section">
                      <h4>Chọn nhanh</h4>
                      <div class="preset-buttons">
                        <button class="btn-preset-card" (click)="applyTrainingPreset('fast')">
                          <i class="pi pi-bolt"></i>
                          <span class="preset-name">Nhanh</span>
                          <span class="preset-desc">30 epochs, 30 ngày</span>
                        </button>
                        <button class="btn-preset-card active" (click)="applyTrainingPreset('balanced')">
                          <i class="pi pi-sliders-h"></i>
                          <span class="preset-name">Cân bằng</span>
                          <span class="preset-desc">50 epochs, 60 ngày</span>
                        </button>
                        <button class="btn-preset-card" (click)="applyTrainingPreset('accurate')">
                          <i class="pi pi-check-circle"></i>
                          <span class="preset-name">Chính xác</span>
                          <span class="preset-desc">100 epochs, 90 ngày</span>
                        </button>
                      </div>
                    </div>

                    <!-- Advanced Config -->
                    <div class="config-advanced-section">
                      <h4>Cấu hình chi tiết</h4>
                      <div class="config-grid-dialog">
                        <!-- Epochs -->
                        <div class="config-field">
                          <div class="field-header">
                            <label>{{ trainingConfigDescriptions.epochs.label }}</label>
                            <span class="field-value">{{ trainingConfig().epochs }}</span>
                          </div>
                          <input
                            type="range"
                            [value]="trainingConfig().epochs"
                            [min]="trainingConfigDescriptions.epochs.min"
                            [max]="trainingConfigDescriptions.epochs.max"
                            [step]="trainingConfigDescriptions.epochs.step"
                            (input)="updateTrainingConfig({ epochs: +$any($event.target).value })">
                          <p class="field-hint">{{ trainingConfigDescriptions.epochs.description }}</p>
                        </div>

                        <!-- Lookback Days -->
                        <div class="config-field">
                          <div class="field-header">
                            <label>{{ trainingConfigDescriptions.lookbackDays.label }}</label>
                            <span class="field-value">{{ trainingConfig().lookbackDays }} ngày</span>
                          </div>
                          <input
                            type="range"
                            [value]="trainingConfig().lookbackDays"
                            [min]="trainingConfigDescriptions.lookbackDays.min"
                            [max]="trainingConfigDescriptions.lookbackDays.max"
                            [step]="trainingConfigDescriptions.lookbackDays.step"
                            (input)="updateTrainingConfig({ lookbackDays: +$any($event.target).value })">
                          <p class="field-hint">{{ trainingConfigDescriptions.lookbackDays.description }}</p>
                        </div>

                        <!-- Batch Size -->
                        <div class="config-field">
                          <div class="field-header">
                            <label>{{ trainingConfigDescriptions.batchSize.label }}</label>
                            <span class="field-value">{{ trainingConfig().batchSize }}</span>
                          </div>
                          <input
                            type="range"
                            [value]="trainingConfig().batchSize"
                            [min]="trainingConfigDescriptions.batchSize.min"
                            [max]="trainingConfigDescriptions.batchSize.max"
                            [step]="trainingConfigDescriptions.batchSize.step"
                            (input)="updateTrainingConfig({ batchSize: +$any($event.target).value })">
                          <p class="field-hint">{{ trainingConfigDescriptions.batchSize.description }}</p>
                        </div>

                        <!-- Validation Split -->
                        <div class="config-field">
                          <div class="field-header">
                            <label>{{ trainingConfigDescriptions.validationSplit.label }}</label>
                            <span class="field-value">{{ (trainingConfig().validationSplit * 100).toFixed(0) }}%</span>
                          </div>
                          <input
                            type="range"
                            [value]="trainingConfig().validationSplit"
                            [min]="trainingConfigDescriptions.validationSplit.min"
                            [max]="trainingConfigDescriptions.validationSplit.max"
                            [step]="trainingConfigDescriptions.validationSplit.step"
                            (input)="updateTrainingConfig({ validationSplit: +$any($event.target).value })">
                          <p class="field-hint">{{ trainingConfigDescriptions.validationSplit.description }}</p>
                        </div>

                        <!-- Learning Rate -->
                        <div class="config-field">
                          <div class="field-header">
                            <label>{{ trainingConfigDescriptions.learningRate.label }}</label>
                            <span class="field-value">{{ trainingConfig().learningRate }}</span>
                          </div>
                          <input
                            type="range"
                            [value]="trainingConfig().learningRate"
                            [min]="trainingConfigDescriptions.learningRate.min"
                            [max]="trainingConfigDescriptions.learningRate.max"
                            [step]="trainingConfigDescriptions.learningRate.step"
                            (input)="updateTrainingConfig({ learningRate: +$any($event.target).value })">
                          <p class="field-hint">{{ trainingConfigDescriptions.learningRate.description }}</p>
                        </div>

                        <!-- Forecast Days -->
                        <div class="config-field">
                          <div class="field-header">
                            <label>{{ trainingConfigDescriptions.forecastDays.label }}</label>
                            <span class="field-value">{{ trainingConfig().forecastDays }} ngày</span>
                          </div>
                          <input
                            type="range"
                            [value]="trainingConfig().forecastDays"
                            [min]="trainingConfigDescriptions.forecastDays.min"
                            [max]="trainingConfigDescriptions.forecastDays.max"
                            [step]="trainingConfigDescriptions.forecastDays.step"
                            (input)="updateTrainingConfig({ forecastDays: +$any($event.target).value })">
                          <p class="field-hint">{{ trainingConfigDescriptions.forecastDays.description }}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="dialog-footer">
                    <button class="btn btn-secondary" (click)="resetTrainingConfig()">
                      <i class="pi pi-refresh"></i> Đặt lại mặc định
                    </button>
                    <button class="btn btn-primary" (click)="showTrainingConfig.set(false)">
                      <i class="pi pi-check"></i> Xong
                    </button>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="nn-actions" *ngIf="selectedSymbolPriceData()">
                <div class="nn-actions-row">
                  <button
                    class="btn-train"
                    (click)="trainNeuralNetwork()"
                    [disabled]="isNNTraining() || !hasEnoughDataForTraining()">
                    <i class="pi" [ngClass]="isNNTraining() ? 'pi-spin pi-spinner' : 'pi-cog'"></i>
                    {{ isNNTraining() ? 'Đang huấn luyện...' : 'Huấn luyện mô hình' }}
                  </button>
                  <button
                    class="btn-predict"
                    (click)="predictWithNeuralNetwork()"
                    [disabled]="!isNNReady() || isNNTraining()">
                    <i class="pi pi-chart-line"></i>
                    Dự đoán giá
                  </button>
                </div>
                <div class="nn-actions-row">
                  <button
                    class="btn-reload"
                    (click)="reloadDataAndRetrain()"
                    [disabled]="isNNTraining() || isLoadingPrice()">
                    <i class="pi" [ngClass]="isLoadingPrice() ? 'pi-spin pi-spinner' : 'pi-refresh'"></i>
                    {{ isLoadingPrice() ? 'Đang tải...' : 'Reload & Train lại' }}
                  </button>
                  <button
                    class="btn-load"
                    (click)="loadSavedWeights()"
                    [disabled]="isNNTraining()"
                    [class.has-model]="modelStatus().hasWeights">
                    <i class="pi pi-download"></i>
                    {{ modelStatus().hasWeights ? 'Load từ DB' : 'Load mô hình đã lưu' }}
                  </button>
                </div>
              </div>

              <!-- Prediction Results -->
              <div class="nn-prediction" *ngIf="nnPrediction()">
                <h4>Kết quả dự đoán</h4>
                <div class="prediction-grid">
                  <div class="prediction-item">
                    <label>Giá hiện tại:</label>
                    <span class="price-value">{{ formatPredictionPrice(getLatestClosePrice()) }}</span>
                  </div>
                  <div class="prediction-item">
                    <label>Dự đoán ngày mai:</label>
                    <span class="price-value" [ngClass]="getTrendColorClass(nnPrediction()!.trend)">
                      {{ formatPredictionPrice(nnPrediction()!.predictedPrice) }}
                      <i class="pi" [ngClass]="getTrendIconClass(nnPrediction()!.trend)"></i>
                    </span>
                  </div>
                  <div class="prediction-item" *ngIf="nnPrediction()!.nextWeekPrediction">
                    <label>Dự đoán 1 tuần:</label>
                    <span class="price-value">{{ formatPredictionPrice(nnPrediction()!.nextWeekPrediction!) }}</span>
                  </div>
                  <div class="prediction-item" *ngIf="nnPrediction()!.nextMonthPrediction">
                    <label>Dự đoán 1 tháng:</label>
                    <span class="price-value">{{ formatPredictionPrice(nnPrediction()!.nextMonthPrediction!) }}</span>
                  </div>
                  <div class="prediction-item">
                    <label>Độ tin cậy:</label>
                    <span class="confidence-value">{{ formatConfidence(nnPrediction()!.confidence) }}</span>
                  </div>
                  <div class="prediction-item">
                    <label>Xu hướng:</label>
                    <span class="trend-badge" [ngClass]="getTrendColorClass(nnPrediction()!.trend)">
                      {{ nnPrediction()!.trend === 'up' ? 'Tăng' : nnPrediction()!.trend === 'down' ? 'Giảm' : 'Ổn định' }}
                    </span>
                  </div>
                  <div class="prediction-item" *ngIf="nnPrediction()!.tradingDecision">
                    <label>Quyết định giao dịch:</label>
                    <span class="trading-decision-badge" [ngClass]="'decision-' + nnPrediction()!.tradingDecision!.action">
                      {{ nnPrediction()!.tradingDecision!.action === 'buy' ? 'MUA' : nnPrediction()!.tradingDecision!.action === 'sell' ? 'BÁN' : 'GIỮ' }}
                      <span class="decision-confidence">({{ (nnPrediction()!.tradingDecision!.confidence * 100).toFixed(1) }}%)</span>
                    </span>
                    <div class="decision-reason">{{ nnPrediction()!.tradingDecision!.reason }}</div>
                  </div>
                </div>
              </div>

              <!-- Info -->
              <div class="nn-info" *ngIf="!nnPrediction() && !isNNTraining()">
                <p>Hệ thống Neural Network sử dụng mô hình deep learning để phân tích dữ liệu lịch sử và dự đoán giá cổ phiếu.</p>
                <p class="nn-note">
                  <i class="pi pi-info-circle"></i>
                  Cần ít nhất 100 ngày dữ liệu để huấn luyện mô hình. Sau khi huấn luyện, bạn có thể sử dụng để dự đoán giá trong tương lai.
                </p>
              </div>
            </div>
          </div>

          <!-- Prediction Comparison Table -->
          <div class="nn-comparison-section" *ngIf="isNNReady()">
            <div class="section-header">
              <h4>So sánh dự đoán vs thực tế (10 phiên gần đây)</h4>
              <button
                class="btn btn-small"
                (click)="loadPredictionComparison()"
                [disabled]="isLoadingComparison() || isNNTraining()">
                <i class="pi" [ngClass]="isLoadingComparison() ? 'pi-spin pi-spinner' : 'pi-refresh'"></i>
                {{ isLoadingComparison() ? 'Đang tải...' : 'Tải so sánh' }}
              </button>
            </div>

            <div class="comparison-table-wrapper" *ngIf="nnPredictionComparison()">
              <table class="comparison-table">
                <thead>
                  <tr>
                    <th>Ngày</th>
                    <th>Giá dự đoán</th>
                    <th>Giá thực tế</th>
                    <th>Sai số</th>
                    <th>% Sai số</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let comp of nnPredictionComparison()" [ngClass]="getComparisonRowClass(comp.errorPercent)">
                    <td>{{ comp.dateStr }}</td>
                    <td>{{ formatPredictionPrice(comp.predictedPrice) }}</td>
                    <td>{{ formatPredictionPrice(comp.actualPrice) }}</td>
                    <td [ngClass]="comp.error >= 0 ? 'positive' : 'negative'">
                      {{ formatCurrency(comp.error) }}
                    </td>
                    <td [ngClass]="comp.errorPercent >= 0 ? 'positive' : 'negative'">
                      {{ comp.errorPercent >= 0 ? '+' : '' }}{{ comp.errorPercent.toFixed(2) }}%
                    </td>
                  </tr>
                </tbody>
                <tfoot *ngIf="nnPredictionComparison() && nnPredictionComparison()!.length > 0">
                  <tr>
                    <td><strong>Trung bình</strong></td>
                    <td></td>
                    <td></td>
                    <td [ngClass]="getAverageError() >= 0 ? 'positive' : 'negative'">
                      {{ formatCurrency(getAverageError()) }}
                    </td>
                    <td [ngClass]="getAverageErrorClass()">
                      {{ getAverageErrorPercent().toFixed(2) }}%
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="no-comparison" *ngIf="!nnPredictionComparison() && !isLoadingComparison()">
              <p>Chưa có dữ liệu so sánh. Nhấn "Tải so sánh" để xem kết quả.</p>
            </div>
          </div>
        </section>

        <!-- Trading Simulation Section -->
        <section class="section backtest-section">
          <h3>Mô phỏng Giao dịch (Backtesting)</h3>

          <!-- Backtest Sub-tabs -->
          <div class="backtest-tabs">
            <button
              class="backtest-tab-btn"
              [class.active]="backtestActiveTab() === 'setup'"
              (click)="backtestActiveTab.set('setup')">
              <i class="pi pi-cog"></i>
              <span>Thiết lập</span>
            </button>
            <button
              class="backtest-tab-btn"
              [class.active]="backtestActiveTab() === 'results'"
              (click)="backtestActiveTab.set('results')"
              [disabled]="!tradingResult()">
              <i class="pi pi-chart-bar"></i>
              <span>Kết quả</span>
              <span class="badge-count" *ngIf="tradingResult()">{{ tradingResult()!.totalTrades }}</span>
            </button>
            <button
              class="backtest-tab-btn"
              [class.active]="backtestActiveTab() === 'chart'"
              (click)="backtestActiveTab.set('chart')"
              [disabled]="!tradingResult()">
              <i class="pi pi-chart-line"></i>
              <span>Biểu đồ</span>
            </button>
          </div>

          <div class="trading-simulation-section">
            <!-- TAB 1: SETUP -->
            <div class="backtest-tab-content" *ngIf="backtestActiveTab() === 'setup'">
              <!-- Date Range Selection -->
              <div class="date-range-config" *ngIf="selectedSymbolPriceData()">
                <h4>Chọn vùng ngày để testing</h4>
                <div class="date-range-inputs">
                  <div class="date-input-item">
                    <label>Ngày bắt đầu:</label>
                    <input
                      type="date"
                      [value]="backtestStartDate()"
                      [min]="getAvailableDateRange()?.minDate"
                      [max]="getAvailableDateRange()?.maxDate"
                      (change)="backtestStartDate.set($any($event.target).value)"
                      (focus)="initializeDateRange()">
                  </div>
                  <div class="date-input-item">
                    <label>Ngày kết thúc:</label>
                    <input
                      type="date"
                      [value]="backtestEndDate()"
                      [min]="getAvailableDateRange()?.minDate"
                      [max]="getAvailableDateRange()?.maxDate"
                      (change)="backtestEndDate.set($any($event.target).value)"
                      (focus)="initializeDateRange()">
                  </div>
                  <div class="date-input-item">
                    <label>Khoảng thời gian:</label>
                    <button
                      class="btn-quick-range"
                      (click)="backtestStartDate.set(getAvailableDateRange()?.minDate || ''); backtestEndDate.set(getAvailableDateRange()?.maxDate || '')">
                      <i class="pi pi-calendar"></i>
                      Toàn bộ
                    </button>
                  </div>
                </div>
                <div class="date-range-info" *ngIf="getAvailableDateRange()">
                  <span class="info-text">
                    <i class="pi pi-info-circle"></i>
                    Dữ liệu có sẵn: {{ getFormattedMinDate() }} đến {{ getFormattedMaxDate() }}
                  </span>
                </div>
              </div>

              <!-- Strategy Selection -->
              <div class="strategy-selection">
                <h4>Chọn chiến lược giao dịch</h4>
                <div class="strategy-grid">
                  <div class="strategy-card"
                       *ngFor="let strategy of availableStrategies"
                       [class.active]="tradingConfig().strategy === strategy"
                       (click)="updateTradingStrategy(strategy)">
                    <div class="strategy-icon">
                      <i class="pi" [ngClass]="{
                        'pi-brain': strategy === 'neural_network',
                        'pi-chart-line': strategy === 'ma_crossover' || strategy === 'ema_crossover',
                        'pi-percentage': strategy === 'rsi',
                        'pi-chart-bar': strategy === 'macd',
                        'pi-chart-scatter': strategy === 'bollinger_bands'
                      }"></i>
                    </div>
                    <div class="strategy-info">
                      <span class="strategy-name">{{ strategyDescriptions[strategy].name }}</span>
                      <span class="strategy-desc">{{ strategyDescriptions[strategy].description }}</span>
                    </div>
                    <div class="strategy-check" *ngIf="tradingConfig().strategy === strategy">
                      <i class="pi pi-check-circle"></i>
                    </div>
                  </div>
                </div>

                <!-- Strategy-specific configuration -->
                <div class="strategy-config" *ngIf="tradingConfig().strategy !== 'neural_network'">
                  <!-- MA Crossover Config -->
                  <div class="strategy-params" *ngIf="tradingConfig().strategy === 'ma_crossover' || tradingConfig().strategy === 'ema_crossover'">
                    <div class="param-item">
                      <label>MA ngắn hạn:</label>
                      <input type="number" [value]="tradingConfig().strategyConfig.maShortPeriod"
                             (input)="updateStrategyConfig({ maShortPeriod: +$any($event.target).value })"
                             min="5" max="50" step="1">
                    </div>
                    <div class="param-item">
                      <label>MA dài hạn:</label>
                      <input type="number" [value]="tradingConfig().strategyConfig.maLongPeriod"
                             (input)="updateStrategyConfig({ maLongPeriod: +$any($event.target).value })"
                             min="10" max="200" step="1">
                    </div>
                  </div>

                  <!-- RSI Config -->
                  <div class="strategy-params" *ngIf="tradingConfig().strategy === 'rsi'">
                    <div class="param-item">
                      <label>Chu kỳ RSI:</label>
                      <input type="number" [value]="tradingConfig().strategyConfig.rsiPeriod"
                             (input)="updateStrategyConfig({ rsiPeriod: +$any($event.target).value })"
                             min="5" max="30" step="1">
                    </div>
                    <div class="param-item">
                      <label>Ngưỡng quá mua:</label>
                      <input type="number" [value]="tradingConfig().strategyConfig.rsiOverbought"
                             (input)="updateStrategyConfig({ rsiOverbought: +$any($event.target).value })"
                             min="60" max="90" step="5">
                    </div>
                    <div class="param-item">
                      <label>Ngưỡng quá bán:</label>
                      <input type="number" [value]="tradingConfig().strategyConfig.rsiOversold"
                             (input)="updateStrategyConfig({ rsiOversold: +$any($event.target).value })"
                             min="10" max="40" step="5">
                    </div>
                  </div>

                  <!-- MACD Config -->
                  <div class="strategy-params" *ngIf="tradingConfig().strategy === 'macd'">
                    <div class="param-item">
                      <label>EMA nhanh:</label>
                      <input type="number" [value]="tradingConfig().strategyConfig.macdFastPeriod"
                             (input)="updateStrategyConfig({ macdFastPeriod: +$any($event.target).value })"
                             min="5" max="20" step="1">
                    </div>
                    <div class="param-item">
                      <label>EMA chậm:</label>
                      <input type="number" [value]="tradingConfig().strategyConfig.macdSlowPeriod"
                             (input)="updateStrategyConfig({ macdSlowPeriod: +$any($event.target).value })"
                             min="15" max="50" step="1">
                    </div>
                    <div class="param-item">
                      <label>Signal Line:</label>
                      <input type="number" [value]="tradingConfig().strategyConfig.macdSignalPeriod"
                             (input)="updateStrategyConfig({ macdSignalPeriod: +$any($event.target).value })"
                             min="5" max="15" step="1">
                    </div>
                  </div>

                  <!-- Bollinger Bands Config -->
                  <div class="strategy-params" *ngIf="tradingConfig().strategy === 'bollinger_bands'">
                    <div class="param-item">
                      <label>Chu kỳ:</label>
                      <input type="number" [value]="tradingConfig().strategyConfig.bbPeriod"
                             (input)="updateStrategyConfig({ bbPeriod: +$any($event.target).value })"
                             min="10" max="50" step="1">
                    </div>
                    <div class="param-item">
                      <label>Độ lệch chuẩn:</label>
                      <input type="number" [value]="tradingConfig().strategyConfig.bbStdDev"
                             (input)="updateStrategyConfig({ bbStdDev: +$any($event.target).value })"
                             min="1" max="4" step="0.5">
                    </div>
                  </div>
                </div>

                <!-- NN requirement notice -->
                <div class="nn-notice" *ngIf="tradingConfig().strategy === 'neural_network' && !nnService.isReady()">
                  <i class="pi pi-exclamation-triangle"></i>
                  <span>Chiến lược Neural Network yêu cầu huấn luyện mô hình trước. Hãy chuyển sang tab "Mạng Neural" để huấn luyện.</span>
                </div>
              </div>

              <!-- Configuration -->
              <div class="simulation-config">
                <h4>Cấu hình giao dịch</h4>
                <div class="config-grid">
                  <div class="config-item capital-config">
                    <label>Vốn ban đầu (đồng):</label>
                    <input
                      type="text"
                      [value]="tradingConfig().initialCapital | number:'1.0-0'"
                      (input)="updateTradingConfig({ initialCapital: parseCapitalInput($any($event.target).value) })"
                      (blur)="formatCapitalInput($event)"
                      class="capital-input">
                    <div class="capital-helper" *ngIf="tradingConfig().initialCapital > 0">
                      <i class="pi pi-info-circle"></i>
                      <span>{{ getInitialCapitalText() }}</span>
                    </div>
                    <div class="capital-presets">
                      <button type="button" (click)="updateTradingConfig({ initialCapital: 50000000 })"
                              [class.active]="tradingConfig().initialCapital === 50000000">50M</button>
                      <button type="button" (click)="updateTradingConfig({ initialCapital: 100000000 })"
                              [class.active]="tradingConfig().initialCapital === 100000000">100M</button>
                      <button type="button" (click)="updateTradingConfig({ initialCapital: 200000000 })"
                              [class.active]="tradingConfig().initialCapital === 200000000">200M</button>
                      <button type="button" (click)="updateTradingConfig({ initialCapital: 500000000 })"
                              [class.active]="tradingConfig().initialCapital === 500000000">500M</button>
                      <button type="button" (click)="updateTradingConfig({ initialCapital: 1000000000 })"
                              [class.active]="tradingConfig().initialCapital === 1000000000">1B</button>
                    </div>
                  </div>
                  <div class="config-item">
                    <label>Cắt lỗ (%):</label>
                    <input
                      type="number"
                      [value]="tradingConfig().stopLossPercent"
                      (input)="updateTradingConfig({ stopLossPercent: +$any($event.target).value })"
                      min="1"
                      max="20"
                      step="0.5">
                  </div>
                  <div class="config-item">
                    <label>Chốt lời (%):</label>
                    <input
                      type="number"
                      [value]="tradingConfig().takeProfitPercent"
                      (input)="updateTradingConfig({ takeProfitPercent: +$any($event.target).value })"
                      min="0"
                      max="50"
                      step="0.5">
                    <small style="font-size: 11px; color: #6c757d;">
                      {{ tradingConfig().takeProfitPercent === 0 ? '🔄 Tự động tối ưu điểm bán theo tín hiệu' : '📍 Chốt lời cố định ' + tradingConfig().takeProfitPercent + '%' }}
                    </small>
                  </div>
                  <div class="config-item trailing-stop-config">
                    <label>
                      <input type="checkbox"
                             [checked]="tradingConfig().useTrailingStop"
                             (change)="updateTradingConfig({ useTrailingStop: $any($event.target).checked })">
                      Trailing Stop
                    </label>
                    <div class="trailing-input" *ngIf="tradingConfig().useTrailingStop">
                      <input
                        type="number"
                        [value]="tradingConfig().trailingStopPercent"
                        (input)="updateTradingConfig({ trailingStopPercent: +$any($event.target).value })"
                        min="1"
                        max="20"
                        step="0.5">
                      <span>%</span>
                    </div>
                    <small style="font-size: 11px; color: #6c757d;">
                      {{ tradingConfig().useTrailingStop ? '📈 Cắt lỗ di động từ đỉnh giá' : '❌ Tắt trailing stop' }}
                    </small>
                  </div>
                  <div class="config-item">
                    <label>Số vị thế tối đa:</label>
                    <input
                      type="number"
                      [value]="tradingConfig().maxPositions"
                      (input)="updateTradingConfig({ maxPositions: +$any($event.target).value })"
                      min="1"
                      max="10"
                      step="1">
                    <small style="font-size: 11px; color: #6c757d;">Số lần có thể mua đồng thời (tăng để mua bán liên tục)</small>
                  </div>
                  <div class="config-item">
                    <label>T+ (ngày):</label>
                    <input
                      type="number"
                      [value]="tradingConfig().tPlusDays"
                      (input)="updateTradingConfig({ tPlusDays: +$any($event.target).value })"
                      min="0"
                      max="5"
                      step="1">
                    <small style="font-size: 11px; color: #6c757d;">Số ngày phải đợi sau khi mua mới được bán (T+2 = 2 ngày)</small>
                  </div>
                </div>
                <div class="simulation-actions">
                  <button
                    class="btn-simulate"
                    (click)="runTradingSimulation()"
                    [disabled]="(isNeuralNetworkStrategy() && !isNNReady()) || isRunningSimulation() || isNNTraining()">
                    <i class="pi" [ngClass]="isRunningSimulation() ? 'pi-spin pi-spinner' : 'pi-play'"></i>
                    {{ isRunningSimulation() ? 'Đang chạy...' : 'Chạy mô phỏng' }}
                  </button>
                  <button
                    class="btn btn-load"
                    (click)="loadSavedSimulationResult()"
                    [disabled]="!selectedSymbol()">
                    <i class="pi pi-download"></i>
                    Load kết quả đã lưu
                  </button>
                </div>
              </div>
            </div>

            <!-- TAB 2: RESULTS -->
            <div class="backtest-tab-content" *ngIf="backtestActiveTab() === 'results'">
              <div class="simulation-results" *ngIf="tradingResult()">
                <!-- Summary Stats -->
                <div class="results-summary">
                  <div class="stat-card profit" [ngClass]="tradingResult()!.totalProfit >= 0 ? 'positive' : 'negative'">
                    <label>Lãi/Lỗ:</label>
                    <div class="stat-value">{{ formatCurrency(tradingResult()!.totalProfit) }}</div>
                    <div class="stat-percent">{{ tradingResult()!.totalProfitPercent >= 0 ? '+' : '' }}{{ tradingResult()!.totalProfitPercent.toFixed(2) }}%</div>
                  </div>
                  <div class="stat-card">
                    <label>Vốn ban đầu:</label>
                    <div class="stat-value">{{ formatCurrency(tradingResult()!.initialCapital) }}</div>
                  </div>
                  <div class="stat-card">
                    <label>Vốn cuối:</label>
                    <div class="stat-value">{{ formatCurrency(tradingResult()!.finalCapital) }}</div>
                  </div>
                  <div class="stat-card">
                    <label>Tổng giao dịch:</label>
                    <div class="stat-value">{{ tradingResult()!.totalTrades }}</div>
                  </div>
                  <div class="stat-card">
                    <label>Thắng:</label>
                    <div class="stat-value positive">{{ tradingResult()!.winningTrades }}</div>
                  </div>
                  <div class="stat-card">
                    <label>Thua:</label>
                    <div class="stat-value negative">{{ tradingResult()!.losingTrades }}</div>
                  </div>
                  <div class="stat-card">
                    <label>Tỷ lệ thắng:</label>
                    <div class="stat-value">{{ tradingResult()!.winRate.toFixed(2) }}%</div>
                  </div>
                  <div class="stat-card">
                    <label>Drawdown tối đa:</label>
                    <div class="stat-value negative">{{ formatCurrency(tradingResult()!.maxDrawdown) }}</div>
                    <div class="stat-percent">{{ tradingResult()!.maxDrawdownPercent.toFixed(2) }}%</div>
                  </div>
                </div>

                <!-- Strategy Performance Metrics -->
                <div class="performance-metrics" *ngIf="tradingResult()">
                  <h5>📊 Đánh giá hiệu suất chiến lược</h5>
                  <div class="metrics-grid">
                    <div class="metric-card">
                      <label>Chiến lược:</label>
                      <div class="metric-value strategy-name">{{ getStrategyDisplayName(tradingResult()!.strategy) }}</div>
                    </div>
                    <div class="metric-card">
                      <label>Sharpe Ratio:</label>
                      <div class="metric-value" [ngClass]="getSharpeRatioClass(tradingResult()!)">
                        {{ calculateSharpeRatio(tradingResult()!).toFixed(2) }}
                      </div>
                      <small>{{ getSharpeRatioLabel(tradingResult()!) }}</small>
                    </div>
                    <div class="metric-card">
                      <label>Profit Factor:</label>
                      <div class="metric-value" [ngClass]="getProfitFactorClass(tradingResult()!)">
                        {{ calculateProfitFactor(tradingResult()!).toFixed(2) }}
                      </div>
                      <small>{{ getProfitFactorLabel(tradingResult()!) }}</small>
                    </div>
                    <div class="metric-card">
                      <label>Lãi TB/GD:</label>
                      <div class="metric-value" [ngClass]="tradingResult()!.avgWinAmount > 0 ? 'positive' : ''">
                        {{ formatCurrency(tradingResult()!.avgWinAmount || 0) }}
                      </div>
                    </div>
                    <div class="metric-card">
                      <label>Lỗ TB/GD:</label>
                      <div class="metric-value negative">
                        {{ formatCurrency(tradingResult()!.avgLossAmount || 0) }}
                      </div>
                    </div>
                    <div class="metric-card">
                      <label>Recovery Factor:</label>
                      <div class="metric-value" [ngClass]="getRecoveryFactorClass(tradingResult()!)">
                        {{ calculateRecoveryFactor(tradingResult()!).toFixed(2) }}
                      </div>
                      <small>Khả năng phục hồi từ drawdown</small>
                    </div>
                    <div class="metric-card">
                      <label>Expectancy:</label>
                      <div class="metric-value" [ngClass]="calculateExpectancy(tradingResult()!) >= 0 ? 'positive' : 'negative'">
                        {{ formatCurrency(calculateExpectancy(tradingResult()!)) }}
                      </div>
                      <small>Kỳ vọng lợi nhuận/giao dịch</small>
                    </div>
                    <div class="metric-card">
                      <label>Thời gian nắm giữ TB:</label>
                      <div class="metric-value">
                        {{ calculateAvgHoldingDays(tradingResult()!).toFixed(1) }} ngày
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Transactions List -->
                <div class="transactions-list" *ngIf="transactions().length > 0">
                  <h5>Lịch sử giao dịch ({{ transactions().length }})</h5>
                  <div class="transactions-table-wrapper">
                    <table class="transactions-table">
                      <thead>
                        <tr>
                          <th>Ngày</th>
                          <th>Loại</th>
                          <th>Số lượng</th>
                          <th>Giá GD</th>
                          <th>Tiền GD</th>
                          <th>Tổng CP</th>
                          <th>Giá TB</th>
                          <th>Tiền còn</th>
                          <th>Nắm giữ</th>
                          <th>Lãi/Lỗ</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let tx of transactions()"
                            [ngClass]="{
                              'transaction-buy': tx.type === 'buy',
                              'transaction-sell': tx.type === 'sell',
                              'transaction-loss': tx.type === 'sell' && tx.profit !== undefined && tx.profit < 0,
                              'transaction-profit': tx.type === 'sell' && tx.profit !== undefined && tx.profit > 0
                            }">
                          <td class="date-cell">{{ tx.dateStr }}</td>
                          <td>
                            <span class="transaction-type" [ngClass]="'type-' + tx.type">
                              {{ tx.type === 'buy' ? 'MUA' : 'BÁN' }}
                            </span>
                          </td>
                          <td class="quantity-cell">{{ tx.quantity | number:'1.0-0' }}</td>
                          <td class="price-cell">{{ formatPredictionPrice(tx.price) }}</td>
                          <td class="amount-cell" [ngClass]="tx.type === 'buy' ? 'negative' : 'positive'">
                            {{ tx.type === 'buy' ? '-' : '+' }}{{ formatCurrency(tx.transactionAmount) }}
                          </td>
                          <td class="shares-cell">
                            <span class="shares-change">{{ tx.totalSharesBefore | number:'1.0-0' }} → {{ tx.totalSharesAfter | number:'1.0-0' }}</span>
                          </td>
                          <td class="avg-price-cell">
                            {{ tx.avgPriceAfter > 0 ? formatPredictionPrice(tx.avgPriceAfter) : '-' }}
                          </td>
                          <td class="capital-cell">{{ formatCurrency(tx.capitalAfter) }}</td>
                          <td class="holding-cell">{{ tx.holdingDays !== undefined ? tx.holdingDays + ' ngày' : '-' }}</td>
                          <td class="profit-cell">
                            <span *ngIf="tx.type === 'sell' && tx.profit !== undefined" [ngClass]="tx.profit >= 0 ? 'positive' : 'negative'">
                              <span class="profit-icon">{{ tx.profit >= 0 ? '✅' : '⚠️' }}</span>
                              {{ tx.profit >= 0 ? '+' : '' }}{{ formatCurrency(tx.profit) }}
                            </span>
                            <span *ngIf="tx.type === 'buy'" class="buy-indicator">-</span>
                          </td>
                        </tr>
                      </tbody>
                      <tfoot>
                        <tr class="summary-row">
                          <td colspan="2" class="summary-label">
                            <strong>TỔNG KẾT</strong>
                          </td>
                          <td class="summary-trades" colspan="3">
                            <span class="trade-count">{{ tradingResult()!.totalTrades }} giao dịch</span>
                            <span class="win-count positive">{{ tradingResult()!.winningTrades }} lãi</span>
                            <span class="loss-count negative">{{ tradingResult()!.losingTrades }} lỗ</span>
                          </td>
                          <td colspan="2" class="summary-amounts">
                            <span class="total-win positive">+{{ formatCurrency(tradingResult()!.totalWinAmount || 0) }}</span>
                            <span class="total-loss negative">-{{ formatCurrency(tradingResult()!.totalLossAmount || 0) }}</span>
                          </td>
                          <td colspan="3" class="summary-net">
                            <strong [ngClass]="tradingResult()!.totalProfit >= 0 ? 'positive' : 'negative'">
                              {{ tradingResult()!.totalProfit >= 0 ? '+' : '' }}{{ formatCurrency(tradingResult()!.totalProfit) }}
                            </strong>
                          </td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>

                <!-- Action buttons -->
                <div class="results-actions">
                  <button class="btn" (click)="backtestActiveTab.set('chart')">
                    <i class="pi pi-chart-line"></i>
                    Xem biểu đồ
                  </button>
                  <button class="btn btn-secondary" (click)="backtestActiveTab.set('setup')">
                    <i class="pi pi-cog"></i>
                    Thay đổi cấu hình
                  </button>
                </div>
              </div>

              <!-- Empty state -->
              <div class="empty-results" *ngIf="!tradingResult()">
                <i class="pi pi-chart-bar"></i>
                <p>Chưa có kết quả mô phỏng</p>
                <button class="btn" (click)="backtestActiveTab.set('setup')">
                  <i class="pi pi-cog"></i>
                  Thiết lập và chạy mô phỏng
                </button>
              </div>
            </div>

            <!-- TAB 3: CHART -->
            <div class="backtest-tab-content backtest-chart-tab" *ngIf="backtestActiveTab() === 'chart'">
              <div class="backtest-chart-container" *ngIf="tradingResult() && selectedSymbolPriceData()">
                <div class="chart-header">
                  <h4>
                    <i class="pi pi-chart-line"></i>
                    Biểu đồ giá với điểm mua/bán
                  </h4>
                  <div class="chart-legend-info">
                    <span class="legend-item buy">
                      <i class="pi pi-arrow-up"></i> Mua
                    </span>
                    <span class="legend-item sell">
                      <i class="pi pi-arrow-down"></i> Bán
                    </span>
                  </div>
                </div>
                <app-tradingview-chart
                  [data]="selectedSymbolPriceData()"
                  [symbol]="selectedSymbol()?.symbol || ''"
                  [markers]="chartMarkers()">
                </app-tradingview-chart>
              </div>

              <!-- Empty state -->
              <div class="empty-results" *ngIf="!tradingResult()">
                <i class="pi pi-chart-line"></i>
                <p>Chưa có kết quả mô phỏng để hiển thị</p>
                <button class="btn" (click)="backtestActiveTab.set('setup')">
                  <i class="pi pi-cog"></i>
                  Thiết lập và chạy mô phỏng
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Recent Week Analysis Section -->
        <section class="section" *ngIf="tradingResult()">
          <h3>Đánh giá 1 tuần gần đây</h3>
          <div class="recent-week-analysis" *ngIf="getRecentWeekAnalysis() as weekAnalysis">

            <!-- Today's Recommendation -->
            <div class="today-recommendation" *ngIf="weekAnalysis.todayRecommendation">
              <h4>Khuyến nghị hôm nay</h4>
              <div class="recommendation-card" [ngClass]="'recommendation-' + weekAnalysis.todayRecommendation.action">
                <div class="recommendation-header">
                  <span class="recommendation-action">
                    {{ weekAnalysis.todayRecommendation.action === 'buy' ? 'MUA' : weekAnalysis.todayRecommendation.action === 'sell' ? 'BÁN' : 'GIỮ' }}
                  </span>
                  <span class="recommendation-confidence">
                    Độ tin cậy: {{ (weekAnalysis.todayRecommendation.confidence * 100).toFixed(1) }}%
                  </span>
                </div>
                <div class="recommendation-details">
                  <div class="detail-item">
                    <label>Giá hiện tại:</label>
                    <span>{{ formatPredictionPrice(weekAnalysis.todayRecommendation.currentPrice) }}</span>
                  </div>
                  <div class="detail-item" *ngIf="weekAnalysis.todayRecommendation.action === 'buy'">
                    <label>Giá dự đoán:</label>
                    <span class="predicted-price">{{ formatPredictionPrice(weekAnalysis.todayRecommendation.predictedPrice) }}</span>
                  </div>
                  <div class="detail-item">
                    <label>Lý do:</label>
                    <span class="reason-text">{{ weekAnalysis.todayRecommendation.reason }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Buy Positions -->
            <div class="positions-section" *ngIf="weekAnalysis.buyPositions.length > 0">
              <h4>Vị thế mua ({{ weekAnalysis.buyPositions.length }})</h4>
              <div class="positions-list">
                <div class="position-card buy" *ngFor="let position of weekAnalysis.buyPositions">
                  <div class="position-header">
                    <span class="position-date">{{ formatDateFromTimestamp(position.buyDate) }}</span>
                    <span class="position-status" [ngClass]="position.status">
                      {{ position.status === 'sold' ? 'Đã bán' : 'Đang giữ' }}
                    </span>
                  </div>
                  <div class="position-details">
                    <div class="detail-row">
                      <span>Giá mua:</span>
                      <span class="price-value">{{ formatPredictionPrice(position.buyPrice) }}</span>
                    </div>
                    <div class="detail-row" *ngIf="position.sellPrice">
                      <span>Giá bán:</span>
                      <span class="price-value">{{ formatPredictionPrice(position.sellPrice) }}</span>
                    </div>
                    <div class="detail-row" *ngIf="position.status === 'holding'">
                      <span>Giá hiện tại:</span>
                      <span class="price-value">{{ formatPredictionPrice(position.currentPrice) }}</span>
                    </div>
                    <div class="detail-row">
                      <span>Số lượng:</span>
                      <span>{{ position.quantity | number:'1.0-0' }}</span>
                    </div>
                    <div class="detail-row" *ngIf="position.profit !== null && position.profitPercent !== null && position.profitPercent !== undefined">
                      <span>Lãi/Lỗ:</span>
                      <span [ngClass]="position.profit >= 0 ? 'positive' : 'negative'">
                        {{ formatCurrency(position.profit) }}
                        ({{ (position.profitPercent ?? 0) >= 0 ? '+' : '' }}{{ (position.profitPercent ?? 0).toFixed(2) }}%)
                      </span>
                    </div>
                    <div class="detail-row" *ngIf="position.status === 'holding' && position.currentPrice && position.buyPrice">
                      <span>Lãi/Lỗ chưa thực hiện:</span>
                      <span [ngClass]="(position.currentPrice - position.buyPrice) * position.quantity >= 0 ? 'positive' : 'negative'">
                        {{ formatCurrency((position.currentPrice - position.buyPrice) * position.quantity) }}
                        ({{ ((position.currentPrice - position.buyPrice) / position.buyPrice * 100) >= 0 ? '+' : '' }}{{ ((position.currentPrice - position.buyPrice) / position.buyPrice * 100).toFixed(2) }}%)
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sell Positions -->
            <div class="positions-section" *ngIf="weekAnalysis.sellPositions.length > 0">
              <h4>Vị thế bán ({{ weekAnalysis.sellPositions.length }})</h4>
              <div class="positions-list">
                <div class="position-card sell" *ngFor="let position of weekAnalysis.sellPositions">
                  <div class="position-header">
                    <span class="position-date">{{ formatDateFromTimestamp(position.sellDate) }}</span>
                    <span class="position-status sold">Đã bán</span>
                  </div>
                  <div class="position-details">
                    <div class="detail-row">
                      <span>Giá mua (kỳ vọng):</span>
                      <span class="price-value">{{ formatPredictionPrice(position.expectedBuyPrice) }}</span>
                    </div>
                    <div class="detail-row">
                      <span>Giá bán:</span>
                      <span class="price-value">{{ formatPredictionPrice(position.sellPrice) }}</span>
                    </div>
                    <div class="detail-row">
                      <span>Số lượng:</span>
                      <span>{{ position.quantity | number:'1.0-0' }}</span>
                    </div>
                    <div class="detail-row">
                      <span>Lãi/Lỗ:</span>
                      <span [ngClass]="position.profit >= 0 ? 'positive' : 'negative'">
                        {{ formatCurrency(position.profit) }}
                        ({{ position.profitPercent >= 0 ? '+' : '' }}{{ position.profitPercent.toFixed(2) }}%)
                      </span>
                    </div>
                    <div class="detail-row">
                      <span>Ngày mua:</span>
                      <span>{{ formatDateFromTimestamp(position.buyDate) }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- No positions message -->
            <div class="no-positions" *ngIf="weekAnalysis.buyPositions.length === 0 && weekAnalysis.sellPositions.length === 0">
              <p>Không có giao dịch nào trong 7 ngày gần đây.</p>
            </div>
          </div>
        </section>
      </div>

      <!-- Chart Tab -->
      <div *ngIf="activeTab() === 'chart' && !isLoadingDetail()">
        <!-- TradingView Chart -->
        <section class="section tradingview-section">
          <div class="section-header">
            <h3>Biểu đồ TradingView</h3>
            <div class="chart-data-controls">
              <select [value]="selectedYears()" (change)="selectedYears.set(+$any($event.target).value)">
                <option [value]="1">1 năm</option>
                <option [value]="2">2 năm</option>
                <option [value]="3">3 năm</option>
                <option [value]="5">5 năm</option>
              </select>
              <button class="btn btn-small" (click)="fetchPriceDataOnly(selectedYears())" [disabled]="isLoadingPrice()">
                <i class="pi" [ngClass]="isLoadingPrice() ? 'pi-spin pi-spinner' : 'pi-refresh'"></i>
                {{ isLoadingPrice() ? 'Đang tải...' : 'Cập nhật' }}
              </button>
              <button class="btn btn-small btn-fullscreen" (click)="showChartFullscreen.set(true)" *ngIf="selectedSymbolPriceData()">
                <i class="pi pi-expand"></i>
                Phóng to
              </button>
            </div>
          </div>

          <div class="tradingview-chart-container compact" *ngIf="selectedSymbolPriceData() && !isLoadingPrice()">
            <app-tradingview-chart
              [data]="selectedSymbolPriceData()"
              [symbol]="selectedSymbol()?.symbol || ''"
              [theme]="'dark'">
            </app-tradingview-chart>
          </div>

          <div class="price-loading" *ngIf="isLoadingPrice()">
            <i class="pi pi-spin pi-spinner"></i>
            <span>Đang tải dữ liệu giá...</span>
          </div>

          <div class="no-data" *ngIf="!selectedSymbolPriceData() && !isLoadingPrice()">
            <i class="pi pi-chart-line"></i>
            <p>Chưa có dữ liệu giá. Nhấn "Cập nhật" để tải.</p>
          </div>
        </section>

        <!-- Chart Fullscreen Dialog -->
        <div class="fullscreen-dialog-overlay" *ngIf="showChartFullscreen()" (click)="showChartFullscreen.set(false)">
          <div class="fullscreen-dialog chart-dialog" (click)="$event.stopPropagation()">
            <div class="dialog-header">
              <h3>{{ selectedSymbol()?.symbol }} - Biểu đồ</h3>
              <button class="btn-close" (click)="showChartFullscreen.set(false)">
                <i class="pi pi-times"></i>
              </button>
            </div>
            <div class="dialog-body">
              <app-tradingview-chart
                [data]="selectedSymbolPriceData()"
                [symbol]="selectedSymbol()?.symbol || ''"
                [theme]="'dark'">
              </app-tradingview-chart>
            </div>
          </div>
        </div>

        <!-- Price Table (Collapsed by default) -->
        <section class="section collapsible" *ngIf="selectedSymbolPriceData() && !isLoadingPrice()">
          <div class="section-header clickable" (click)="togglePriceTable()">
            <h3>
              <i class="pi" [ngClass]="showPriceTable() ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
              Lịch sử giá (20 phiên gần nhất)
            </h3>
          </div>
          <div class="table-wrapper" *ngIf="showPriceTable()">
            <table class="price-table">
              <thead>
                <tr>
                  <th>Ngày</th>
                  <th>TC</th>
                  <th>Mở</th>
                  <th>Cao</th>
                  <th>Thấp</th>
                  <th>Đóng</th>
                  <th>+/-</th>
                  <th>%</th>
                  <th>KL</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of priceTableData()">
                  <td>{{ item.date }}</td>
                  <td class="reference">{{ (item.referencePrice * 1000) | number:'1.0-0' }}</td>
                  <td [ngClass]="getPriceColorClass(item.open, item.referencePrice, item.ceilingPrice, item.floorPrice)">
                    {{ (item.open * 1000) | number:'1.0-0' }}
                  </td>
                  <td [ngClass]="getPriceColorClass(item.high, item.referencePrice, item.ceilingPrice, item.floorPrice)">
                    {{ (item.high * 1000) | number:'1.0-0' }}
                  </td>
                  <td [ngClass]="getPriceColorClass(item.low, item.referencePrice, item.ceilingPrice, item.floorPrice)">
                    {{ (item.low * 1000) | number:'1.0-0' }}
                  </td>
                  <td [ngClass]="getPriceColorClass(item.close, item.referencePrice, item.ceilingPrice, item.floorPrice)">
                    {{ (item.close * 1000) | number:'1.0-0' }}
                  </td>
                  <td [ngClass]="{'positive': item.changeValue > 0, 'negative': item.changeValue < 0, 'reference': item.changeValue === 0}">
                    {{ item.changeValue >= 0 ? '+' : '' }}{{ (item.changeValue * 1000) | number:'1.0-0' }}
                  </td>
                  <td [ngClass]="{'positive': item.changePercent > 0, 'negative': item.changePercent < 0, 'reference': item.changePercent === 0}">
                    {{ item.changePercent >= 0 ? '+' : '' }}{{ item.changePercent | number:'1.2-2' }}%
                  </td>
                  <td>{{ item.volume | number:'1.0-0' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- Advisor Tab - Tư vấn tự động -->
      <div *ngIf="activeTab() === 'advisor' && !isLoadingDetail()">
        <section class="section advisor-section">
          <h3>
            <i class="pi pi-compass"></i>
            Tư vấn chiến lược giao dịch
          </h3>

          <!-- Need Model Warning -->
          <div class="advisor-warning" *ngIf="!isNNReady()">
            <div class="warning-content">
              <i class="pi pi-exclamation-triangle"></i>
              <div class="warning-text">
                <strong>Cần huấn luyện mô hình AI</strong>
                <p>Vui lòng huấn luyện mô hình Neural Network trong tab Trading trước khi sử dụng tính năng tư vấn tự động.</p>
              </div>
            </div>
            <button class="btn btn-primary" (click)="activeTab.set('trading')">
              <i class="pi pi-arrow-right"></i>
              Đi đến Trading
            </button>
          </div>

          <!-- Strategy Panel - Personal Holding Analysis -->
          <div class="strategy-panel" *ngIf="isNNReady()">
            <div class="panel-header">
              <h4>
                <i class="pi pi-user"></i>
                Danh mục của bạn
              </h4>
            </div>

            <!-- User Input Section -->
            <div class="holding-input-section">
              <div class="input-row">
                <div class="input-group">
                  <label>Số CP đang nắm giữ:</label>
                  <input
                    type="number"
                    [ngModel]="userHoldingShares()"
                    (ngModelChange)="userHoldingShares.set($event)"
                    min="0"
                    step="100"
                    placeholder="VD: 1000">
                </div>
                <div class="input-group">
                  <label>Giá trung bình (VNĐ):</label>
                  <input
                    type="number"
                    [ngModel]="userAveragePrice()"
                    (ngModelChange)="userAveragePrice.set($event)"
                    min="0"
                    step="100"
                    placeholder="VD: 25000">
                </div>
              </div>
              <div class="holding-summary" *ngIf="userHoldingShares() > 0 && userAveragePrice() > 0">
                <span class="summary-item">
                  <i class="pi pi-wallet"></i>
                  Giá trị nắm giữ: <strong>{{ formatCurrency(userHoldingShares() * userAveragePrice()) }}</strong>
                </span>
                <span class="summary-item" *ngIf="strategyRecommendation()">
                  <i class="pi pi-chart-line"></i>
                  Giá hiện tại: <strong>{{ formatPredictionPrice(strategyRecommendation()!.currentPrice) }}</strong>
                </span>
              </div>
            </div>

            <!-- Strategy Recommendation -->
            <div class="strategy-recommendation" *ngIf="strategyRecommendation()">
              <div class="recommendation-header" [ngClass]="'recommendation-' + strategyRecommendation()!.recommendation">
                <div class="recommendation-badge">
                  <i class="pi" [ngClass]="{
                    'pi-arrow-up': strategyRecommendation()!.recommendation === 'buy' || strategyRecommendation()!.recommendation === 'buy_more',
                    'pi-arrow-down': strategyRecommendation()!.recommendation === 'sell',
                    'pi-pause': strategyRecommendation()!.recommendation === 'hold'
                  }"></i>
                  <span>
                    {{ strategyRecommendation()!.recommendation === 'buy' ? 'MUA VÀO' :
                       strategyRecommendation()!.recommendation === 'buy_more' ? 'MUA THÊM' :
                       strategyRecommendation()!.recommendation === 'sell' ? 'BÁN RA' : 'NẮM GIỮ' }}
                  </span>
                </div>
                <div class="recommendation-confidence">
                  Độ tin cậy: {{ (strategyRecommendation()!.confidence * 100).toFixed(0) }}%
                </div>
              </div>
              <div class="recommendation-reason">
                <i class="pi pi-info-circle"></i>
                {{ strategyRecommendation()!.reason }}
              </div>

              <!-- Unrealized P/L if holding -->
              <div class="unrealized-pl" *ngIf="userHoldingShares() > 0">
                <div class="pl-item" [ngClass]="strategyRecommendation()!.unrealizedPL >= 0 ? 'profit' : 'loss'">
                  <span class="pl-label">Lãi/Lỗ chưa thực hiện:</span>
                  <span class="pl-value">
                    {{ strategyRecommendation()!.unrealizedPL >= 0 ? '+' : '' }}{{ formatCurrency(strategyRecommendation()!.unrealizedPL) }}
                    <span class="pl-percent">
                      ({{ strategyRecommendation()!.unrealizedPLPercent >= 0 ? '+' : '' }}{{ strategyRecommendation()!.unrealizedPLPercent.toFixed(2) }}%)
                    </span>
                  </span>
                </div>
              </div>

              <!-- Price Zones -->
              <div class="price-zones">
                <h5>
                  <i class="pi pi-map-marker"></i>
                  Các vùng giá quan trọng
                </h5>
                <div class="zones-grid">
                  <div class="zone-item current">
                    <div class="zone-icon">
                      <i class="pi pi-circle-fill"></i>
                    </div>
                    <div class="zone-info">
                      <span class="zone-label">Giá hiện tại</span>
                      <span class="zone-price">{{ formatPredictionPrice(strategyRecommendation()!.currentPrice) }}</span>
                    </div>
                  </div>
                  <div class="zone-item predicted">
                    <div class="zone-icon">
                      <i class="pi pi-star"></i>
                    </div>
                    <div class="zone-info">
                      <span class="zone-label">Giá dự đoán (AI)</span>
                      <span class="zone-price">{{ formatPredictionPrice(strategyRecommendation()!.predictedPrice) }}</span>
                    </div>
                  </div>
                  <div class="zone-item stop-loss">
                    <div class="zone-icon">
                      <i class="pi pi-exclamation-triangle"></i>
                    </div>
                    <div class="zone-info">
                      <span class="zone-label">Vùng cắt lỗ</span>
                      <span class="zone-price">≤ {{ formatPredictionPrice(strategyRecommendation()!.stopLossPrice) }}</span>
                    </div>
                  </div>
                  <div class="zone-item take-profit">
                    <div class="zone-icon">
                      <i class="pi pi-check-circle"></i>
                    </div>
                    <div class="zone-info">
                      <span class="zone-label">Vùng chốt lãi</span>
                      <span class="zone-price">≥ {{ formatPredictionPrice(strategyRecommendation()!.takeProfitPrice) }}</span>
                    </div>
                  </div>
                  <div class="zone-item buy-more">
                    <div class="zone-icon">
                      <i class="pi pi-plus-circle"></i>
                    </div>
                    <div class="zone-info">
                      <span class="zone-label">Vùng mua thêm (DCA)</span>
                      <span class="zone-price">{{ formatPredictionPrice(strategyRecommendation()!.buyMoreZoneEnd) }} - {{ formatPredictionPrice(strategyRecommendation()!.buyMoreZoneStart) }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Estimated Sessions -->
              <div class="estimated-sessions" *ngIf="strategyRecommendation()!.estimatedSessions && strategyRecommendation()!.estimatedSessions! > 0">
                <div class="sessions-info">
                  <i class="pi pi-clock"></i>
                  <span>
                    Dự kiến đạt vùng chốt lãi sau khoảng
                    <strong>{{ strategyRecommendation()!.estimatedSessions }} phiên</strong>
                    giao dịch (dựa vào biến động trung bình)
                  </span>
                </div>
              </div>

              <!-- Model Info -->
              <div class="model-info-section">
                <h5>
                  <i class="pi pi-microchip-ai"></i>
                  Thông tin mô hình AI
                </h5>
                <div class="model-info-grid">
                  <div class="model-info-item" *ngIf="nnPrediction()">
                    <span class="info-label">Xu hướng dự đoán:</span>
                    <span class="info-value trend-badge" [ngClass]="getTrendColorClass(nnPrediction()!.trend)">
                      {{ nnPrediction()!.trend === 'up' ? '📈 Tăng' : nnPrediction()!.trend === 'down' ? '📉 Giảm' : '➡️ Ổn định' }}
                    </span>
                  </div>
                  <div class="model-info-item" *ngIf="nnPrediction()?.tradingDecision">
                    <span class="info-label">Quyết định AI:</span>
                    <span class="info-value decision-badge" [ngClass]="'decision-' + nnPrediction()!.tradingDecision!.action">
                      {{ nnPrediction()!.tradingDecision!.action === 'buy' ? 'MUA' : nnPrediction()!.tradingDecision!.action === 'sell' ? 'BÁN' : 'GIỮ' }}
                      ({{ (nnPrediction()!.tradingDecision!.confidence * 100).toFixed(0) }}%)
                    </span>
                  </div>
                  <div class="model-info-item">
                    <span class="info-label">Stop Loss:</span>
                    <span class="info-value">-{{ tradingConfig().stopLossPercent }}%</span>
                  </div>
                  <div class="model-info-item">
                    <span class="info-label">Take Profit:</span>
                    <span class="info-value">{{ tradingConfig().takeProfitPercent > 0 ? '+' + tradingConfig().takeProfitPercent + '%' : 'Tự động (AI)' }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- No Prediction Message -->
            <div class="no-model-message" *ngIf="!strategyRecommendation()">
              <i class="pi pi-info-circle"></i>
              <div>
                <strong>Chưa có dự đoán</strong>
                <p>Vui lòng chạy dự đoán trong tab Trading để nhận tư vấn chiến lược giao dịch.</p>
              </div>
            </div>
          </div>
        </section>
      </div>
      </div>
    </div>

  <!-- List View -->
  <div *ngIf="!showDetailView()" class="list-view">
    <!-- Header -->
    <header class="header">
      <h1>Danh sách cổ phiếu</h1>
      <div class="stats">
        <span class="stat">Tổng: {{ totalCount() }}</span>
        <span class="stat success">Đã fetch: {{ fetchedCount() }}</span>
        <span class="stat warning">Chưa fetch: {{ totalCount() - fetchedCount() }}</span>
      </div>
    </header>

    <!-- Search & Filters -->
    <div class="toolbar">
      <div class="search-box">
        <i class="pi pi-search"></i>
        <input
          type="text"
          [value]="searchQuery()"
          (input)="onSearchChange($any($event.target).value)"
          placeholder="Tìm kiếm mã hoặc tên công ty..."
          class="search-input">
        <button *ngIf="searchQuery()" (click)="onSearchChange('')" class="clear-btn">
          <i class="pi pi-times"></i>
        </button>
      </div>
      <div class="filters">
        <select [value]="selectedExchange()" (change)="onExchangeChange($any($event.target).value)" class="select">
          <option value="all">Tất cả sàn</option>
          <option *ngFor="let exchange of exchanges" [value]="exchange">
            {{ exchangeNames[exchange] }} ({{ getExchangeCountText(exchange) }})
          </option>
        </select>
        <select [value]="filterMode()" (change)="onFilterModeChange($any($event.target).value)" class="select">
          <option value="all">Tất cả</option>
          <option value="unfetched">Chưa fetch</option>
        </select>
      </div>
      <div class="actions">
        <button class="btn primary" (click)="fetchAllUnfetched()" [disabled]="isLoading() || !hasUnfetchedSymbols()">
          <i class="pi pi-download"></i>
          Fetch tất cả
        </button>
        <button class="btn" (click)="loadSymbols()" [disabled]="isLoading()">
          <i class="pi pi-refresh"></i>
          Tải lại
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading" *ngIf="isLoading()">
      <i class="pi pi-spin pi-spinner"></i>
      <span>Đang tải...</span>
    </div>

    <!-- DNSE Sync Panel -->
    <div *ngIf="!isLoading()" class="dnse-sync-panel">
      <div class="sync-info">
        <span class="sync-label">
          <i class="pi pi-database"></i>
          DB: {{ paginationTotal() }} cổ phiếu
        </span>
        <span class="sync-label" *ngIf="dnseSymbolsCount() > 0">
          <i class="pi pi-cloud"></i>
          DNSE: {{ dnseSymbolsCount() }}
        </span>
        <span class="sync-label missing" *ngIf="missingSymbolsCount() > 0">
          <i class="pi pi-exclamation-circle"></i>
          Thiếu: {{ missingSymbolsCount() }}
        </span>
      </div>
      <div class="sync-actions">
        <button
          class="btn-sync"
          (click)="checkMissingStocksFromDNSE()"
          [disabled]="isSyncingDNSE()">
          <i class="pi" [ngClass]="isSyncingDNSE() ? 'pi-spin pi-spinner' : 'pi-search'"></i>
          {{ isSyncingDNSE() ? 'Đang kiểm tra...' : 'Kiểm tra DNSE' }}
        </button>
        <button
          class="btn-sync primary"
          *ngIf="missingSymbolsCount() > 0"
          (click)="syncMissingStocks()"
          [disabled]="isSyncingDNSE()">
          <i class="pi pi-cloud-download"></i>
          Thêm {{ missingSymbolsCount() }} cổ phiếu
        </button>
        <button
          class="btn-sync"
          (click)="updateAllPricesFromDNSE()"
          [disabled]="isUpdatingPrices()">
          <i class="pi" [ngClass]="isUpdatingPrices() ? 'pi-spin pi-spinner' : 'pi-refresh'"></i>
          {{ isUpdatingPrices() ? 'Đang cập nhật ' + priceUpdateProgress().current + '/' + priceUpdateProgress().total : 'Cập nhật giá tất cả' }}
        </button>
      </div>
    </div>

    <!-- Stock List -->
    <div *ngIf="!isLoading()" class="stock-list">
      <div class="list-header">
        <div class="col-symbol">Mã</div>
        <div class="col-name">Tên công ty</div>
        <div class="col-exchange">Sàn</div>
        <div class="col-price">Giá</div>
        <div class="col-change">Thay đổi</div>
        <div class="col-updated">Cập nhật</div>
        <div class="col-actions">Thao tác</div>
      </div>

      <cdk-virtual-scroll-viewport class="viewport" itemSize="80">
        <div
          *cdkVirtualFor="let symbol of filteredSymbols(); trackBy: trackBySymbol"
          class="stock-row"
          [class.fetched]="symbol.isFetched"
          [class.not-fetched]="!symbol.isFetched"
          (click)="symbol.isFetched && viewStockDetail(symbol)">
          <div class="col-symbol">
            <strong>{{ symbol.symbol }}</strong>
          </div>
          <div class="col-name">
            <div class="company-name">{{ symbol.basicInfo?.companyName || symbol.name || '-' }}</div>
            <div class="company-address" *ngIf="symbol.basicInfo?.fullData">
              {{ getCompanyAddress(symbol) }}
            </div>
          </div>
          <div class="col-exchange">
            <span class="badge" *ngFor="let exch of getExchangesArray(symbol.exchange)">
              {{ exchangeNames[exch] || exch }}
            </span>
          </div>
          <div class="col-price" *ngIf="symbol.isFetched && symbol.basicInfo?.matchPrice">
            <strong>{{ (parseFloat(symbol.basicInfo.matchPrice) * 1000) | number:'1.0-0' }} đ</strong>
          </div>
          <div class="col-price" *ngIf="!symbol.isFetched || !symbol.basicInfo?.matchPrice">-</div>
          <div class="col-change" *ngIf="symbol.isFetched && symbol.basicInfo?.changedValue">
            <span [class]="parseFloat(symbol.basicInfo.changedValue) >= 0 ? 'positive' : 'negative'">
              {{ (parseFloat(symbol.basicInfo.changedValue) * 1000) | number:'1.0-0' }} đ
              ({{ symbol.basicInfo.changedRatio || '0' }}%)
            </span>
          </div>
          <div class="col-change" *ngIf="!symbol.isFetched || !symbol.basicInfo?.changedValue">-</div>
          <div class="col-updated">
            <span class="updated-date" [ngClass]="{'outdated': isPriceOutdated(symbol.updatedAt), 'not-fetched': !symbol.isFetched}">
              <i class="pi" [ngClass]="symbol.isFetched ? (isPriceOutdated(symbol.updatedAt) ? 'pi-exclamation-triangle' : 'pi-check-circle') : 'pi-clock'"></i>
              {{ symbol.isFetched ? formatUpdatedDate(symbol.updatedAt) : 'Chưa fetch' }}
            </span>
          </div>
          <div class="col-actions" (click)="$event.stopPropagation()">
            <button
              *ngIf="!symbol.isFetched"
              class="btn-icon"
              (click)="fetchSymbol(symbol)"
              [disabled]="symbol.isFetching || fetchingSymbols().has(symbol.symbol)"
              title="Fetch">
              <i class="pi pi-download"></i>
            </button>
            <button
              *ngIf="symbol.isFetched"
              class="btn-icon"
              (click)="viewStockDetail(symbol)"
              title="Xem chi tiết">
              <i class="pi pi-eye"></i>
            </button>
            <button
              *ngIf="symbol.isFetched"
              class="btn-icon"
              (click)="updatePriceFromDNSE(symbol)"
              [disabled]="isUpdatingPrices() || symbol.isFetching"
              title="Cập nhật thông tin & giá">
              <i class="pi" [ngClass]="updatingPriceSymbol() === symbol.symbol ? 'pi-spin pi-spinner' : 'pi-sync'"></i>
            </button>
            <button
              *ngIf="symbol.isFetched"
              class="btn-icon"
              (click)="fetchSymbol(symbol)"
              [disabled]="symbol.isFetching || fetchingSymbols().has(symbol.symbol)"
              title="Fetch lại toàn bộ">
              <i class="pi pi-refresh"></i>
            </button>
          </div>
        </div>

        <!-- Loading more indicator -->
        <div *ngIf="isLoadingMore()" class="loading-more">
          <i class="pi pi-spin pi-spinner"></i>
          <span>Đang tải thêm...</span>
        </div>

        <!-- End of list indicator -->
        <div *ngIf="!hasMoreData() && filteredSymbols().length > 0" class="end-of-list">
          <span>Đã hiển thị tất cả {{ filteredSymbols().length }} / {{ paginationTotal() }} cổ phiếu</span>
        </div>
      </cdk-virtual-scroll-viewport>

      <!-- Pagination info -->
      <div *ngIf="!isLoading() && filteredSymbols().length > 0" class="pagination-info">
        <span>Hiển thị {{ filteredSymbols().length }} / {{ paginationTotal() }} cổ phiếu</span>
        <span *ngIf="hasMoreData()" class="scroll-hint">
          <i class="pi pi-arrow-down"></i> Cuộn xuống để tải thêm
        </span>
      </div>

      <div *ngIf="filteredSymbols().length === 0 && !isLoading()" class="empty">
        <i class="pi pi-inbox"></i>
        <p>Không tìm thấy cổ phiếu nào</p>
      </div>
    </div>
  </div>
</div>

<!-- DNSE Check Dialog -->
<div class="dnse-dialog-overlay" *ngIf="showDnseDialog()" (click)="closeDnseDialog()">
  <div class="dnse-dialog" (click)="$event.stopPropagation()">
    <div class="dnse-dialog-header">
      <h3>
        <i class="pi pi-cloud"></i>
        Kiểm tra DNSE
      </h3>
      <button class="close-btn" (click)="closeDnseDialog()" [disabled]="dnseDialogStatus() === 'loading'">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <div class="dnse-dialog-content">
      <!-- Loading State -->
      <div class="dialog-status loading" *ngIf="dnseDialogStatus() === 'loading'">
        <i class="pi pi-spin pi-spinner"></i>
        <span>{{ dnseDialogMessage() }}</span>
      </div>

      <!-- Error State -->
      <div class="dialog-status error" *ngIf="dnseDialogStatus() === 'error'">
        <i class="pi pi-times-circle"></i>
        <span>{{ dnseDialogMessage() }}</span>
      </div>

      <!-- Success State -->
      <div class="dialog-result" *ngIf="dnseDialogStatus() === 'success'">
        <div class="result-summary">
          <div class="result-item">
            <div class="result-icon db">
              <i class="pi pi-database"></i>
            </div>
            <div class="result-info">
              <span class="result-label">Database</span>
              <span class="result-value">{{ dbSymbolsCount() }} cổ phiếu</span>
            </div>
          </div>

          <div class="result-item">
            <div class="result-icon dnse">
              <i class="pi pi-cloud"></i>
            </div>
            <div class="result-info">
              <span class="result-label">DNSE</span>
              <span class="result-value">{{ dnseSymbolsCount() }} cổ phiếu</span>
            </div>
          </div>

          <div class="result-item" [class.highlight]="missingSymbolsCount() > 0">
            <div class="result-icon missing">
              <i class="pi" [ngClass]="missingSymbolsCount() > 0 ? 'pi-exclamation-triangle' : 'pi-check-circle'"></i>
            </div>
            <div class="result-info">
              <span class="result-label">Chưa có trong DB</span>
              <span class="result-value">{{ missingSymbolsCount() }} cổ phiếu</span>
            </div>
          </div>
        </div>

        <!-- Missing symbols list -->
        <div class="missing-symbols-section" *ngIf="missingSymbolsCount() > 0">
          <h4>
            <i class="pi pi-list"></i>
            Danh sách cổ phiếu chưa có ({{ missingSymbolsCount() }})
          </h4>
          <div class="missing-symbols-list">
            <span class="symbol-tag" *ngFor="let symbol of missingSymbols()">{{ symbol }}</span>
          </div>
        </div>

        <!-- No missing symbols -->
        <div class="no-missing" *ngIf="missingSymbolsCount() === 0">
          <i class="pi pi-check-circle"></i>
          <span>Tất cả cổ phiếu từ DNSE đều đã có trong Database!</span>
        </div>
      </div>
    </div>

    <div class="dnse-dialog-footer" *ngIf="dnseDialogStatus() !== 'loading'">
      <button class="btn-dialog secondary" (click)="closeDnseDialog()">
        Đóng
      </button>
      <button
        class="btn-dialog primary"
        *ngIf="missingSymbolsCount() > 0"
        (click)="syncMissingStocks(); closeDnseDialog()">
        <i class="pi pi-cloud-download"></i>
        Thêm {{ missingSymbolsCount() }} cổ phiếu
      </button>
    </div>
  </div>
</div>
