<!-- Desktop Environment -->
<div class="desktop" (contextmenu)="onDesktopRightClick($event)" (click)="hideDesktopContextMenu()">
  <!-- Desktop Wallpaper -->
  <div class="wallpaper"></div>

  <!-- Calculator Window -->
  <app-window
    *ngIf="showTestWindow()"
    title="Calculator"
    icon="calculator"
    statusText="Ready"
    [initialWidth]="320"
    [initialHeight]="480"
    [initialX]="100"
    [initialY]="100"
    [maximizable]="false"
    [zIndex]="getWindowZIndex('calculator')"
    [isFocused]="isWindowFocused('calculator')"
    (onClose)="onCloseTestWindow()"
    (onMinimize)="onMinimizeTestWindow()"
    (onMaximize)="onMaximizeTestWindow()"
    (onRestore)="onRestoreTestWindow()"
    (onFocus)="onFocusTestWindow()">

    <app-calculator></app-calculator>
  </app-window>

  <!-- My Information Window -->
  <app-window
    *ngIf="showMyInfoWindow()"
    title="My Information"
    icon="user-profile"
    [showStatusBar]="false"
    [initialWidth]="900"
    [initialHeight]="700"
    [initialX]="200"
    [initialY]="50"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('my-info')"
    [isFocused]="isWindowFocused('my-info')"
    (onClose)="onCloseMyInfoWindow()"
    (onMinimize)="onMinimizeMyInfoWindow()"
    (onMaximize)="onMaximizeMyInfoWindow()"
    (onRestore)="onRestoreMyInfoWindow()"
    (onFocus)="onFocusMyInfoWindow()">

    <app-iframe-app
      url="https://hpphat1992.vercel.app"
      title="My Information">
    </app-iframe-app>
  </app-window>

  <!-- My Page Window -->
  <app-window
    *ngIf="showMyPageWindow()"
    title="My Page"
    icon="info"
    statusText="Loading web page..."
    [initialWidth]="1000"
    [initialHeight]="700"
    [initialX]="150"
    [initialY]="100"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('my-page')"
    [isFocused]="isWindowFocused('my-page')"
    (onClose)="onCloseMyPageWindow()"
    (onMinimize)="onMinimizeMyPageWindow()"
    (onMaximize)="onMaximizeMyPageWindow()"
    (onRestore)="onRestoreMyPageWindow()"
    (onFocus)="onFocusMyPageWindow()">

    <div class="browser-container">
      <!-- Browser Tab Bar -->
      <div class="tab-bar">
        <div class="tab active">
          <i class="pi pi-globe tab-icon"></i>
          <span class="tab-title">Google</span>
          <button class="tab-close" title="Close tab">
            <i class="pi pi-times"></i>
          </button>
        </div>
        <button class="new-tab-btn" title="New tab">
          <i class="pi pi-plus"></i>
        </button>
      </div>

      <!-- Browser Navigation Bar -->
      <div class="nav-bar">
        <div class="nav-controls">
          <button class="nav-btn" [disabled]="!canGoBack" (click)="goBack()" title="Back">
            <i class="pi pi-arrow-left"></i>
          </button>
          <button class="nav-btn" [disabled]="!canGoForward" (click)="goForward()" title="Forward">
            <i class="pi pi-arrow-right"></i>
          </button>
          <button class="nav-btn" (click)="refreshPage()" title="Reload">
            <i class="pi pi-refresh" [class.spinning]="isLoading"></i>
          </button>
          <button class="nav-btn" (click)="goHome()" title="Home">
            <i class="pi pi-home"></i>
          </button>
        </div>

        <div class="address-bar-container">
          <div class="address-bar">
            <i class="pi pi-lock security-icon" title="Secure"></i>
            <input
              type="text"
              class="url-input"
              [value]="currentUrl"
              (keydown.enter)="navigateToUrl($event)"
              (focus)="selectUrl($event)"
              placeholder="Search Google or type a URL">
            <button class="bookmark-btn" [class.bookmarked]="isBookmarked" (click)="toggleBookmark()" title="Bookmark">
              <i class="pi pi-star" [class.pi-star-fill]="isBookmarked"></i>
            </button>
          </div>
        </div>

        <div class="browser-actions">
          <button class="action-btn" (click)="toggleBookmarks()" title="Bookmarks">
            <i class="pi pi-bookmark"></i>
          </button>
          <button class="action-btn" (click)="openHistory()" title="History">
            <i class="pi pi-history"></i>
          </button>
          <button class="action-btn" (click)="openDownloads()" title="Downloads">
            <i class="pi pi-download"></i>
          </button>
          <button class="action-btn menu-btn" (click)="toggleBrowserMenu()" title="Menu">
            <i class="pi pi-ellipsis-v"></i>
          </button>
        </div>
      </div>

      <!-- Bookmarks Bar -->
      <div class="bookmarks-bar" *ngIf="showBookmarksBar">
        <div class="bookmark-item" *ngFor="let bookmark of bookmarks" (click)="navigateToBookmark(bookmark)">
          <i class="pi pi-globe"></i>
          <span>{{ bookmark.name }}</span>
        </div>
        <button class="bookmark-item add-bookmark" (click)="addBookmark()">
          <i class="pi pi-plus"></i>
          <span>Add bookmark</span>
        </button>
      </div>

      <!-- Browser Menu -->
      <div class="browser-menu" *ngIf="showBrowserMenu">
        <div class="menu-item" (click)="newTab()">
          <i class="pi pi-plus"></i>
          <span>New tab</span>
        </div>
        <div class="menu-item" (click)="newWindow()">
          <i class="pi pi-window-maximize"></i>
          <span>New window</span>
        </div>
        <div class="menu-separator"></div>
        <div class="menu-item" (click)="openHistory()">
          <i class="pi pi-history"></i>
          <span>History</span>
        </div>
        <div class="menu-item" (click)="openDownloads()">
          <i class="pi pi-download"></i>
          <span>Downloads</span>
        </div>
        <div class="menu-item" (click)="openBookmarks()">
          <i class="pi pi-bookmark"></i>
          <span>Bookmarks</span>
        </div>
        <div class="menu-separator"></div>
        <div class="menu-item" (click)="openSettings()">
          <i class="pi pi-cog"></i>
          <span>Settings</span>
        </div>
        <div class="menu-item" (click)="openDevTools()">
          <i class="pi pi-code"></i>
          <span>Developer tools</span>
        </div>
      </div>

      <!-- Browser Content -->
      <div class="browser-content">
        <div class="loading-bar" *ngIf="isLoading"></div>
        @if (iframeSrc()) {
          <iframe
            [src]="iframeSrc()"
            class="content-iframe"
            frameborder="0"
            allowfullscreen
            sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
            target="_parent"
            (load)="onPageLoad()"
            (error)="onPageError()">
          </iframe>
        }
      </div>
    </div>
  </app-window>

  <!-- Love Window -->
  <app-window
    *ngIf="showLoveWindow()"
    title="Love"
    icon="heart"
    statusText="Loading love website..."
    [initialWidth]="1000"
    [initialHeight]="700"
    [initialX]="200"
    [initialY]="150"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('love')"
    [isFocused]="isWindowFocused('love')"
    (onClose)="onCloseLoveWindow()"
    (onMinimize)="onMinimizeLoveWindow()"
    (onMaximize)="onMaximizeLoveWindow()"
    (onRestore)="onRestoreLoveWindow()"
    (onFocus)="onFocusLoveWindow()">

    <app-love-app
      url="https://hbslovely.vercel.app/"
      title="Love Application">
    </app-love-app>
  </app-window>

  <!-- Explorer Window -->
  <app-window
    *ngIf="showExplorerWindow()"
    title="Explorer"
    icon="pi pi-folder"
    statusText="Ready"
    [initialWidth]="800"
    [initialHeight]="600"
    [initialX]="300"
    [initialY]="100"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('explorer')"
    [isFocused]="isWindowFocused('explorer')"
    (onClose)="onCloseExplorerWindow()"
    (onMinimize)="onMinimizeExplorerWindow()"
    (onMaximize)="onMaximizeExplorerWindow()"
    (onRestore)="onRestoreExplorerWindow()"
    (onFocus)="onFocusExplorerWindow()">

    <app-explorer (onFileOpen)="onExplorerFileOpen($event)"></app-explorer>
  </app-window>

  <!-- Text Viewer Window -->
  <app-window
    *ngIf="showTextViewerWindow() && currentTextFile()"
    [title]="'Text Viewer - ' + currentTextFile()!.name"
    icon="pi pi-file"
    statusText="Ready"
    [initialWidth]="800"
    [initialHeight]="600"
    [initialX]="350"
    [initialY]="120"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('text-viewer')"
    [isFocused]="isWindowFocused('text-viewer')"
    (onClose)="onCloseTextViewerWindow()"
    (onMinimize)="onMinimizeTextViewerWindow()"
    (onMaximize)="onMaximizeTextViewerWindow()"
    (onRestore)="onRestoreTextViewerWindow()"
    (onFocus)="onFocusTextViewerWindow()">

    <app-text-viewer
      [filePath]="currentTextFile()!.path"
      [fileName]="currentTextFile()!.name"
      [fileType]="currentTextFile()!.type">
    </app-text-viewer>
  </app-window>

  <!-- Image Viewer Window -->
  <app-window
    *ngIf="showImageViewerWindow() && currentImageFile()"
    [title]="'Image Viewer - ' + currentImageFile()!.name"
    icon="pi pi-image"
    statusText="Ready"
    [initialWidth]="900"
    [initialHeight]="700"
    [initialX]="400"
    [initialY]="80"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('image-viewer')"
    [isFocused]="isWindowFocused('image-viewer')"
    (onClose)="onCloseImageViewerWindow()"
    (onMinimize)="onMinimizeImageViewerWindow()"
    (onMaximize)="onMaximizeImageViewerWindow()"
    (onRestore)="onRestoreImageViewerWindow()"
    (onFocus)="onFocusImageViewerWindow()">

    <app-image-viewer
      [imagePath]="currentImageFile()!.path"
      [imageName]="currentImageFile()!.name">
    </app-image-viewer>
  </app-window>
 
  <!-- Floating Clock Widget -->
  <div *ngIf="showClockWindow()" class="floating-clock-widget">
    <div class="clock-widget-header">
      <span class="clock-title">Clock</span>
      <div class="clock-controls">
        <button class="mode-toggle-btn" (click)="toggleClockMode()" [title]="clockMode === 'digital' ? 'Switch to Analog' : 'Switch to Digital'">
          <i [class]="clockMode === 'digital' ? 'pi pi-clock' : 'pi pi-calendar-times'"></i>
        </button>
        <button class="close-btn" (click)="onCloseClockWindow()" title="Close">
          <i class="pi pi-times"></i>
        </button>
      </div>
    </div>
    <div class="clock-app">
      <!-- Digital Clock Mode -->
      <div *ngIf="clockMode === 'digital'" class="digital-clock">
        <div class="time-display">{{ currentTime }}</div>
        <div class="date-display">{{ currentDate }}</div>
      </div>
      
      <!-- Analog Clock Mode -->
      <div *ngIf="clockMode === 'analog'" class="analog-clock">
        <div class="clock-face">
          <!-- Hour tick marks -->
          <div class="tick-marks">
            <div class="tick" *ngFor="let tick of [1,2,3,4,5,6,7,8,9,10,11,12]" [style.transform]="'rotate(' + (tick * 30) + 'deg)'"></div>
          </div>
          <!-- Clock numbers -->
          <div class="clock-numbers">
            <div class="number" *ngFor="let num of clockNumbers" [style.transform]="'rotate(' + (num * 30) + 'deg) translateY(-75px) rotate(' + (-num * 30) + 'deg)'">{{ num }}</div>
          </div>
          <!-- Clock hands -->
          <div class="clock-hands">
            <div class="hour-hand" [style.transform]="'rotate(' + hourAngle + 'deg)'"></div>
            <div class="minute-hand" [style.transform]="'rotate(' + minuteAngle + 'deg)'"></div>
            <div class="second-hand" [style.transform]="'rotate(' + secondAngle + 'deg)'"></div>
            <div class="center-dot"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Window -->
  <div *ngIf="showSearchWindow()" class="search-window" (click)="closeSearchWindow()">
    <div class="search-content" (click)="$event.stopPropagation()">
      <div class="search-header">
        <div class="search-input-container">
          <i class="pi pi-search search-icon"></i>
          <input 
            type="text" 
            class="search-input" 
            placeholder="Search applications, files, and web..."
            [(ngModel)]="searchQuery"
            (input)="onSearchInput($event)"
            (keydown.enter)="selectSearchResult(searchResults[0])"
            autofocus>
        </div>
        <button class="search-close-btn" (click)="closeSearchWindow()" title="Close">
          <i class="pi pi-times"></i>
        </button>
      </div>
      
      <div class="search-results" *ngIf="showSearchSuggestions">
        <div class="search-section" *ngIf="appSearchResults.length > 0">
          <div class="section-title">Applications</div>
          <div class="result-item" 
               *ngFor="let result of appSearchResults" 
               (click)="selectSearchResult(result)">
            <i [class]="'pi ' + result.icon"></i>
            <span>{{ result.name }}</span>
          </div>
        </div>
        
        <div class="search-section" *ngIf="webSearchResults.length > 0">
          <div class="section-title">Web Search</div>
          <div class="result-item" 
               *ngFor="let result of webSearchResults" 
               (click)="selectSearchResult(result)">
            <i [class]="'pi ' + result.icon"></i>
            <span>{{ result.name }}</span>
            <span class="result-subtitle">{{ searchQuery }}</span>
          </div>
        </div>
      </div>
      
      <div class="search-empty" *ngIf="!showSearchSuggestions && searchQuery.length >= 2">
        <i class="pi pi-search"></i>
        <p>No results found for "{{ searchQuery }}"</p>
      </div>
    </div>
  </div>

  <!-- Test Icons -->
  <app-desktop-icon
    *ngFor="let icon of testIcons"
    [iconData]="icon"
    (onClick)="onDesktopIconClick($event)"
    (onDoubleClick)="openTestApp($event)"
    (onContextMenu)="onDesktopIconContextMenu($event)">
  </app-desktop-icon>

  <!-- Taskbar -->
  <div class="taskbar">
    <!-- Start Button -->
    <button class="start-button" (click)="toggleStartMenu()" title="Start">
      <i class="pi pi-microsoft"></i>
    </button>

    <!-- Search Button -->
    <button class="search-button" (click)="openSearchWindow()" title="Search">
      <i class="pi pi-search"></i>
    </button>

    <!-- Taskbar Apps -->
    <div class="taskbar-apps">
      <button
        *ngIf="showTestWindow()"
        class="taskbar-app"
        [class.active]="isWindowFocused('calculator')"
        (click)="focusWindow('calculator')"
        title="Calculator">
        <i class="pi pi-calculator"></i>
        <span>Calculator</span>
      </button>

      <button
        *ngIf="showMyInfoWindow()"
        class="taskbar-app"
        [class.active]="isWindowFocused('my-info')"
        (click)="focusWindow('my-info')"
        title="My Information">
        <i class="pi pi-user"></i>
        <span>My Information</span>
      </button>

      <button
        *ngIf="showMyPageWindow()"
        class="taskbar-app"
        [class.active]="isWindowFocused('my-page')"
        (click)="focusWindow('my-page')"
        title="My Page">
        <i class="pi pi-globe"></i>
        <span>My Page</span>
      </button>

      <button
        *ngIf="showLoveWindow()"
        class="taskbar-app"
        [class.active]="isWindowFocused('love')"
        (click)="focusWindow('love')"
        title="Love">
        <i class="pi pi-heart"></i>
        <span>Love</span>
      </button>

      <button
        *ngIf="showExplorerWindow()"
        class="taskbar-app"
        [class.active]="isWindowFocused('explorer')"
        (click)="focusWindow('explorer')"
        title="Explorer">
        <i class="pi pi-folder"></i>
        <span>Explorer</span>
      </button>

      <button
        *ngIf="showTextViewerWindow()"
        class="taskbar-app"
        [class.active]="isWindowFocused('text-viewer')"
        (click)="focusWindow('text-viewer')"
        title="Text Viewer">
        <i class="pi pi-file"></i>
        <span>{{ currentTextFile()?.name || 'Text Viewer' }}</span>
      </button>

      <button
        *ngIf="showImageViewerWindow()"
        class="taskbar-app"
        [class.active]="isWindowFocused('image-viewer')"
        (click)="focusWindow('image-viewer')"
        title="Image Viewer">
        <i class="pi pi-image"></i>
        <span>{{ currentImageFile()?.name || 'Image Viewer' }}</span>
      </button>

    </div>

    <!-- System Tray -->
    <div class="system-tray">
      <div class="clock" (click)="openClockWindow()" title="Click to open Clock">
        {{ currentTime }}
      </div>
    </div>
  </div>

  <!-- Start Menu -->
  <div *ngIf="showStartMenu()" class="start-menu" (click)="closeStartMenu()">
    <div class="start-menu-content" (click)="$event.stopPropagation()">
      <h3>Applications</h3>
      <div class="start-menu-apps">
        <div class="start-menu-item" (click)="openApp('calculator')">
          <i class="pi pi-calculator"></i>
          <span>Calculator</span>
        </div>
        <div class="start-menu-item" (click)="openApp('my-info')">
          <i class="pi pi-user"></i>
          <span>My Information</span>
        </div>
        <div class="start-menu-item" (click)="openApp('my-page')">
          <i class="pi pi-globe"></i>
          <span>My Page</span>
        </div>
        <div class="start-menu-item" (click)="openApp('love')">
          <i class="pi pi-heart"></i>
          <span>Love</span>
        </div>
        <div class="start-menu-item" (click)="openApp('explorer')">
          <i class="pi pi-folder"></i>
          <span>Explorer</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Desktop Context Menu -->
  <div *ngIf="showDesktopContextMenu()" class="desktop-context-menu" 
       [ngStyle]="{
         left: desktopContextMenuPosition().x + 'px',
         top: desktopContextMenuPosition().y + 'px'
       }"
       (click)="$event.stopPropagation()">
    
    <div class="context-menu-item" (click)="refreshDesktop()">
      <i class="pi pi-refresh"></i>
      <span>Refresh</span>
    </div>
    
    <div class="context-menu-separator"></div>
    
    <div class="context-menu-item" (click)="openSettings()">
      <i class="pi pi-cog"></i>
      <span>Settings</span>
    </div>
  </div>

  <!-- Desktop Context Menu Backdrop -->
  <div *ngIf="showDesktopContextMenu()" class="context-menu-backdrop" 
       (click)="hideDesktopContextMenu()">
  </div>
</div>
