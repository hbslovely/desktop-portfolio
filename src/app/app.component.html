<!-- System Restart Screen -->
<div *ngIf="showRestartScreen()" class="restart-screen">
  <div class="terminal-body" #terminalBody>
    <div *ngFor="let message of restartMessages; let i = index" class="terminal-line" [class]="'terminal-' + message.type">
      <span class="terminal-timestamp" *ngIf="message.timestamp">[{{ message.timestamp }}]</span>
      <span class="terminal-text" [class.typing]="currentTypingIndex() === i">{{ message.text }}</span>
    </div>
    <div class="terminal-cursor-line" *ngIf="showCursor()">
      <span class="terminal-cursor"></span>
    </div>
  </div>
</div>

<!-- Welcome Screen with Desktop Environment -->
<app-welcome-screen>
  <!-- Desktop Environment -->
  <div class="desktop" (contextmenu)="onDesktopRightClick($event)" (click)="hideDesktopContextMenu()">
  <!-- Desktop Wallpaper -->
  <div class="wallpaper"></div>

  <!-- Calculator Window -->
  <app-window
    *ngIf="showTestWindow()"
    title="Calculator"
    icon="calculator"
    statusText="Ready"
    [initialWidth]="320"
    [initialHeight]="480"
    [initialX]="100"
    [initialY]="100"
    [maximizable]="false"
    [zIndex]="getWindowZIndex('calculator')"
    [isFocused]="isWindowFocused('calculator')"
    [isMinimizedExternal]="isWindowMinimized('calculator')"
    data-window-id="calculator"
    (onClose)="onCloseTestWindow()"
    (onMinimize)="onMinimizeTestWindow()"
    (onMaximize)="onMaximizeTestWindow()"
    (onRestore)="onRestoreTestWindow()"
    (onFocus)="onFocusTestWindow()">

    <app-calculator></app-calculator>
  </app-window>

  <!-- My Information Window -->
  <app-window
    *ngIf="showMyInfoWindow()"
    title="About Me"
    icon="user-profile"
    [showStatusBar]="false"
    [initialWidth]="900"
    [initialHeight]="700"
    [initialX]="200"
    [initialY]="50"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('my-info')"
    [isFocused]="isWindowFocused('my-info')"
    [isMinimizedExternal]="isWindowMinimized('my-info')"
    data-window-id="my-info"
    (onClose)="onCloseMyInfoWindow()"
    (onMinimize)="onMinimizeMyInfoWindow()"
    (onMaximize)="onMaximizeMyInfoWindow()"
    (onRestore)="onRestoreMyInfoWindow()"
    (onFocus)="onFocusMyInfoWindow()">

    <app-about-me
      (onOpenApp)="openApp($event)">
    </app-about-me>
  </app-window>


  <!-- Love Window -->
  <app-window
    *ngIf="showLoveWindow()"
    title="Love"
    icon="heart"
    statusText="Loading love website..."
    [initialWidth]="1000"
    [initialHeight]="700"
    [initialX]="200"
    [initialY]="150"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('love')"
    [isFocused]="isWindowFocused('love')"
    [isMinimizedExternal]="isWindowMinimized('love')"
    (onClose)="onCloseLoveWindow()"
    (onMinimize)="onMinimizeLoveWindow()"
    (onMaximize)="onMaximizeLoveWindow()"
    (onRestore)="onRestoreLoveWindow()"
    (onFocus)="onFocusLoveWindow()">

    <app-love-app
      url="https://hbslovely.vercel.app/"
      title="Love Application">
    </app-love-app>
  </app-window>

  <!-- Explorer Window -->
  <app-window
    *ngIf="showExplorerWindow()"
    title="Explorer"
    icon="pi pi-folder"
    statusText="Ready"
    [initialWidth]="800"
    [initialHeight]="600"
    [initialX]="300"
    [initialY]="100"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('explorer')"
    [isFocused]="isWindowFocused('explorer')"
    [isMinimizedExternal]="isWindowMinimized('explorer')"
    (onClose)="onCloseExplorerWindow()"
    (onMinimize)="onMinimizeExplorerWindow()"
    (onMaximize)="onMaximizeExplorerWindow()"
    (onRestore)="onRestoreExplorerWindow()"
    (onFocus)="onFocusExplorerWindow()">

    <app-explorer
      (onFileOpen)="onExplorerFileOpen($event)"
      (onContextMenuAction)="onExplorerContextMenu($event)">
    </app-explorer>
  </app-window>

  <!-- Family Finance Tracker Window -->
  <app-window
    *ngIf="showCreditWindow()"
    title="Family Finance Tracker"
    icon="pi pi-wallet"
    statusText="Ready"
    [initialWidth]="900"
    [initialHeight]="700"
    [initialX]="200"
    [initialY]="100"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('credit')"
    [isFocused]="isWindowFocused('credit')"
    [isMinimizedExternal]="isWindowMinimized('credit')"
    (onClose)="onCloseCreditWindow()"
    (onMinimize)="onMinimizeCreditWindow()"
    (onMaximize)="onMaximizeCreditWindow()"
    (onRestore)="onRestoreCreditWindow()"
    (onFocus)="onFocusCreditWindow()">

    <app-credit-app (onOpenMyInfo)="openApp('my-info')"></app-credit-app>
  </app-window>

  <!-- Paint Window -->
  <app-window
    *ngIf="showPaintWindow()"
    title="Paint"
    icon="pi pi-palette"
    statusText="Ready"
    [initialWidth]="1000"
    [initialHeight]="800"
    [initialX]="150"
    [initialY]="50"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('paint')"
    [isFocused]="isWindowFocused('paint')"
    [isMinimizedExternal]="isWindowMinimized('paint')"
    (onClose)="onClosePaintWindow()"
    (onMinimize)="onMinimizePaintWindow()"
    (onMaximize)="onMaximizePaintWindow()"
    (onRestore)="onRestorePaintWindow()"
    (onFocus)="onFocusPaintWindow()">

    <app-paint-app></app-paint-app>
  </app-window>

  <!-- Credits Window -->
  <app-window
    *ngIf="showCreditsWindow()"
    title="Credits"
    icon="pi pi-star"
    statusText="Rolling..."
    [initialWidth]="1000"
    [initialHeight]="700"
    [initialX]="100"
    [initialY]="50"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('credits')"
    [isFocused]="isWindowFocused('credits')"
    [isMinimizedExternal]="isWindowMinimized('credits')"
    (onClose)="onCloseCreditsWindow()"
    (onMinimize)="onMinimizeCreditsWindow()"
    (onMaximize)="onMaximizeCreditsWindow()"
    (onRestore)="onRestoreCreditsWindow()"
    (onFocus)="onFocusCreditsWindow()">

    <app-credits-app></app-credits-app>
  </app-window>

  <!-- Ho Chi Minh City Window -->
  <app-window
    *ngIf="showHcmcWindow()"
    title="Ho Chi Minh City"
    icon="pi pi-globe"
    statusText="Welcome to Saigon"
    [initialWidth]="1000"
    [initialHeight]="700"
    [initialX]="100"
    [initialY]="50"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('hcmc')"
    [isFocused]="isWindowFocused('hcmc')"
    [isMinimizedExternal]="isWindowMinimized('hcmc')"
    (onClose)="onCloseHcmcWindow()"
    (onMinimize)="onMinimizeHcmcWindow()"
    (onMaximize)="onMaximizeHcmcWindow()"
    (onRestore)="onRestoreHcmcWindow()"
    (onFocus)="onFocusHcmcWindow()">

    <app-hcmc-app></app-hcmc-app>
  </app-window>

  <!-- News Window -->
  <app-window
    *ngIf="showNewsWindow() || isWindowMinimized('news')"
    title="News Headlines"
    icon="pi pi-globe"
    statusText="Latest News"
    [initialWidth]="1000"
    [initialHeight]="700"
    [initialX]="250"
    [initialY]="100"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('news')"
    [isFocused]="isWindowFocused('news')"
    (onClose)="onCloseNewsWindow()"
    (onMinimize)="onMinimizeNewsWindow()"
    (onMaximize)="onMaximizeNewsWindow()"
    (onRestore)="onRestoreNewsWindow()"
    (onFocus)="onFocusNewsWindow()">

    <app-news-app></app-news-app>
  </app-window>

  <!-- Text Viewer Window -->
  <app-window
    *ngIf="showTextViewerWindow() && currentTextFile()"
    [title]="'Text Viewer - ' + currentTextFile()!.name"
    icon="pi pi-file"
    statusText="Ready"
    [initialWidth]="800"
    [initialHeight]="600"
    [initialX]="350"
    [initialY]="120"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('text-viewer')"
    [isFocused]="isWindowFocused('text-viewer')"
    [isMinimizedExternal]="isWindowMinimized('text-viewer')"
    (onClose)="onCloseTextViewerWindow()"
    (onMinimize)="onMinimizeTextViewerWindow()"
    (onMaximize)="onMaximizeTextViewerWindow()"
    (onRestore)="onRestoreTextViewerWindow()"
    (onFocus)="onFocusTextViewerWindow()">

    <app-text-viewer
      [filePath]="currentTextFile()!.path"
      [fileName]="currentTextFile()!.name"
      [fileType]="currentTextFile()!.type">
    </app-text-viewer>
  </app-window>

  <!-- Image Viewer Window -->
  <app-window
    *ngIf="showImageViewerWindow() && currentImageFile()"
    [title]="'Image Viewer - ' + currentImageFile()!.name"
    icon="pi pi-image"
    statusText="Ready"
    [initialWidth]="900"
    [initialHeight]="700"
    [initialX]="400"
    [initialY]="80"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('image-viewer')"
    [isFocused]="isWindowFocused('image-viewer')"
    [isMinimizedExternal]="isWindowMinimized('image-viewer')"
    (onClose)="onCloseImageViewerWindow()"
    (onMinimize)="onMinimizeImageViewerWindow()"
    (onMaximize)="onMaximizeImageViewerWindow()"
    (onRestore)="onRestoreImageViewerWindow()"
    (onFocus)="onFocusImageViewerWindow()">

    <app-image-viewer
      [imagePath]="currentImageFile()!.path"
      [imageName]="currentImageFile()!.name">
    </app-image-viewer>
  </app-window>

  <!-- PDF Viewer Window -->
  <app-window
    *ngIf="showPdfViewerWindow() && currentPdfFile()"
    [title]="'PDF Viewer - ' + currentPdfFile()!.name"
    icon="pi pi-file-pdf"
    statusText="Ready"
    [initialWidth]="1000"
    [initialHeight]="800"
    [initialX]="350"
    [initialY]="60"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('pdf-viewer')"
    [isFocused]="isWindowFocused('pdf-viewer')"
    [isMinimizedExternal]="isWindowMinimized('pdf-viewer')"
    (onClose)="onClosePdfViewerWindow()"
    (onMinimize)="onMinimizePdfViewerWindow()"
    (onMaximize)="onMaximizePdfViewerWindow()"
    (onRestore)="onRestorePdfViewerWindow()"
    (onFocus)="onFocusPdfViewerWindow()">

    <app-pdf-viewer
      [pdfPath]="currentPdfFile()!.path">
    </app-pdf-viewer>
  </app-window>

  <!-- Machine Info Window -->
  <app-window
    *ngIf="showMachineInfoWindow()"
    title="System Information"
    icon="pi pi-desktop"
    statusText="Ready"
    [initialWidth]="1000"
    [initialHeight]="700"
    [initialX]="200"
    [initialY]="100"
    [maximizable]="true"
    [zIndex]="getWindowZIndex('machine-info')"
    [isFocused]="isWindowFocused('machine-info')"
    [isMinimizedExternal]="isWindowMinimized('machine-info')"
    (onClose)="onCloseMachineInfoWindow()"
    (onMinimize)="onMinimizeMachineInfoWindow()"
    (onMaximize)="onMaximizeMachineInfoWindow()"
    (onRestore)="onRestoreMachineInfoWindow()"
    (onFocus)="onFocusMachineInfoWindow()">

    <app-machine-info></app-machine-info>
  </app-window>

  <!-- Floating Clock Widget -->
  <div *ngIf="showClockWindow()" class="floating-clock-widget">
    <div class="clock-widget-header">
      <span class="clock-title">Clock</span>
      <div class="clock-controls">
        <button class="mode-toggle-btn" (click)="toggleClockMode()" [title]="clockMode === 'digital' ? 'Switch to Analog' : 'Switch to Digital'">
          <i [class]="clockMode === 'digital' ? 'pi pi-clock' : 'pi pi-calendar-times'"></i>
        </button>
        <button class="close-btn" (click)="onCloseClockWindow()" title="Close">
          <i class="pi pi-times"></i>
        </button>
      </div>
    </div>
    <div class="clock-app">
      <!-- Digital Clock Mode -->
      <div *ngIf="clockMode === 'digital'" class="digital-clock">
        <div class="time-display">{{ currentTime }}</div>
        <div class="date-display">{{ currentDate }}</div>
      </div>

      <!-- Analog Clock Mode -->
      <div *ngIf="clockMode === 'analog'" class="analog-clock">
        <div class="clock-face">
          <!-- Hour tick marks -->
          <div class="tick-marks">
            <div class="tick" *ngFor="let tick of [1,2,3,4,5,6,7,8,9,10,11,12]" [style.transform]="'rotate(' + (tick * 30) + 'deg)'"></div>
          </div>
          <!-- Clock numbers -->
          <div class="clock-numbers">
            <div class="number" *ngFor="let num of clockNumbers" [style.transform]="'rotate(' + (num * 30) + 'deg) translateY(-75px) rotate(' + (-num * 30) + 'deg)'">{{ num }}</div>
          </div>
          <!-- Clock hands -->
          <div class="clock-hands">
            <div class="hour-hand" [style.transform]="'rotate(' + hourAngle + 'deg)'"></div>
            <div class="minute-hand" [style.transform]="'rotate(' + minuteAngle + 'deg)'"></div>
            <div class="second-hand" [style.transform]="'rotate(' + secondAngle + 'deg)'"></div>
            <div class="center-dot"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Window -->
  <div *ngIf="showSearchWindow()" class="search-window" (click)="closeSearchWindow()">
    <div class="search-content" (click)="$event.stopPropagation()">
      <!-- Search Header -->
      <div class="search-header">
        <div class="search-title">
          <i class="pi pi-search"></i>
          <span>Search</span>
        </div>
        <button class="search-close-btn" (click)="closeSearchWindow()" title="Close">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <!-- Search Input -->
      <div class="search-input-section">
        <div class="search-input-container">
          <i class="pi pi-search search-icon"></i>
          <input
            #searchInput
            type="text"
            class="search-input"
            placeholder="Type to search applications, files, and web..."
            [(ngModel)]="searchQuery"
            (input)="onSearchInput($event)"
            (keydown.enter)="selectSearchResult(searchResults[selectedSearchIndex])"
            (keydown.arrowdown)="navigateSearchResults(1, $event)"
            (keydown.arrowup)="navigateSearchResults(-1, $event)"
            (keydown.escape)="closeSearchWindow()">
          <div class="search-shortcuts">
            <span class="shortcut-hint">↑↓ Navigate • Enter Open • Esc Close</span>
          </div>
        </div>
      </div>

      <!-- Search Results -->
      <div class="search-results-container" *ngIf="showSearchSuggestions">
        <div class="search-results">
          <div class="search-section" *ngIf="appSearchResults.length > 0">
            <div class="section-title">
              <i class="pi pi-apps"></i>
              <span>Applications</span>
              <span class="result-count">{{ appSearchResults.length }}</span>
            </div>
            <div class="result-item"
                 *ngFor="let result of appSearchResults; let i = index"
                 [class.selected]="getResultIndex('app', i) === selectedSearchIndex"
                 (click)="selectSearchResult(result)">
              <div class="result-icon">
                <i [class]="'pi ' + result.icon"></i>
              </div>
              <div class="result-content">
                <span class="result-name">{{ result.name }}</span>
                <span class="result-description">{{ result.description }}</span>
              </div>
              <div class="result-action">
                <i class="pi pi-arrow-right"></i>
              </div>
            </div>
          </div>

          <div class="search-section" *ngIf="fileSearchResults.length > 0">
            <div class="section-title">
              <i class="pi pi-folder"></i>
              <span>Files</span>
              <span class="result-count">{{ fileSearchResults.length }}</span>
            </div>
            <div class="result-item"
                 *ngFor="let result of fileSearchResults; let i = index"
                 [class.selected]="getResultIndex('file', i) === selectedSearchIndex"
                 (click)="selectSearchResult(result)">
              <div class="result-icon">
                <i [class]="'pi ' + result.icon"></i>
              </div>
              <div class="result-content">
                <span class="result-name">{{ result.name }}</span>
                <span class="result-description">{{ result.description }}</span>
                <span class="result-path">{{ result.path }}</span>
              </div>
              <div class="result-action">
                <i class="pi pi-arrow-right"></i>
              </div>
            </div>
          </div>

          <div class="search-section" *ngIf="webSearchResults.length > 0">
            <div class="section-title">
              <i class="pi pi-globe"></i>
              <span>Web Search</span>
              <span class="result-count">{{ webSearchResults.length }}</span>
            </div>
            <div class="result-item"
                 *ngFor="let result of webSearchResults; let i = index"
                 [class.selected]="getResultIndex('web', i) === selectedSearchIndex"
                 (click)="selectSearchResult(result)">
              <div class="result-icon">
                <i [class]="'pi ' + result.icon"></i>
              </div>
              <div class="result-content">
                <span class="result-name">{{ result.name }}</span>
                <span class="result-description">{{ result.description }}</span>
              </div>
              <div class="result-action">
                <i class="pi pi-external-link"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="search-empty" *ngIf="!showSearchSuggestions && searchQuery.length >= 2">
        <div class="empty-icon">
          <i class="pi pi-search"></i>
        </div>
        <div class="empty-content">
          <h3>No results found</h3>
          <p>Try searching for "{{ searchQuery }}" with different keywords</p>
        </div>
      </div>

      <!-- Welcome State -->
      <div class="search-welcome" *ngIf="searchQuery.length < 2">
        <div class="welcome-content">
          <div class="welcome-icon">
            <i class="pi pi-search"></i>
          </div>
          <h3>Search Everything</h3>
          <p>Find applications, files, and search the web</p>
          <div class="search-examples">
            <div class="example-item">
              <i class="pi pi-calculator"></i>
              <span>Calculator</span>
            </div>
            <div class="example-item">
              <i class="pi pi-file"></i>
              <span>README.md</span>
            </div>
            <div class="example-item">
              <i class="pi pi-globe"></i>
              <span>Angular</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Icons -->
  <app-desktop-icon
    *ngFor="let icon of testIcons"
    [iconData]="icon"
    (onClick)="onDesktopIconSelect($event)"
    (onDoubleClick)="onDesktopIconDoubleClick($event)"
    (onContextMenu)="onDesktopIconContextMenu($event)">
  </app-desktop-icon>

  <!-- Desktop Widgets -->
  <div *ngIf="showDesktopWidgets()" class="desktop-widgets">
    <!-- Weather Widget -->
    <div class="widget weather-widget">
      <div class="widget-header">
        <i class="pi pi-cloud"></i>
        <span>Weather</span>
        <button (click)="loadWeatherWidget()" class="refresh-widget-btn" title="Refresh Weather">
          <i class="pi pi-refresh"></i>
        </button>
      </div>
      <div class="widget-body">
        <div class="weather-compact">
          <div class="weather-main-compact">
            <img *ngIf="currentWeather().iconUrl" [src]="currentWeather().iconUrl" class="weather-icon-compact" [alt]="currentWeather().condition">
            <div class="weather-info-compact">
              <div class="weather-temp-compact">{{ currentWeather().temp }}°C</div>
              <div class="weather-location-compact">{{ currentWeather().location }}</div>
            </div>
          </div>
          <div class="weather-condition-text">{{ currentWeather().condition }}</div>
          <div class="weather-details-compact">
            <span><i class="pi pi-percentage"></i> {{ currentWeather().humidity }}%</span>
            <span><i class="pi pi-compass"></i> {{ currentWeather().wind }} m/s</span>
          </div>
          <button (click)="openWeatherApp()" class="open-weather-app-btn">
            <i class="pi pi-external-link"></i>
            Open Weather App
          </button>
        </div>
      </div>
    </div>

    <!-- Cat Facts Widget -->
    <div class="widget cat-facts-widget">
      <div class="widget-header">
        <i class="pi pi-info-circle"></i>
        <span>Cat Fact</span>
        <button (click)="loadCatFact()" class="refresh-widget-btn" [disabled]="catFactLoading()" title="New Cat Fact">
          <i class="pi pi-refresh" [class.pi-spin]="catFactLoading()"></i>
        </button>
      </div>
      <div class="widget-body">
        <div class="cat-fact-content">
          <div class="cat-icon">🐱</div>
          <p class="fact-text">{{ catFact() }}</p>
        </div>
      </div>
    </div>

    <!-- Daily Advice Widget -->
    <div class="widget advice-widget">
      <div class="widget-header">
        <i class="pi pi-lightbulb"></i>
        <span>Daily Advice</span>
        <button (click)="loadDailyAdvice()" class="refresh-widget-btn" [disabled]="adviceLoading()" title="New Advice">
          <i class="pi pi-refresh" [class.pi-spin]="adviceLoading()"></i>
        </button>
      </div>
      <div class="widget-body">
        <div class="advice-content">
          <div class="advice-icon">💡</div>
          <p class="advice-text">{{ dailyAdvice() }}</p>
        </div>
      </div>
    </div>

    <!-- System Stats Widget -->
    <div class="widget stats-widget">
      <div class="widget-header">
        <i class="pi pi-chart-bar"></i>
        <span>System</span>
      </div>
      <div class="widget-body">
        <div class="stat-item">
          <span class="stat-label">CPU Usage</span>
          <div class="stat-bar">
            <div class="stat-fill" style="width: 45%"></div>
          </div>
          <span class="stat-value">45%</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Memory</span>
          <div class="stat-bar">
            <div class="stat-fill" style="width: 62%"></div>
          </div>
          <span class="stat-value">62%</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Storage</span>
          <div class="stat-bar">
            <div class="stat-fill" style="width: 38%"></div>
          </div>
          <span class="stat-value">38%</span>
        </div>
      </div>
    </div>

    <!-- Random Fox Widget -->
    <div class="widget fox-widget">
      <div class="widget-header">
        <i class="pi pi-image"></i>
        <span>Random Fox</span>
        <button (click)="loadRandomFox()" class="refresh-widget-btn" [disabled]="foxLoading()" title="New Fox">
          <i class="pi pi-refresh" [class.pi-spin]="foxLoading()"></i>
        </button>
      </div>
      <div class="widget-body fox-body">
        <div class="fox-image-container" (click)="openFoxLink()">
          <img [src]="randomFox().image" alt="Random Fox" class="fox-image" />
          <div class="fox-overlay">
            <i class="pi pi-external-link"></i>
            <span>View Full Size</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <!-- Start Button -->
    <button class="start-button" (click)="toggleStartMenu()" title="Start">
      <i class="pi pi-microsoft"></i>
    </button>

    <!-- Search Button -->
    <button class="search-button" (click)="openSearchWindow()" title="Search">
      <i class="pi pi-search"></i>
    </button>

    <!-- Taskbar Apps -->
    <div class="taskbar-apps">
      <button
        *ngIf="showTestWindow() || isWindowMinimized('calculator')"
        class="taskbar-app"
        [class.active]="isWindowFocused('calculator')"
        [class.minimized]="isWindowMinimized('calculator')"
        (click)="toggleTaskbarApp('calculator')"
        title="Calculator">
        <i class="pi pi-calculator"></i>
        <span>Calculator</span>
      </button>

      <button
        *ngIf="showMyInfoWindow() || isWindowMinimized('my-info')"
        class="taskbar-app"
        [class.active]="isWindowFocused('my-info')"
        [class.minimized]="isWindowMinimized('my-info')"
        (click)="toggleTaskbarApp('my-info')"
        title="My Information">
        <i class="pi pi-user"></i>
        <span>My Information</span>
      </button>


      <button
        *ngIf="showLoveWindow() || isWindowMinimized('love')"
        class="taskbar-app"
        [class.active]="isWindowFocused('love')"
        [class.minimized]="isWindowMinimized('love')"
        (click)="toggleTaskbarApp('love')"
        title="Love">
        <i class="pi pi-heart"></i>
        <span>Love</span>
      </button>

      <button
        *ngIf="showExplorerWindow() || isWindowMinimized('explorer')"
        class="taskbar-app"
        [class.active]="isWindowFocused('explorer')"
        [class.minimized]="isWindowMinimized('explorer')"
        (click)="toggleTaskbarApp('explorer')"
        title="Explorer">
        <i class="pi pi-folder"></i>
        <span>Explorer</span>
      </button>

      <button
        *ngIf="showTextViewerWindow() || isWindowMinimized('text-viewer')"
        class="taskbar-app"
        [class.active]="isWindowFocused('text-viewer')"
        [class.minimized]="isWindowMinimized('text-viewer')"
        (click)="toggleTaskbarApp('text-viewer')"
        title="Text Viewer">
        <i class="pi pi-file"></i>
        <span>{{ currentTextFile()?.name || 'Text Viewer' }}</span>
      </button>

      <button
        *ngIf="showImageViewerWindow() || isWindowMinimized('image-viewer')"
        class="taskbar-app"
        [class.active]="isWindowFocused('image-viewer')"
        [class.minimized]="isWindowMinimized('image-viewer')"
        (click)="toggleTaskbarApp('image-viewer')"
        title="Image Viewer">
        <i class="pi pi-image"></i>
        <span>{{ currentImageFile()?.name || 'Image Viewer' }}</span>
      </button>

      <button
        *ngIf="showMachineInfoWindow() || isWindowMinimized('machine-info')"
        class="taskbar-app"
        [class.active]="isWindowFocused('machine-info')"
        [class.minimized]="isWindowMinimized('machine-info')"
        (click)="toggleTaskbarApp('machine-info')"
        title="System Information">
        <i class="pi pi-desktop"></i>
        <span>System Info</span>
      </button>

      <button
        *ngIf="showCreditWindow() || isWindowMinimized('credit')"
        class="taskbar-app"
        [class.active]="isWindowFocused('credit')"
        [class.minimized]="isWindowMinimized('credit')"
        (click)="toggleTaskbarApp('credit')"
        title="Finance Tracker">
        <i class="pi pi-wallet"></i>
        <span>Finance Tracker</span>
      </button>

      <button
        *ngIf="showPaintWindow() || isWindowMinimized('paint')"
        class="taskbar-app"
        [class.active]="isWindowFocused('paint')"
        [class.minimized]="isWindowMinimized('paint')"
        (click)="toggleTaskbarApp('paint')"
        title="Paint">
        <i class="pi pi-palette"></i>
        <span>Paint</span>
      </button>

      <button
        *ngIf="showCreditsWindow() || isWindowMinimized('credits')"
        class="taskbar-app"
        [class.active]="isWindowFocused('credits')"
        [class.minimized]="isWindowMinimized('credits')"
        (click)="toggleTaskbarApp('credits')"
        title="Credits">
        <i class="pi pi-star"></i>
        <span>Credits</span>
      </button>

      <button
        *ngIf="showHcmcWindow() || isWindowMinimized('hcmc')"
        class="taskbar-app"
        [class.active]="isWindowFocused('hcmc')"
        [class.minimized]="isWindowMinimized('hcmc')"
        (click)="toggleTaskbarApp('hcmc')"
        title="Ho Chi Minh City">
        <i class="pi pi-globe"></i>
        <span>HCMC</span>
      </button>

      <button
        *ngIf="showNewsWindow() || isWindowMinimized('news')"
        class="taskbar-app"
        [class.active]="isWindowFocused('news')"
        [class.minimized]="isWindowMinimized('news')"
        (click)="toggleTaskbarApp('news')"
        title="News Headlines">
        <i class="pi pi-globe"></i>
        <span>News</span>
      </button>

    </div>

    <!-- System Tray -->
    <div class="system-tray">
      <button class="widgets-button" (click)="toggleWidgets()" title="Toggle Desktop Widgets">
        <i class="pi pi-th"></i>
      </button>
      <button class="notifications-button" (click)="toggleNotificationsPanel()" title="Notifications">
        <i class="pi pi-bell"></i>
        <span *ngIf="notifications().length > 0" class="notification-badge">{{ notifications().length }}</span>
      </button>
      <button class="lock-button" (click)="lockScreen()" title="Lock Screen">
        <i class="pi pi-lock"></i>
      </button>
      <div class="clock-widget" (click)="openClockWindow()" title="Click to open Clock">
        <div class="clock-time">{{ currentTime }}</div>
        <div class="clock-date">{{ currentShortDate }}</div>
      </div>
    </div>
  </div>

  <!-- Notifications Panel -->
  <div *ngIf="showNotificationsPanel()" class="notifications-panel">
    <div class="notifications-header">
      <h3>Notifications</h3>
      <button (click)="clearAllNotifications()" class="clear-all-btn" *ngIf="notifications().length > 0">
        Clear All
      </button>
    </div>
    <div class="notifications-body">
      <div *ngIf="notifications().length === 0" class="no-notifications">
        <i class="pi pi-check-circle"></i>
        <p>No notifications</p>
      </div>
      <div *ngFor="let notification of notifications()" class="notification-item">
        <div class="notification-icon">
          <i [class]="notification.icon"></i>
        </div>
        <div class="notification-content">
          <h4>{{ notification.title }}</h4>
          <p>{{ notification.message }}</p>
          <span class="notification-time">{{ notification.time }}</span>
        </div>
        <button (click)="clearNotification(notification.id)" class="notification-close">
          <i class="pi pi-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Start Menu -->
  <div *ngIf="showStartMenu()" class="start-menu-backdrop" (click)="closeStartMenu()">
    <div class="start-menu" (click)="$event.stopPropagation()">
      <!-- Search Bar -->
      <div class="start-menu-search">
        <i class="pi pi-search"></i>
        <input type="text" placeholder="Type to search apps..." [(ngModel)]="startMenuSearch">
      </div>

      <!-- Scrollable Content -->
      <div class="start-menu-content">
        <!-- Pinned Apps Section -->
        <div class="start-section pinned-section">
          <div class="section-header">
            <h3>Pinned</h3>
          </div>
          <div class="app-grid">
            <div class="app-tile" (click)="openApp('calculator')" title="Calculator">
              <div class="app-tile-icon">
                <i class="pi pi-calculator"></i>
              </div>
              <span class="app-tile-name">Calculator</span>
            </div>
            <div class="app-tile" (click)="openApp('explorer')" title="File Explorer">
              <div class="app-tile-icon">
                <i class="pi pi-folder"></i>
              </div>
              <span class="app-tile-name">Explorer</span>
            </div>
            <div class="app-tile" (click)="openApp('paint')" title="Paint">
              <div class="app-tile-icon">
                <i class="pi pi-palette"></i>
              </div>
              <span class="app-tile-name">Paint</span>
            </div>
            <div class="app-tile" (click)="openApp('my-info')" title="My Information">
              <div class="app-tile-icon">
                <i class="pi pi-user"></i>
              </div>
              <span class="app-tile-name">My Information</span>
            </div>
            <div class="app-tile" (click)="openApp('news')" title="News">
              <div class="app-tile-icon">
                <i class="pi pi-globe"></i>
              </div>
              <span class="app-tile-name">News</span>
            </div>
            <div class="app-tile" (click)="openApp('hcmc')" title="HCMC">
              <div class="app-tile-icon">
                <i class="pi pi-map-marker"></i>
              </div>
              <span class="app-tile-name">HCMC</span>
            </div>
          </div>
        </div>

        <!-- All Apps Section -->
        <div class="start-section all-apps-section">
          <div class="section-header">
            <h3>All Apps</h3>
          </div>
          <div class="app-list">
            <ng-container *ngIf="filteredStartMenuGroups().length > 0; else noResults">
              <ng-container *ngFor="let group of filteredStartMenuGroups()">
                <!-- Group Label -->
                <div class="app-list-group-label">{{ group.name }}</div>
                <!-- Apps in Group -->
                <div class="app-list-item"
                     *ngFor="let app of group.apps"
                     (click)="openApp(app.id)"
                     [title]="app.name">
                  <div class="app-list-icon">
                    <i [class]="app.icon"></i>
                  </div>
                  <span class="app-list-name">{{ app.name }}</span>
                </div>
              </ng-container>
            </ng-container>
            <ng-template #noResults>
              <div class="no-results">
                <i class="pi pi-search"></i>
                <p>No apps found for "{{ startMenuSearch() }}"</p>
              </div>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="start-menu-footer">
        <div class="user-profile" (click)="openApp('my-info')">
          <div class="user-avatar">
            <i class="pi pi-user"></i>
          </div>
          <span class="user-name">hpphat1992</span>
        </div>
        <div class="footer-actions">
          <button class="footer-btn settings-btn" (click)="openApp('settings')" title="Open Settings">
            <i class="pi pi-cog"></i>
            <span class="btn-label">Settings</span>
          </button>
          <button class="footer-btn lock-btn" (click)="lockScreen()" title="Lock Screen">
            <i class="pi pi-lock"></i>
            <span class="btn-label">Lock</span>
          </button>
          <button class="footer-btn restart-btn" (click)="restartSystem()" title="Restart System">
            <i class="pi pi-refresh"></i>
            <span class="btn-label">Restart</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Desktop Context Menu -->
  <div *ngIf="showDesktopContextMenu()" class="desktop-context-menu"
       [ngStyle]="{
         left: desktopContextMenuPosition().x + 'px',
         top: desktopContextMenuPosition().y + 'px'
       }"
       (click)="$event.stopPropagation()">

    <div class="context-menu-item" (click)="refreshDesktop()">
      <i class="pi pi-refresh"></i>
      <span>Refresh</span>
    </div>

    <div class="context-menu-separator"></div>

    <div class="context-menu-item" (click)="openSettings()">
      <i class="pi pi-cog"></i>
      <span>Settings</span>
    </div>
  </div>

  <!-- Desktop Context Menu Backdrop -->
  <div *ngIf="showDesktopContextMenu()" class="context-menu-backdrop"
       (click)="hideDesktopContextMenu()">
  </div>
  </div>
</app-welcome-screen>

<!-- Settings Dialog -->
<app-settings-dialog
  [isVisible]="showSettingsDialog()"
  (onClose)="closeSettingsDialog()"
  (onSettingsChange)="onSettingsChange($event)">
</app-settings-dialog>

<!-- Dynamic Windows from WindowManager -->
<ng-container *ngFor="let window of windowManager.windowList()">
  <app-window
    *ngIf="!window.isMinimized || windowManager.isWindowOpen(window.id)"
    [title]="window.title"
    [icon]="window.icon"
    [initialWidth]="window.initialWidth"
    [initialHeight]="window.initialHeight"
    [initialX]="window.initialX"
    [initialY]="window.initialY"
    [maximizable]="window.maximizable"
    [zIndex]="window.zIndex"
    [isFocused]="window.isFocused"
    [isMinimizedExternal]="window.isMinimized"
    (onClose)="windowManager.closeWindow(window.id)"
    (onMinimize)="windowManager.minimizeWindow(window.id)"
    (onMaximize)="windowManager.maximizeWindow(window.id)"
    (onRestore)="windowManager.restoreWindow(window.id)"
    (onFocus)="windowManager.focusWindow(window.id)">

    <!-- Dynamic Component Rendering -->
    <ng-container [ngSwitch]="window.component">
      <app-calculator *ngSwitchCase="'calculator'"></app-calculator>

      <app-iframe-app
        url="https://hpphat1992.vercel.app"
        *ngSwitchCase="'my-info'"></app-iframe-app>

      <app-love-app *ngSwitchCase="'love'"></app-love-app>

      <app-explorer *ngSwitchCase="'explorer'"
        (onFileOpen)="onExplorerFileOpen($event)"
        (onContextMenuAction)="onExplorerContextMenu($event)">
      </app-explorer>

      <app-text-viewer *ngSwitchCase="'text-viewer'"
        [filePath]="window.data?.path"
        [fileName]="window.data?.name"
        [fileType]="window.data?.type">
      </app-text-viewer>

      <app-image-viewer *ngSwitchCase="'image-viewer'"
        [imagePath]="window.data?.path"
        [imageName]="window.data?.name">
      </app-image-viewer>

      <app-pdf-viewer *ngSwitchCase="'pdf-viewer'"
        [pdfPath]="window.data?.path">
      </app-pdf-viewer>

      <app-machine-info *ngSwitchCase="'machine-info'"></app-machine-info>

      <app-credit-app *ngSwitchCase="'credit'" (onOpenMyInfo)="openApp('my-info')"></app-credit-app>

      <app-paint-app *ngSwitchCase="'paint'"></app-paint-app>

      <app-credits-app *ngSwitchCase="'credits'"></app-credits-app>

      <app-hcmc-app *ngSwitchCase="'hcmc'"></app-hcmc-app>

      <app-news-app *ngSwitchCase="'news'"></app-news-app>

      <app-settings-app *ngSwitchCase="'settings'"
        (onSettingsChange)="onSettingsChange($event)">
      </app-settings-app>
      <app-task-manager *ngSwitchCase="'task-manager'"></app-task-manager>
      <app-weather-app *ngSwitchCase="'weather'"></app-weather-app>
      <app-dictionary-app *ngSwitchCase="'dictionary'"></app-dictionary-app>
      <app-link-shortener *ngSwitchCase="'link-shortener'"></app-link-shortener>
      <app-countries-app *ngSwitchCase="'countries'"></app-countries-app>

      <app-yugioh-app *ngSwitchCase="'yugioh'"></app-yugioh-app>

      <app-yugioh-card-detail 
        *ngSwitchCase="'yugioh-card-detail'"
        [cardId]="window.data?.cardId"
        [cardName]="window.data?.cardName">
      </app-yugioh-card-detail>

      <app-vnstock-app *ngSwitchCase="'vnstock'"></app-vnstock-app>
    </ng-container>
  </app-window>
</ng-container>
