<div class="chat-container">
  <!-- Lobby View -->
  @if (viewMode() === 'lobby') {
    <div class="lobby">
      <div class="lobby-card">
        <div class="lobby-header">
          <div class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4"/>
            </svg>
          </div>
          <h1>Video Chat</h1>
          <p class="subtitle">Connect with others using WebRTC</p>
        </div>
        
        <div class="lobby-form">
          <div class="input-group">
            <label for="userName">Your Name</label>
            <input 
              id="userName"
              type="text" 
              [value]="userName()"
              (input)="updateUserName($any($event.target).value)"
              placeholder="Enter your name"
              autocomplete="off"
            />
          </div>
          
          <div class="action-buttons">
            <button class="btn btn-primary" (click)="createRoom()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="16"/>
                <line x1="8" y1="12" x2="16" y2="12"/>
              </svg>
              Create Room
            </button>
          </div>
          
          <div class="divider">
            <span>or join existing</span>
          </div>
          
          <div class="input-group">
            <label for="roomId">Room ID</label>
            <input 
              id="roomId"
              type="text" 
              [value]="roomIdInput()"
              (input)="updateRoomId($any($event.target).value)"
              placeholder="Enter room ID (e.g., ABC123)"
              autocomplete="off"
              class="room-input"
            />
          </div>
          
          <button class="btn btn-secondary" (click)="joinRoom()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
              <polyline points="10 17 15 12 10 7"/>
              <line x1="15" y1="12" x2="3" y2="12"/>
            </svg>
            Join Room
          </button>
        </div>
        
        <div class="lobby-footer">
          <p>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            Peer-to-peer encrypted connection
          </p>
        </div>
      </div>
    </div>
  }
  
  <!-- Chat View -->
  @if (viewMode() === 'chat') {
    <div class="chat-room" [class.chat-collapsed]="isChatCollapsed()">
      <!-- Video Section -->
      <div class="video-section">
        <!-- Room Info Bar -->
        <div class="room-info-bar">
          <div class="room-id">
            <span class="label">Room:</span>
            <span class="value">{{ roomId() }}</span>
            <button class="copy-btn" (click)="copyRoomId()" [title]="isCopied() ? 'Copied!' : 'Copy Room ID'">
              @if (isCopied()) {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
              }
            </button>
          </div>
          <div class="connection-status" [class]="connectionStatus()">
            <span class="status-dot"></span>
            {{ connectionStatus() | titlecase }}
          </div>
        </div>
        
        <!-- Layout Toggle (only show when screen sharing) -->
        @if (localScreenStream() || remoteScreenShares().size > 0) {
          <div class="layout-toggle">
            <button 
              class="layout-btn" 
              [class.active]="layoutMode() === 'focus'"
              (click)="layoutMode.set('focus')"
              title="Focus Layout"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="12" rx="2"/>
                <rect x="3" y="17" width="5" height="4" rx="1"/>
                <rect x="10" y="17" width="5" height="4" rx="1"/>
                <rect x="17" y="17" width="4" height="4" rx="1"/>
              </svg>
              Focus
            </button>
            <button 
              class="layout-btn" 
              [class.active]="layoutMode() === 'grid'"
              (click)="layoutMode.set('grid')"
              title="Grid Layout"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="8" height="8" rx="1"/>
                <rect x="13" y="3" width="8" height="8" rx="1"/>
                <rect x="3" y="13" width="8" height="8" rx="1"/>
                <rect x="13" y="13" width="8" height="8" rx="1"/>
              </svg>
              Grid
            </button>
          </div>
        }
        
        <!-- Video Grid -->
        <div class="video-grid" 
             [class.has-screen-share]="localScreenStream() || remoteScreenShares().size > 0"
             [class.focus-layout]="layoutMode() === 'focus'"
             [class.grid-layout]="layoutMode() === 'grid'">
          
          <!-- Screen Share Videos (shown prominently in focus mode) -->
          @if (localScreenStream()) {
            <div class="video-wrapper screen-share" 
                 [class.featured]="layoutMode() === 'focus'"
                 [class.fullscreen-video]="fullscreenVideoId() === 'local-screen'">
              <video 
                autoplay 
                muted 
                playsinline
                [srcObject]="localScreenStream()"
                (dblclick)="toggleVideoFullscreen('local-screen')"
              ></video>
              <div class="video-label screen-share-label">
                <div class="share-indicator">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                    <line x1="8" y1="21" x2="16" y2="21"/>
                    <line x1="12" y1="17" x2="12" y2="21"/>
                  </svg>
                  <span>You are sharing your screen</span>
                </div>
                <div class="video-controls">
                  <button class="video-control-btn stop-share" (click)="toggleScreenShare()" title="Stop sharing">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"/>
                      <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                    Stop
                  </button>
                  <button class="video-control-btn" (click)="toggleVideoFullscreen('local-screen')" title="Fullscreen">
                    @if (fullscreenVideoId() === 'local-screen') {
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
                      </svg>
                    } @else {
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                      </svg>
                    }
                  </button>
                </div>
              </div>
            </div>
          }
          
          <!-- Remote Screen Shares -->
          @for (entry of remoteScreenShares() | keyvalue; track entry.key) {
            <div class="video-wrapper screen-share" 
                 [class.featured]="layoutMode() === 'focus'"
                 [class.fullscreen-video]="fullscreenVideoId() === 'screen-' + entry.key">
              <video 
                autoplay 
                playsinline
                [srcObject]="entry.value"
                (dblclick)="toggleVideoFullscreen('screen-' + entry.key)"
              ></video>
              <div class="video-label screen-share-label">
                <div class="share-indicator">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                    <line x1="8" y1="21" x2="16" y2="21"/>
                    <line x1="12" y1="17" x2="12" y2="21"/>
                  </svg>
                  <span>{{ getParticipantName(entry.key) }} is sharing their screen</span>
                </div>
                <div class="video-controls">
                  <button class="video-control-btn" (click)="toggleVideoFullscreen('screen-' + entry.key)" title="Fullscreen">
                    @if (fullscreenVideoId() === 'screen-' + entry.key) {
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
                      </svg>
                    } @else {
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                      </svg>
                    }
                  </button>
                </div>
              </div>
            </div>
          }
          
          <!-- Cameras Container (for focus layout) -->
          @if (layoutMode() === 'focus' && (localScreenStream() || remoteScreenShares().size > 0)) {
            <div class="cameras-strip">
              <!-- Local Camera -->
              <div class="video-wrapper local camera-tile" [class.speaking]="isSpeaking()">
                <video
                  #localVideo
                  autoplay
                  muted
                  playsinline
                  [srcObject]="localStream()"
                  [class.video-off]="!isVideoEnabled()"
                ></video>
                @if (!isVideoEnabled()) {
                  <div class="video-placeholder">
                    <div class="avatar">{{ userName().charAt(0).toUpperCase() }}</div>
                    <span>You</span>
                  </div>
                } @else {
                  <div class="video-avatar-overlay mini">
                    <div class="mini-avatar">{{ userName().charAt(0).toUpperCase() }}</div>
                    <span class="mini-name">You</span>
                  </div>
                }
              </div>
              
              <!-- Remote Cameras -->
              @for (entry of remoteStreams() | keyvalue; track entry.key) {
                <div class="video-wrapper remote camera-tile" [class.speaking]="isPeerSpeaking(entry.key)">
                  <video 
                    autoplay
                    playsinline
                    [srcObject]="entry.value"
                    [class.video-off]="!isParticipantVideoEnabled(entry.key)"
                  ></video>
                  @if (!isParticipantVideoEnabled(entry.key)) {
                    <div class="video-placeholder">
                      <div class="avatar">{{ getAvatarLetter(getParticipantName(entry.key)) }}</div>
                      <span>{{ getParticipantName(entry.key) }}</span>
                    </div>
                  } @else {
                    <div class="video-avatar-overlay mini">
                      <div class="mini-avatar remote">{{ getAvatarLetter(getParticipantName(entry.key)) }}</div>
                      <span class="mini-name">{{ getParticipantName(entry.key) }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          } @else {
            <!-- Grid Layout or No Screen Share - Show all videos normally -->
            
            <!-- Local Video (Camera) -->
            <div class="video-wrapper local" [class.speaking]="isSpeaking()">
              <video 
                #localVideo 
                autoplay 
                muted 
                playsinline
                [srcObject]="localStream()"
                [class.video-off]="!isVideoEnabled()"
              ></video>
              @if (!isVideoEnabled()) {
                <div class="video-placeholder">
                  <div class="avatar">{{ userName().charAt(0).toUpperCase() }}</div>
                  <span>{{ userName() }} (You)</span>
                </div>
              } @else {
                <!-- Mini avatar overlay when video is ON -->
                <div class="video-avatar-overlay">
                  <div class="mini-avatar">{{ userName().charAt(0).toUpperCase() }}</div>
                  <span class="mini-name">{{ userName() }} (You)</span>
                  @if (!isAudioEnabled()) {
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mini-muted">
                      <line x1="1" y1="1" x2="23" y2="23"/>
                      <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/>
                    </svg>
                  }
                </div>
              }
            </div>
          }
          
          <!-- Remote Videos (Cameras) - Only in grid layout or no screen share -->
          @if (layoutMode() === 'grid' || (!localScreenStream() && remoteScreenShares().size === 0)) {
            @for (entry of remoteStreams() | keyvalue; track entry.key) {
              <div class="video-wrapper remote" 
                   [class.fullscreen-video]="fullscreenVideoId() === entry.key"
                   [class.speaking]="isPeerSpeaking(entry.key)">
                <video 
                  #remoteVideo 
                  autoplay 
                  playsinline
                  [srcObject]="entry.value"
                  [class.video-off]="!isParticipantVideoEnabled(entry.key)"
                  (dblclick)="toggleVideoFullscreen(entry.key)"
                ></video>
                
                <!-- Avatar when video is off -->
                @if (!isParticipantVideoEnabled(entry.key)) {
                  <div class="video-placeholder">
                    <div class="avatar">{{ getAvatarLetter(getParticipantName(entry.key)) }}</div>
                    <span>{{ getParticipantName(entry.key) }}</span>
                  </div>
                } @else {
                  <!-- Mini avatar overlay when video is ON -->
                  <div class="video-avatar-overlay">
                    <div class="mini-avatar remote">{{ getAvatarLetter(getParticipantName(entry.key)) }}</div>
                    <span class="mini-name">{{ getParticipantName(entry.key) }}</span>
                    @if (!isParticipantAudioEnabled(entry.key)) {
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mini-muted">
                        <line x1="1" y1="1" x2="23" y2="23"/>
                        <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/>
                      </svg>
                    }
                  </div>
                }
                
                <!-- Fullscreen button (shown on hover) -->
                <button class="fullscreen-btn" (click)="toggleVideoFullscreen(entry.key)" title="Fullscreen">
                  @if (fullscreenVideoId() === entry.key) {
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
                    </svg>
                  } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                    </svg>
                  }
                </button>
              </div>
            }
          }
          
          <!-- Empty state when no remote participants -->
          @if (remoteStreams().size === 0 && (!localScreenStream() && remoteScreenShares().size === 0)) {
            <div class="video-wrapper empty">
              <div class="waiting-message">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <p>Waiting for others to join...</p>
                <p class="hint">Share the Room ID: <strong>{{ roomId() }}</strong></p>
              </div>
            </div>
          }
        </div>
        
        <!-- Live Captions Overlay -->
        @if (isCaptionsEnabled()) {
          <div class="captions-container">
            @if (currentCaption()) {
              <div class="caption-bubble" [class.final]="currentCaption()!.isFinal">
                <span class="caption-speaker">{{ currentCaption()!.speakerName }}:</span>
                <span class="caption-text">{{ currentCaption()!.text }}</span>
              </div>
            }
            
            <!-- Recent captions history -->
            <div class="captions-history">
              @for (caption of captions().slice(-3); track caption.id) {
                <div class="caption-history-item">
                  <span class="speaker">{{ caption.speakerName }}:</span>
                  <span class="text">{{ caption.text }}</span>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- Control Bar -->
        <div class="control-bar">
          <button 
            class="control-btn" 
            [class.off]="!isAudioEnabled()"
            (click)="toggleAudio()"
            [title]="isAudioEnabled() ? 'Mute' : 'Unmute'"
          >
            @if (isAudioEnabled()) {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
              </svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="1" y1="1" x2="23" y2="23"/>
                <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/>
                <path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
              </svg>
            }
          </button>
          
          <button 
            class="control-btn" 
            [class.off]="!isVideoEnabled()"
            (click)="toggleVideo()"
            [title]="isVideoEnabled() ? 'Turn off camera' : 'Turn on camera'"
          >
            @if (isVideoEnabled()) {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="23 7 16 12 23 17 23 7"/>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
              </svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16.5 17.5L1 1"/>
                <path d="M22 8l-5 3 5 3v-6z"/>
                <path d="M21.3 12.8A4 4 0 0 1 21 14v2a2 2 0 0 1-2 2H7"/>
                <path d="M7.8 4H19a2 2 0 0 1 2 2v.5"/>
                <path d="M3 3l18 18"/>
              </svg>
            }
          </button>
          
          <button 
            class="control-btn" 
            [class.active]="isScreenSharing()"
            (click)="toggleScreenShare()"
            title="Share screen"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
              <line x1="8" y1="21" x2="16" y2="21"/>
              <line x1="12" y1="17" x2="12" y2="21"/>
            </svg>
          </button>
          
          <!-- Live Captions (CC) Button -->
          <div class="caption-control">
            <button 
              class="control-btn cc-btn"
              [class.active]="isCaptionsEnabled()"
              [class.unsupported]="!isSpeechRecognitionSupported()"
              (click)="toggleCaptions()"
              [title]="isCaptionsEnabled() ? 'Turn off captions' : 'Turn on captions (CC)'"
              [disabled]="!isSpeechRecognitionSupported()"
            >
              <span class="cc-text">CC</span>
            </button>
            <button 
              class="lang-btn"
              (click)="toggleLanguageMenu()"
              [title]="'Language: ' + getCurrentLanguageName()"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </button>
            
            <!-- Language Menu -->
            @if (showLanguageMenu()) {
              <div class="language-menu">
                <div class="language-menu-header">Caption Language</div>
                @for (lang of languages; track lang.code) {
                  <button 
                    class="language-option"
                    [class.active]="captionLanguage() === lang.code"
                    (click)="setCaptionLanguage(lang.code)"
                  >
                    {{ lang.name }}
                    @if (captionLanguage() === lang.code) {
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                    }
                  </button>
                }
              </div>
            }
          </div>
          
          <button 
            class="control-btn chat-toggle-btn"
            [class.active]="!isChatCollapsed()"
            (click)="toggleChat()"
            title="Toggle chat"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            @if (unreadMessages() > 0) {
              <span class="notification-badge">{{ unreadMessages() > 99 ? '99+' : unreadMessages() }}</span>
            }
          </button>
          
          <button 
            class="control-btn"
            (click)="toggleFullscreen()"
            title="Toggle fullscreen"
          >
            @if (isFullscreen()) {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
              </svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
              </svg>
            }
          </button>
          
          <button 
            class="control-btn leave"
            (click)="leaveRoom()"
            title="Leave room"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
              <polyline points="16 17 21 12 16 7"/>
              <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Chat Section -->
      <div class="chat-section" [class.collapsed]="isChatCollapsed()">
        <div class="chat-header">
          <div class="chat-header-left">
            <h3>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              Chat
            </h3>
            <span class="message-count">{{ messages().length }}</span>
          </div>
          <button class="collapse-btn" (click)="toggleChat()" title="Collapse chat">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
        </div>
          
          <div class="messages" #messagesContainer>
            @for (message of messages(); track message.id) {
              <div 
                class="message" 
                [class.own]="isOwnMessage(message)"
                [class.system]="message.type === 'system'"
              >
                @if (message.type === 'system') {
                  <div class="system-message">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="16" x2="12" y2="12"/>
                      <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    {{ message.text }}
                  </div>
                } @else if (message.type === 'file' && message.file) {
                  <!-- File Message -->
                  <div class="message-bubble file-message">
                    @if (!isOwnMessage(message)) {
                      <span class="sender">{{ message.sender }}</span>
                    }
                    
                    <div class="file-content">
                      <!-- Image Preview -->
                      @if (isImageFile(message.file) && message.file.url && message.file.status === 'completed') {
                        <div class="file-image-preview">
                          <img [src]="message.file.url" [alt]="message.file.name" (click)="downloadFile(message.file)" />
                        </div>
                      }
                      
                      <div class="file-info" (click)="message.file.status === 'completed' && downloadFile(message.file)">
                        <div class="file-icon">{{ getFileIcon(message.file.type) }}</div>
                        <div class="file-details">
                          <span class="file-name">{{ message.file.name }}</span>
                          <span class="file-size">{{ formatFileSize(message.file.size) }}</span>
                        </div>
                        
                        @if (message.file.status === 'transferring') {
                          <div class="file-progress">
                            <div class="progress-bar" [style.width.%]="message.file.progress || 0"></div>
                          </div>
                        } @else if (message.file.status === 'completed') {
                          <button class="download-btn" title="Download">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                              <polyline points="7 10 12 15 17 10"/>
                              <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                          </button>
                        }
                      </div>
                    </div>
                    
                    <span class="time">{{ formatTime(message.timestamp) }}</span>
                  </div>
                } @else {
                  <!-- Regular Text Message -->
                  <div class="message-bubble">
                    @if (!isOwnMessage(message)) {
                      <span class="sender">{{ message.sender }}</span>
                    }
                    <p class="text">{{ message.text }}</p>
                    <span class="time">{{ formatTime(message.timestamp) }}</span>
                  </div>
                }
              </div>
            }
            
            @if (messages().length === 0) {
              <div class="no-messages">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
                <p>No messages yet</p>
                <span>Start the conversation!</span>
              </div>
            }
          </div>
          
          <!-- Typing Indicator -->
          @if (typingUsers().length > 0) {
            <div class="typing-indicator">
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
              <span class="typing-text">
                @if (typingUsers().length === 1) {
                  {{ typingUsers()[0] }} is typing...
                } @else if (typingUsers().length === 2) {
                  {{ typingUsers()[0] }} and {{ typingUsers()[1] }} are typing...
                } @else {
                  {{ typingUsers().length }} people are typing...
                }
              </span>
            </div>
          }
          
          <div class="chat-input" (dragover)="onDragOver($event)" (drop)="onFileDrop($event)">
            <button class="attach-btn" (click)="triggerFileInput()" title="Attach file">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
              </svg>
            </button>
            <input 
              type="text"
              [value]="messageInput()"
              (input)="onMessageInput($event)"
              (keydown)="onMessageKeydown($event)"
              (blur)="onMessageBlur()"
              placeholder="Type a message or drop file..."
              autocomplete="off"
            />
            <button class="send-btn" (click)="sendMessage()" [disabled]="!messageInput().trim()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
              </svg>
            </button>
          </div>
      </div>
    </div>
  }
</div>
